<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>原子電子躍遷模擬實驗</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 自定義滾動條 */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }
        
        /* 螢光文字效果 */
        .neon-text { text-shadow: 0 0 5px currentColor; }
        
        /* 箭頭互動效果 */
        .transition-arrow {
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0.5; /* 預設稍微透明一點，避免太雜亂 */
        }
        .transition-arrow:hover {
            opacity: 1;
            stroke-width: 3;
            filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.8));
            z-index: 20;
        }
        .transition-arrow.active {
            opacity: 1;
            stroke-width: 4;
            filter: drop-shadow(0 0 10px currentColor);
            z-index: 20;
        }

        /* 光子發射動畫 */
        @keyframes flyRight {
            0% { transform: translate(0, 0) scale(0.5); opacity: 0; }
            10% { opacity: 1; transform: translate(20px, 0) scale(1); }
            100% { transform: translate(600px, 0) scale(1); opacity: 0; }
        }
        .photon-wave {
            pointer-events: none;
        }
        .animate-fly {
            animation: flyRight 1.5s linear forwards;
        }
        
        /* 提示框淡入 */
        .tooltip {
            pointer-events: none;
            transition: opacity 0.2s;
        }
    </style>
</head>
<body class="bg-black text-gray-200 font-sans h-screen flex flex-col overflow-hidden">

    <!-- 頂部標題 -->
    <header class="bg-gray-900 border-b border-gray-800 p-4 flex justify-between items-center shadow-lg z-20 shrink-0 h-16">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center font-bold text-white shadow-[0_0_15px_rgba(37,99,235,0.5)]">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
            </div>
            <h1 class="text-xl font-bold tracking-wider text-gray-100">原子光譜物理實驗室 <span class="text-xs font-normal text-gray-500 ml-2">Atomic Transitions Sim</span></h1>
        </div>
        <div class="text-xs text-gray-500 font-mono border border-gray-700 px-2 py-1 rounded">Physics Engine v2.1</div>
    </header>

    <!-- 主畫面：左右佈局 -->
    <main class="flex-1 flex overflow-hidden">
        
        <!-- 左側：控制面板 (固定寬度) -->
        <aside class="w-80 bg-gray-900 border-r border-gray-800 flex flex-col shadow-2xl z-10">
            <div class="p-6 flex flex-col gap-8 h-full overflow-y-auto">
                
                <!-- 1. 元素選擇 -->
                <section>
                    <h2 class="text-xs font-bold text-blue-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-blue-500"></span>
                        選擇原子模型
                    </h2>
                    <div class="grid grid-cols-1 gap-3">
                        <button onclick="loadElement('H')" id="btn-H" class="element-btn group relative overflow-hidden rounded-xl border border-gray-700 bg-gray-800 p-4 text-left transition hover:border-blue-500 hover:bg-gray-750">
                            <div class="relative z-10 flex justify-between items-center">
                                <span class="font-bold text-lg">氫 (Hydrogen)</span>
                                <span class="text-xs bg-gray-700 px-2 py-1 rounded text-gray-300">Z=1</span>
                            </div>
                            <div class="absolute inset-0 bg-gradient-to-r from-blue-900/20 to-transparent opacity-0 group-hover:opacity-100 transition"></div>
                        </button>
                        
                        <button onclick="loadElement('Na')" id="btn-Na" class="element-btn group relative overflow-hidden rounded-xl border border-gray-700 bg-gray-800 p-4 text-left transition hover:border-yellow-500 hover:bg-gray-750">
                            <div class="relative z-10 flex justify-between items-center">
                                <span class="font-bold text-lg">鈉 (Sodium)</span>
                                <span class="text-xs bg-gray-700 px-2 py-1 rounded text-gray-300">Z=11</span>
                            </div>
                            <div class="absolute inset-0 bg-gradient-to-r from-yellow-900/20 to-transparent opacity-0 group-hover:opacity-100 transition"></div>
                        </button>
                        
                        <button onclick="loadElement('Ne')" id="btn-Ne" class="element-btn group relative overflow-hidden rounded-xl border border-gray-700 bg-gray-800 p-4 text-left transition hover:border-red-500 hover:bg-gray-750">
                            <div class="relative z-10 flex justify-between items-center">
                                <span class="font-bold text-lg">氖 (Neon)</span>
                                <span class="text-xs bg-gray-700 px-2 py-1 rounded text-gray-300">Z=10</span>
                            </div>
                            <div class="absolute inset-0 bg-gradient-to-r from-red-900/20 to-transparent opacity-0 group-hover:opacity-100 transition"></div>
                        </button>
                    </div>
                </section>

                <hr class="border-gray-800">

                <!-- 2. 實驗數據顯示 -->
                <section class="flex-1">
                    <h2 class="text-xs font-bold text-green-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-green-500"></span>
                        躍遷測量結果
                    </h2>
                    
                    <div class="bg-gray-800 rounded-xl border border-gray-700 p-5 space-y-5 shadow-inner">
                        
                        <!-- 躍遷名稱 -->
                        <div>
                            <div class="text-[10px] text-gray-500 uppercase mb-1">躍遷名稱 (Transition)</div>
                            <div id="trans-name" class="text-sm font-mono text-white truncate border-b border-gray-700 pb-1">請點擊右側箭頭</div>
                        </div>

                        <!-- 能量差 -->
                        <div class="flex justify-between items-end">
                            <div class="text-[10px] text-gray-500 uppercase">能量差 (ΔE)</div>
                            <div class="text-right">
                                <div id="energy-val" class="text-2xl font-bold font-mono text-green-400">0.00</div>
                                <div class="text-[10px] text-gray-500">eV (電子伏特)</div>
                            </div>
                        </div>

                        <!-- 波長 -->
                        <div class="flex justify-between items-end">
                            <div class="text-[10px] text-gray-500 uppercase">波長 (Wavelength)</div>
                            <div class="text-right">
                                <div id="wave-val" class="text-2xl font-bold font-mono text-blue-400">---</div>
                                <div class="text-[10px] text-gray-500">nm (奈米)</div>
                            </div>
                        </div>

                        <!-- 光子能量 -->
                        <div class="flex justify-between items-end">
                            <div class="text-[10px] text-gray-500 uppercase">光子能量 (E=hf)</div>
                            <div class="text-right">
                                <div id="photon-val" class="text-lg font-mono text-purple-400">---</div>
                                <div class="text-[10px] text-gray-500">Joules</div>
                            </div>
                        </div>

                        <!-- 顏色展示區 -->
                        <div class="mt-4 pt-4 border-t border-gray-700">
                            <div class="text-[10px] text-gray-500 uppercase mb-2">電磁波顏色預覽</div>
                            <div class="flex items-stretch h-12 rounded-lg overflow-hidden border border-gray-600">
                                <div id="color-box" class="w-16 bg-gray-900 transition-colors duration-500 border-r border-gray-700"></div>
                                <div class="flex-1 bg-gray-900 flex items-center justify-center">
                                    <span id="spectrum-text" class="text-xs font-bold text-gray-500">等待數據</span>
                                </div>
                            </div>
                            <div class="text-[10px] text-gray-600 mt-1 text-right">* 紫外線與紅外線顯示為黑色</div>
                        </div>
                    </div>
                    
                    <!-- 公式提示 -->
                    <div class="mt-4 text-[10px] text-gray-600 text-center font-mono">
                        λ = hc / ΔE &nbsp;|&nbsp; E = hf
                    </div>
                </section>
            </div>
        </aside>

        <!-- 右側：能階圖 (自適應寬度) -->
        <section class="flex-1 bg-black relative overflow-hidden flex flex-col">
            <!-- 背景網格裝飾 -->
            <div class="absolute inset-0 opacity-10 pointer-events-none" 
                 style="background-image: linear-gradient(#333 1px, transparent 1px), linear-gradient(90deg, #333 1px, transparent 1px); background-size: 40px 40px;">
            </div>

            <!-- 標題 -->
            <div class="absolute top-6 left-8 z-10 pointer-events-none">
                <h2 class="text-3xl font-bold text-white opacity-80">能階圖 (Energy Level Diagram)</h2>
                <p class="text-gray-500 mt-1">已顯示所有可能的向下躍遷，請點擊箭頭查看詳情</p>
            </div>

            <!-- 能階 SVG 容器 -->
            <div id="diagram-container" class="flex-1 w-full h-full relative cursor-crosshair">
                <svg id="energy-svg" class="w-full h-full absolute inset-0 preserve-3d">
                    <!-- 內容由 JS 動態生成 -->
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                        refX="0" refY="3.5" orient="auto">
                          <polygon points="0 0, 10 3.5, 0 7" fill="currentColor" />
                        </marker>
                    </defs>
                </svg>
                
                <!-- 滑鼠懸停提示框 -->
                <div id="tooltip" class="tooltip absolute bg-gray-800 border border-gray-600 text-white text-xs rounded px-2 py-1 opacity-0 shadow-xl z-50 whitespace-nowrap"></div>
            </div>
            
            <!-- 底部光譜條裝飾 -->
            <div class="h-2 w-full bg-gradient-to-r from-purple-900 via-blue-800 to-red-900 opacity-30"></div>
        </section>

    </main>

<script>
/**
 * 物理引擎與數據
 */
const HC_CONST = 1240; // eV * nm
const E_CHARGE = 1.6e-19; // J/eV

// 原子數據庫 (僅保留基本定義，Transitions 改為動態生成或混合)
const ELEMENTS = {
    'H': {
        name: '氫 (Hydrogen)',
        bgClass: 'border-blue-500',
        levels: [-13.6, -3.4, -1.51, -0.85, -0.54], 
        levelLabels: ['n=1', 'n=2', 'n=3', 'n=4', 'n=5'],
        // 特殊命名的躍遷，其他會自動補齊
        specialTransitions: [
            {from: 1, to: 0, label: 'Lyman-α (UV)'}, 
            {from: 2, to: 0, label: 'Lyman-β (UV)'},
            {from: 2, to: 1, label: 'Balmer H-α (Red)'}, 
            {from: 3, to: 1, label: 'Balmer H-β (Cyan)'}, 
            {from: 4, to: 1, label: 'Balmer H-γ (Violet)'}, 
            {from: 3, to: 2, label: 'Paschen-α (IR)'}
        ]
    },
    'Na': {
        name: '鈉 (Sodium)',
        bgClass: 'border-yellow-500',
        levels: [-5.14, -3.04, -1.93, -1.51, -1.38, -0.8],
        levelLabels: ['3s', '3p', '4s', '3d', '4p', '5s'],
        specialTransitions: [
            {from: 1, to: 0, label: 'D-Line (Yellow Doublet)'}, 
            {from: 2, to: 1, label: 'IR Transition'}, 
            {from: 3, to: 1, label: 'Visible Orange'}
        ]
    },
    'Ne': {
        name: '氖 (Neon)',
        bgClass: 'border-red-500',
        // 簡化能階
        levels: [-21.56, -18.6, -16.7, -16.6], 
        levelLabels: ['Ground', '3s', '2p', '3p'],
        specialTransitions: [
            {from: 3, to: 2, label: 'He-Ne Laser (Red)'}, 
            {from: 2, to: 1, label: 'Green Line'},
            {from: 1, to: 0, label: 'Deep UV'}
        ]
    }
};

let currentElementKey = 'H';

/**
 * 初始化
 */
window.onload = () => {
    loadElement('H');
    window.addEventListener('resize', drawEnergyDiagram);
};

/**
 * 載入元素
 */
function loadElement(key) {
    currentElementKey = key;
    
    // 1. UI 狀態更新
    document.querySelectorAll('.element-btn').forEach(btn => {
        btn.classList.remove('border-blue-500', 'border-yellow-500', 'border-red-500', 'bg-gray-700');
        btn.classList.add('border-gray-700', 'bg-gray-800');
    });
    
    const activeBtn = document.getElementById(`btn-${key}`);
    const activeClass = ELEMENTS[key].bgClass;
    activeBtn.classList.remove('border-gray-700', 'bg-gray-800');
    activeBtn.classList.add(activeClass, 'bg-gray-750', 'shadow-lg');

    // 2. 重置數據
    resetData();

    // 3. 繪圖
    drawEnergyDiagram();
}

function resetData() {
    document.getElementById('trans-name').innerText = "請點擊右側箭頭";
    document.getElementById('energy-val').innerText = "0.00";
    document.getElementById('wave-val').innerText = "---";
    document.getElementById('photon-val').innerText = "---";
    
    const colorBox = document.getElementById('color-box');
    const specText = document.getElementById('spectrum-text');
    colorBox.style.backgroundColor = '#111827';
    colorBox.style.boxShadow = 'none';
    specText.innerText = "無訊號";
    specText.style.color = '#6b7280';
}

/**
 * 獲取所有可能的躍遷
 */
function getAllTransitions(key) {
    const el = ELEMENTS[key];
    const levels = el.levels;
    const special = el.specialTransitions || [];
    const all = [];

    // 遍歷所有組合：從高能階(i) 到 低能階(j)
    // 為了圖表美觀，我們按「終點能階(to)」分組，從最低能階開始
    for (let j = 0; j < levels.length - 1; j++) { // to (低)
        for (let i = j + 1; i < levels.length; i++) { // from (高)
            
            // 1. 檢查是否有特殊定義的名稱
            const custom = special.find(t => t.from === i && t.to === j);
            
            // 2. 計算物理量以決定顏色
            const dE = Math.abs(levels[i] - levels[j]);
            const lambda = 1240 / dE;
            
            // 3. 決定顯示屬性
            let displayLabel = custom ? custom.label : `${el.levelLabels[i]} → ${el.levelLabels[j]}`;
            let colorData = getWavelengthColorData(lambda);
            
            // 如果特殊定義有指定顏色(雖然現在數據結構沒指定，但保留彈性)，可在此覆蓋
            
            all.push({
                from: i,
                to: j,
                label: displayLabel,
                lambda: lambda,
                dE: dE,
                color: colorData.arrowColor,
                isSpecial: !!custom,
                type: colorData.type
            });
        }
    }
    return all;
}

/**
 * 繪製能階圖
 */
function drawEnergyDiagram() {
    const container = document.getElementById('diagram-container');
    const svg = document.getElementById('energy-svg');
    
    // 清除舊內容 (保留 defs)
    while (svg.lastChild && svg.lastChild.tagName !== 'defs') {
        svg.removeChild(svg.lastChild);
    }

    const width = container.clientWidth;
    const height = container.clientHeight;
    const data = ELEMENTS[currentElementKey];
    const levels = data.levels;
    
    // 計算縮放
    const minE = Math.min(...levels);
    const maxE = Math.max(...levels);
    const paddingY = 100; 
    const availableH = height - 2 * paddingY;
    
    const getY = (e) => {
        if (maxE === minE) return height / 2;
        const ratio = (e - minE) / (maxE - minE); 
        return height - paddingY - (ratio * availableH);
    };

    // 1. 繪製能階線
    levels.forEach((e, i) => {
        const y = getY(e);
        
        // 線
        const line = createSVG('line', {
            x1: 80, y1: y,
            x2: width - 50, y2: y,
            stroke: 'rgba(255,255,255,0.3)',
            'stroke-width': 2
        });
        svg.appendChild(line);

        // Label
        const textL = createSVG('text', {
            x: 70, y: y + 5,
            fill: '#9ca3af',
            'text-anchor': 'end',
            'font-family': 'monospace',
            'font-size': '14'
        });
        textL.textContent = data.levelLabels[i] || `n=${i+1}`;
        svg.appendChild(textL);

        // Energy Value
        const textR = createSVG('text', {
            x: width - 40, y: y + 5,
            fill: '#4ade80',
            'text-anchor': 'start',
            'font-family': 'monospace',
            'font-size': '12',
            opacity: 0.7
        });
        textR.textContent = `${e.toFixed(2)} eV`;
        svg.appendChild(textR);
    });

    // 2. 繪製躍遷箭頭
    const allTrans = getAllTransitions(currentElementKey);
    
    // 佈局計算：把寬度均分給所有箭頭
    // 我們需要一個稍微聰明一點的算法來防止過度擁擠，但在這個簡單模擬中，均分通常足夠
    const startX = 120;
    const endX = width - 100;
    const totalSpace = endX - startX;
    const spacing = totalSpace / (allTrans.length + 1);

    allTrans.forEach((t, i) => {
        const yTop = getY(levels[t.from]);
        const yBot = getY(levels[t.to]);
        const x = startX + (i + 1) * spacing;

        const displayColor = t.color;
        
        // Group wrapper
        const g = createSVG('g', { 
            class: 'transition-arrow group',
            'data-label': t.label
        });

        // Hover logic for Tooltip
        g.onmouseenter = (evt) => showTooltip(evt, t.label, t.lambda);
        g.onmouseleave = hideTooltip;

        // Click logic
        g.onclick = (e) => {
            // 清除其他 Active
            document.querySelectorAll('.transition-arrow').forEach(el => el.classList.remove('active'));
            g.classList.add('active');
            
            // 執行顯示
            displayResult(t, x, (yTop + yBot)/2);
        };

        // Arrow Line
        const arrowLine = createSVG('line', {
            x1: x, y1: yTop,
            x2: x, y2: yBot - 8,
            stroke: displayColor,
            'stroke-width': 2,
            'stroke-dasharray': (t.type === 'uv' || t.type === 'ir') ? '4,2' : 'none'
        });
        g.appendChild(arrowLine);

        // Arrow Head
        const arrowHead = createSVG('path', {
            d: `M ${x-5} ${yBot-8} L ${x+5} ${yBot-8} L ${x} ${yBot} Z`,
            fill: displayColor
        });
        g.appendChild(arrowHead);

        // Small Label on top if special
        /*
        if (t.isSpecial) {
            const circle = createSVG('circle', {
                cx: x, cy: yTop - 5, r: 2, fill: displayColor
            });
            g.appendChild(circle);
        }
        */

        svg.appendChild(g);
    });
}

function createSVG(tag, attrs) {
    const el = document.createElementNS('http://www.w3.org/2000/svg', tag);
    for (const k in attrs) {
        el.setAttribute(k, attrs[k]);
    }
    return el;
}

/**
 * 顯示結果
 */
function displayResult(data, xPos, yPos) {
    const joules = data.dE * E_CHARGE;
    
    // 1. 填充面板
    document.getElementById('trans-name').innerText = data.label;
    document.getElementById('energy-val').innerText = data.dE.toFixed(3);
    document.getElementById('wave-val').innerText = data.lambda.toFixed(1);
    document.getElementById('photon-val').innerText = joules.toExponential(2);

    // 2. 顏色框
    const colorBox = document.getElementById('color-box');
    const specText = document.getElementById('spectrum-text');
    
    let finalBoxColor = '#000000';
    let text = '';
    let textColor = '#fff';

    if (data.type === 'uv') {
        text = '紫外線 (UV)';
        textColor = '#a855f7'; // Purple text
    } else if (data.type === 'ir') {
        text = '紅外線 (IR)';
        textColor = '#ef4444'; // Red text
    } else {
        finalBoxColor = data.color; // 使用箭頭顏色(即真實光色)
        text = '可見光 (Visible)';
        textColor = finalBoxColor;
    }

    colorBox.style.backgroundColor = finalBoxColor;
    
    // 光暈效果
    if (finalBoxColor === '#000000') {
        colorBox.style.boxShadow = 'inset 0 0 5px rgba(255,255,255,0.1)';
    } else {
        colorBox.style.boxShadow = `0 0 20px ${finalBoxColor}`;
    }
    
    specText.innerText = text;
    specText.style.color = textColor;

    // 3. 動畫
    animatePhoton(xPos, yPos, (data.type === 'uv' || data.type === 'ir') ? data.color : finalBoxColor);
}

/**
 * 波長顏色計算工具
 * 返回: { arrowColor: hex, type: 'uv'|'ir'|'visible' }
 */
function getWavelengthColorData(wl) {
    if (wl < 380) return { arrowColor: '#d8b4fe', type: 'uv' }; // UV Arrow: Light Purple
    if (wl > 750) return { arrowColor: '#6b7280', type: 'ir' }; // IR Arrow: Gray
    
    // Visible Calculation
    let r, g, b;
    if (wl >= 380 && wl < 440) { r = -(wl - 440) / (60); g = 0; b = 1; }
    else if (wl >= 440 && wl < 490) { r = 0; g = (wl - 440) / (50); b = 1; }
    else if (wl >= 490 && wl < 510) { r = 0; g = 1; b = -(wl - 510) / (20); }
    else if (wl >= 510 && wl < 580) { r = (wl - 510) / (70); g = 1; b = 0; }
    else if (wl >= 580 && wl < 645) { r = 1; g = -(wl - 645) / (65); b = 0; }
    else if (wl >= 645 && wl <= 750) { r = 1; g = 0; b = 0; }
    
    const toHex = (v) => {
        const hex = Math.round(v * 255).toString(16);
        return hex.length === 1 ? '0' + hex : hex;
    };
    
    return { 
        arrowColor: `#${toHex(r)}${toHex(g)}${toHex(b)}`, 
        type: 'visible' 
    };
}

function animatePhoton(x, y, color) {
    const svg = document.getElementById('energy-svg');
    document.querySelectorAll('.photon-group').forEach(p => p.remove());

    const g = createSVG('g', {
        class: 'photon-group animate-fly',
        transform: `translate(${x}, ${y})`
    });
    
    const wave = createSVG('path', {
        d: "M0,0 Q5,-10 10,0 T20,0 T30,0 T40,0",
        stroke: color,
        fill: 'none',
        'stroke-width': 3,
        'stroke-linecap': 'round',
        filter: 'drop-shadow(0 0 5px currentColor)'
    });
    
    g.appendChild(wave);
    svg.appendChild(g);
}

// Tooltip Logic
function showTooltip(evt, text, lambda) {
    const tt = document.getElementById('tooltip');
    tt.innerHTML = `<span class="font-bold">${text}</span><br/>λ = ${lambda.toFixed(1)} nm`;
    tt.style.left = (evt.clientX + 15) + 'px';
    tt.style.top = (evt.clientY + 15) + 'px';
    tt.style.opacity = 1;
}
function hideTooltip() {
    const tt = document.getElementById('tooltip');
    tt.style.opacity = 0;
}
</script>
</body>
</html>