<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>理想氣體粒子模型 | Ideal Gas Particle Model</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- MathJax for rendering equations -->
    <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      }
    };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- OrbitControls -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <style>
        /* Custom slider styling */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #3b82f6; /* blue-500 */
            cursor: pointer;
            margin-top: -6px; 
            box-shadow: 0 0 0 2px white;
        }
        
        /* Disabled slider thumb */
        input[type=range]:disabled::-webkit-slider-thumb {
            background: #64748b; /* slate-500 */
            cursor: not-allowed;
            box-shadow: none;
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #475569; /* slate-600 */
            border-radius: 2px;
        }

        .canvas-container {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #0f172a; /* slate-900 */
            border-radius: 0.5rem;
        }

        /* Modal transition */
        .modal {
            transition: opacity 0.25s ease;
        }
        body {
            font-family: 'Noto Sans TC', sans-serif;
        }
        
        .mode-btn.active {
            background-color: #3b82f6; /* blue-500 */
            border-color: #60a5fa;
            color: white;
        }
    </style>
</head>
<body class="bg-slate-800 text-white h-screen flex flex-col overflow-hidden">

    <!-- Navbar -->
    <nav class="bg-slate-900 border-b border-slate-700 p-4 flex justify-between items-center shadow-lg z-10 shrink-0">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 p-2 rounded-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                </svg>
            </div>
            <h1 class="text-xl font-bold tracking-wide"><span id="app-title">氣體粒子模型</span> <span class="text-blue-400 font-mono">PV=nRT</span></h1>
        </div>
        <div class="flex items-center gap-4">
            <button onclick="toggleModal()" class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-1.5 rounded-md text-sm transition flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span id="btn-info">氣體定律</span>
            </button>
            <button onclick="toggleLanguage()" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded-md text-sm font-semibold transition shadow-md border border-blue-400">
                中 / EN
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col md:flex-row overflow-hidden">
        
        <!-- Sidebar (Controls) -->
        <aside class="w-full md:w-1/3 lg:w-1/4 bg-slate-800 border-r border-slate-700 p-6 flex flex-col gap-4 overflow-y-auto z-10 shadow-xl scrollbar-hide">
            
            <div class="bg-slate-700/50 p-4 rounded-xl border border-slate-600">
                <h2 class="text-lg font-semibold text-blue-300 mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
                    <span id="control-panel-title">變數控制</span>
                </h2>

                <!-- Mode Selection Buttons -->
                <div class="grid grid-cols-3 gap-2 mb-6">
                    <button onclick="setMode('boyle')" id="btn-boyle" class="mode-btn bg-slate-800 border border-slate-600 text-xs py-2 px-1 rounded hover:bg-slate-600 transition text-center flex flex-col items-center justify-center">
                        <span class="font-bold">等溫</span>
                        <span class="text-[10px] opacity-70">Boyle</span>
                    </button>
                    <button onclick="setMode('charles')" id="btn-charles" class="mode-btn bg-slate-800 border border-slate-600 text-xs py-2 px-1 rounded hover:bg-slate-600 transition text-center flex flex-col items-center justify-center">
                        <span class="font-bold">等壓</span>
                        <span class="text-[10px] opacity-70">Charles</span>
                    </button>
                    <button onclick="setMode('gay')" id="btn-gay" class="mode-btn bg-slate-800 border border-slate-600 text-xs py-2 px-1 rounded hover:bg-slate-600 transition text-center flex flex-col items-center justify-center">
                        <span class="font-bold">等積</span>
                        <span class="text-[10px] opacity-70">Gay-Lussac</span>
                    </button>
                </div>

                <!-- Sliders -->
                
                <!-- Volume (m^3) -->
                <div class="mb-5 group">
                    <div class="flex justify-between mb-2">
                        <label class="text-sm font-medium text-slate-300" id="label-V">體積 (V)</label>
                        <span class="text-sm font-mono text-emerald-400" id="val-V">0.022 m³</span>
                    </div>
                    <input type="range" id="slider-V" min="0.005" max="0.050" step="0.001" value="0.0224" class="w-full">
                    <div class="mt-1 text-xs text-slate-500 flex justify-between">
                        <span>0.005</span>
                        <span>0.050</span>
                    </div>
                </div>

                <!-- Moles -->
                <div class="mb-5 group">
                    <div class="flex justify-between mb-2">
                        <label class="text-sm font-medium text-slate-300" id="label-n">摩爾數 (n)</label>
                        <span class="text-sm font-mono text-purple-400" id="val-n">1.0 mol</span>
                    </div>
                    <input type="range" id="slider-n" min="0.1" max="5.0" step="0.1" value="1.0" class="w-full">
                    <div class="mt-1 text-xs text-slate-500 flex justify-between">
                        <span>0.1</span>
                        <span>5.0</span>
                    </div>
                </div>

                <!-- Temperature -->
                <div class="mb-5 group">
                    <div class="flex justify-between mb-2">
                        <label class="text-sm font-medium text-slate-300" id="label-T">溫度 (T)</label>
                        <span class="text-sm font-mono text-red-400" id="val-T">273 K</span>
                    </div>
                    <input type="range" id="slider-T" min="50" max="600" step="1" value="273" class="w-full">
                    <div class="mt-1 text-xs text-slate-500 flex justify-between">
                        <span>50K</span>
                        <span>600K</span>
                    </div>
                </div>

                <!-- Pressure (Pa) -->
                <div class="mb-2 group pt-4 border-t border-slate-600">
                    <div class="flex justify-between mb-2 items-center">
                        <label class="text-sm font-bold text-yellow-400" id="label-P">壓強 (P)</label>
                        <span class="text-base font-mono text-yellow-400 bg-yellow-400/10 px-2 py-1 rounded" id="val-P">101325 Pa</span>
                    </div>
                    <input type="range" id="slider-P" min="10000" max="1000000" step="1000" value="101325" class="w-full accent-yellow-500">
                    <div class="mt-1 text-xs text-slate-500 flex justify-between mb-2">
                        <span>10 kPa</span>
                        <span>1 MPa</span>
                    </div>
                </div>
            </div>

            <!-- Stats -->
            <div class="bg-black/30 p-3 rounded-xl border border-slate-700">
                <div class="grid grid-cols-2 gap-2 text-center">
                    <div>
                        <div class="text-[10px] text-slate-400 mb-1">RMS 速度</div>
                        <div class="text-sm font-mono text-white" id="display-velocity">-- m/s</div>
                    </div>
                    <div>
                        <div class="text-[10px] text-slate-400 mb-1">碰撞頻率</div>
                        <div class="text-sm font-mono text-white" id="display-collisions">High</div>
                    </div>
                </div>
            </div>

        </aside>

        <!-- Right Side (Visualization + Chart) -->
        <section class="flex-1 flex flex-col min-w-0 bg-slate-900 relative overflow-hidden">
            
            <!-- Top: 3D Visualization (Takes remaining space) -->
            <div class="flex-1 relative min-h-0 bg-black">
                <div id="canvas-container" class="absolute inset-0 w-full h-full"></div>
                
                <!-- Overlay Info -->
                <div class="absolute bottom-4 right-4 text-right pointer-events-none select-none z-10">
                    <div class="text-slate-500 text-sm">Particle View</div>
                    <div class="text-slate-700 text-xs">Three.js Render</div>
                </div>
            </div>

            <!-- Bottom: Dynamic Chart (Fixed percentage height for visibility) -->
            <div class="h-[40%] bg-slate-800 border-t border-slate-700 p-4 flex flex-col shadow-[0_-4px_10px_rgba(0,0,0,0.3)] z-20">
                 <div class="text-sm text-center text-slate-400 mb-2 font-bold tracking-wide flex justify-between items-center px-4" >
                    <span class="opacity-0 w-12">.</span> <!-- Spacer -->
                    <span id="chart-title">選擇模式以顯示圖表</span>
                    <span class="text-[10px] font-normal bg-slate-700 px-2 py-0.5 rounded text-slate-300 w-12 text-center">Live</span>
                 </div>
                 <div class="flex-1 relative w-full min-h-0 bg-slate-900/50 rounded-lg border border-slate-700 p-2">
                    <canvas id="liveChart"></canvas>
                 </div>
            </div>

        </section>

    </main>

    <!-- Modal for Physics Info -->
    <div id="info-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden opacity-0 flex items-center justify-center p-4">
        <div class="bg-slate-800 border border-slate-600 rounded-2xl max-w-2xl w-full shadow-2xl transform transition-all scale-95" id="modal-content">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6 border-b border-slate-700 pb-4">
                    <h2 class="text-2xl font-bold text-blue-400" id="modal-title">理想氣體定律</h2>
                    <button onclick="toggleModal()" class="text-slate-400 hover:text-white transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                
                <div class="space-y-6 text-slate-200 overflow-y-auto max-h-[60vh] pr-2 scrollbar-thin scrollbar-thumb-slate-600">
                    
                    <div class="bg-slate-900/50 p-4 rounded-lg text-center">
                        <p class="text-xl font-mono mb-2 text-yellow-300">$$ PV = nRT $$</p>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
                        <div class="bg-slate-700/30 p-3 rounded border border-slate-600">
                            <strong class="text-yellow-400">P (Pressure)</strong>
                            <p id="desc-P">壓強：氣體分子撞擊容器壁所產生的力。</p>
                            <p class="text-xs text-slate-400 mt-1">Unit: Pascal (Pa)</p>
                        </div>
                        <div class="bg-slate-700/30 p-3 rounded border border-slate-600">
                            <strong class="text-emerald-400">V (Volume)</strong>
                            <p id="desc-V">體積：氣體分子所佔據的空間。</p>
                            <p class="text-xs text-slate-400 mt-1">Unit: Cubic Meter (m³)</p>
                        </div>
                        <div class="bg-slate-700/30 p-3 rounded border border-slate-600">
                            <strong class="text-purple-400">n (Moles)</strong>
                            <p id="desc-n">摩爾數：物質的量。</p>
                            <p class="text-xs text-slate-400 mt-1">Unit: mol</p>
                        </div>
                        <div class="bg-slate-700/30 p-3 rounded border border-slate-600">
                            <strong class="text-red-400">T (Temperature)</strong>
                            <p id="desc-T">絕對溫度：與分子平均動能成正比。</p>
                            <p class="text-xs text-slate-400 mt-1">Unit: Kelvin (K)</p>
                        </div>
                    </div>

                    <!-- New Gas Law Relationships Section -->
                    <div class="mt-4 border-t border-slate-700 pt-4">
                        <h3 class="font-bold text-blue-300 mb-3" id="subtitle-laws">個別定律關係</h3>
                        <div class="grid grid-cols-1 gap-3">
                            <div class="bg-slate-700/30 p-2 rounded flex justify-between items-center px-4">
                                <span class="text-sm font-semibold text-slate-200" id="title-boyle">波義耳定律 (恆溫)</span>
                                <span class="text-sm font-mono text-yellow-300">$$ P_1V_1 = P_2V_2 $$</span>
                            </div>
                            <div class="bg-slate-700/30 p-2 rounded flex justify-between items-center px-4">
                                <span class="text-sm font-semibold text-slate-200" id="title-charles">查理定律 (恆壓)</span>
                                <span class="text-sm font-mono text-yellow-300">$$ \frac{V_1}{T_1} = \frac{V_2}{T_2} $$</span>
                            </div>
                            <div class="bg-slate-700/30 p-2 rounded flex justify-between items-center px-4">
                                <span class="text-sm font-semibold text-slate-200" id="title-gay">蓋-呂薩克定律 (恆容)</span>
                                <span class="text-sm font-mono text-yellow-300">$$ \frac{P_1}{T_1} = \frac{P_2}{T_2} $$</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-6 text-right">
                    <button onclick="toggleModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition" id="btn-close">關閉</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Application Logic -->
    <script>
        // --- 1. State Management ---
        const R_SI = 8.314; 
        
        const state = {
            lang: 'zh',
            V: 0.0224, // m^3
            n: 1.0,  
            T: 273,  
            P: 101325, 
            mode: 'boyle', // Default mode 'boyle' (const T)
            isUpdating: false
        };

        // --- 2. Chart.js Setup ---
        Chart.defaults.color = '#94a3b8';
        Chart.defaults.borderColor = '#334155';
        Chart.defaults.font.family = "'Noto Sans TC', sans-serif";

        let myChart = null;

        function initChart() {
            const ctx = document.getElementById('liveChart').getContext('2d');
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'Theoretical',
                            data: [],
                            borderColor: '#3b82f6', // blue-500
                            borderWidth: 2,
                            pointRadius: 0,
                            tension: 0.4,
                            fill: false
                        },
                        {
                            label: 'Current',
                            data: [],
                            backgroundColor: '#ef4444', // red-500
                            borderColor: '#fff',
                            borderWidth: 1,
                            pointRadius: 6,
                            type: 'scatter'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    },
                    scales: {
                        x: { type: 'linear', ticks: { font: { size: 10 } }, title: { display: true, font: {size: 10} } },
                        y: { type: 'linear', ticks: { font: { size: 10 } }, title: { display: true, font: {size: 10} } }
                    },
                    animation: false
                }
            });
        }

        // --- 3. UI Logic ---
        
        const domV = document.getElementById('slider-V');
        const domN = document.getElementById('slider-n');
        const domT = document.getElementById('slider-T');
        const domP = document.getElementById('slider-P');
        
        const valV = document.getElementById('val-V');
        const valN = document.getElementById('val-n');
        const valT = document.getElementById('val-T');
        const valP = document.getElementById('val-P');

        function setMode(mode) {
            state.mode = mode;
            
            // Update UI buttons
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            const btn = document.getElementById(`btn-${mode}`);
            if (btn) btn.classList.add('active');

            // Reset Disabled states
            domV.disabled = false;
            domT.disabled = false;
            domP.disabled = false;
            domN.disabled = false;

            // Apply Locks
            if (mode === 'boyle') { // Lock T
                domT.disabled = true;
                domP.disabled = false; // Allow changing P to see effect on V
            } else if (mode === 'charles') { // Lock P
                domP.disabled = true;
            } else if (mode === 'gay') { // Lock V
                domV.disabled = true;
            }

            // Refresh visuals
            updateChart();
            updateLanguageText(); // Update chart title
        }

        function updateEquation(source) {
            if (state.isUpdating) return;
            state.isUpdating = true;

            let V = parseFloat(domV.value);
            let n = parseFloat(domN.value);
            let T = parseFloat(domT.value);
            let P = parseFloat(domP.value);

            // Logic based on Mode
            if (state.mode === 'boyle') { 
                // Const T. 
                // If P changed -> V = nRT/P
                // If V or n changed -> P = nRT/V
                if (source === 'P') {
                    V = (n * R_SI * T) / P;
                } else {
                    P = (n * R_SI * T) / V;
                }
            } 
            else if (state.mode === 'charles') {
                // Const P.
                // If T changed -> V = nRT/P
                // If V or n changed -> T = PV/nR
                if (source === 'V' || source === 'n') {
                    T = (P * V) / (n * R_SI);
                } else { // source == T
                    V = (n * R_SI * T) / P;
                }
            } 
            else if (state.mode === 'gay') {
                // Const V.
                // If T changed -> P = nRT/V
                // If P or n changed -> T = PV/nR
                if (source === 'P' || source === 'n') {
                    T = (P * V) / (n * R_SI);
                } else { // source == T
                    P = (n * R_SI * T) / V;
                }
            }

            // Bounds Checking & Clamping
            if (V < 0.005) V = 0.005; if (V > 0.050) V = 0.050;
            if (T < 50) T = 50; if (T > 600) T = 600;
            if (P < 10000) P = 10000; if (P > 1000000) P = 1000000;

            // Update State
            state.V = V;
            state.n = n;
            state.T = T;
            state.P = P;

            // Update DOM
            domV.value = V;
            domN.value = n;
            domT.value = T;
            domP.value = P;

            valV.innerText = `${state.V.toFixed(4)} m³`;
            valN.innerText = `${state.n.toFixed(1)} mol`;
            valT.innerText = `${state.T.toFixed(0)} K`;
            valP.innerText = `${state.P.toFixed(0)} Pa`;

            state.isUpdating = false;
            updateChart();
        }

        function updateChart() {
            if (!myChart) return;

            const { P, V, n, T, mode } = state;

            // --- CRITICAL FIX: Reset scales so Chart.js doesn't persist min/max from previous mode ---
            // If we don't do this, switching from a small scale (V~0.05) to large scale (P~100000) causes issues.
            delete myChart.options.scales.x.min;
            delete myChart.options.scales.x.max;
            delete myChart.options.scales.y.min;
            delete myChart.options.scales.y.max;
            
            let dataPoints = [];
            let currentPoint = {};
            let xLabel = '', yLabel = '';
            let title = '';

            if (mode === 'boyle') { // P vs V (Iso-T)
                xLabel = 'V (m³)';
                yLabel = 'P (Pa)';
                title = 'P-V 關係 (等溫)';
                currentPoint = { x: V, y: P };
                
                // Generate Curve P = k/V
                const k = n * R_SI * T;
                for(let v_i = 0.005; v_i <= 0.050; v_i += 0.001) {
                    dataPoints.push({ x: v_i, y: k / v_i });
                }
                
                // Adjust scales
                myChart.options.scales.x.min = 0;
                myChart.options.scales.x.max = 0.050;
                myChart.options.scales.y.min = 0;
                // Let Y auto-scale or fix it? Auto is better for wide range P

            } else if (mode === 'charles') { // V vs T (Iso-P)
                xLabel = 'T (K)';
                yLabel = 'V (m³)';
                title = 'V-T 關係 (等壓)';
                currentPoint = { x: T, y: V };

                // Generate Line V = k*T
                const k = (n * R_SI) / P;
                // 2 points enough for line
                dataPoints.push({ x: 0, y: 0 });
                dataPoints.push({ x: 600, y: k * 600 });

                myChart.options.scales.x.min = 0;
                // No X max limit (auto scale)
                myChart.options.scales.y.min = 0;
                myChart.options.scales.y.max = 0.06;

            } else if (mode === 'gay') { // P vs T (Iso-V)
                xLabel = 'T (K)';
                yLabel = 'P (Pa)';
                title = 'P-T 關係 (等積)';
                currentPoint = { x: T, y: P };

                // Generate Line P = k*T
                const k = (n * R_SI) / V;
                dataPoints.push({ x: 0, y: 0 });
                dataPoints.push({ x: 600, y: k * 600 });

                myChart.options.scales.x.min = 0;
                // No X max limit (auto scale)
                // Let Y auto scale
            }

            myChart.data.datasets[0].data = dataPoints;
            myChart.data.datasets[1].data = [currentPoint];
            
            myChart.options.scales.x.title.text = xLabel;
            myChart.options.scales.y.title.text = yLabel;
            
            // Handle Chart Title via Dict
            const t = dict[state.lang];
            const typeText = mode === 'boyle' ? t.chartBoyle : (mode === 'charles' ? t.chartCharles : t.chartGay);
            const chartTitle = document.getElementById('chart-title');
            if (chartTitle) chartTitle.innerText = typeText;

            myChart.update();
        }

        // --- 4. Language & Dictionaries ---
        
        const dict = {
            zh: {
                title: '氣體粒子模型',
                btnInfo: '氣體定律',
                controlTitle: '變數控制',
                labelV: '體積 (V)',
                labelN: '摩爾數 (n)',
                labelT: '溫度 (T)',
                labelP: '壓強 (P)',
                modalTitle: '理想氣體定律',
                descP: '壓強：氣體分子撞擊容器壁所產生的力。',
                descV: '體積：氣體分子所佔據的空間。',
                descN: '摩爾數：物質的量。',
                descT: '絕對溫度：與分子平均動能成正比。',
                subtitleConstant: '氣體常數 R',
                btnClose: '關閉',
                colFreq: '碰撞頻率',
                subtitleLaws: '個別定律關係',
                titleBoyle: '波義耳定律 (恆溫)',
                titleCharles: '查理定律 (恆壓)',
                titleGay: '蓋-呂薩克定律 (恆容)',
                modeBoyle: '等溫',
                modeCharles: '等壓',
                modeGay: '等積',
                chartBoyle: 'P-V 關係圖 (等溫)',
                chartCharles: 'V-T 關係圖 (等壓)',
                chartGay: 'P-T 關係圖 (等積)'
            },
            en: {
                title: 'Gas Particle Model',
                btnInfo: 'Gas Law',
                controlTitle: 'Controls',
                labelV: 'Volume (V)',
                labelN: 'Moles (n)',
                labelT: 'Temperature (T)',
                labelP: 'Pressure (P)',
                modalTitle: 'Ideal Gas Law',
                descP: 'Pressure: Force from gas collisions.',
                descV: 'Volume: Space occupied by the gas.',
                descN: 'Moles: Amount of substance.',
                descT: 'Temperature: Proportional to avg kinetic energy.',
                subtitleConstant: 'Gas Constant R',
                btnClose: 'Close',
                colFreq: 'Collisions',
                subtitleLaws: 'Individual Gas Laws',
                titleBoyle: "Boyle's Law (Const T)",
                titleCharles: "Charles's Law (Const P)",
                titleGay: "Gay-Lussac's Law (Const V)",
                modeBoyle: 'Iso-T',
                modeCharles: 'Iso-P',
                modeGay: 'Iso-V',
                chartBoyle: 'P-V Graph (Isothermal)',
                chartCharles: 'V-T Graph (Isobaric)',
                chartGay: 'P-T Graph (Isochoric)'
            }
        };

        function setText(id, text) {
            const el = document.getElementById(id);
            if (el) el.innerText = text;
        }

        function updateLanguageText() {
            const t = dict[state.lang];
            setText('app-title', t.title);
            setText('btn-info', t.btnInfo);
            setText('control-panel-title', t.controlTitle);
            setText('label-V', t.labelV);
            setText('label-n', t.labelN);
            setText('label-T', t.labelT);
            setText('label-P', t.labelP);
            
            const btnBoyle = document.querySelector('#btn-boyle .font-bold');
            if (btnBoyle) btnBoyle.innerText = t.modeBoyle;
            
            const btnCharles = document.querySelector('#btn-charles .font-bold');
            if (btnCharles) btnCharles.innerText = t.modeCharles;
            
            const btnGay = document.querySelector('#btn-gay .font-bold');
            if (btnGay) btnGay.innerText = t.modeGay;

            // Modal
            setText('modal-title', t.modalTitle);
            setText('desc-P', t.descP);
            setText('desc-V', t.descV);
            setText('desc-n', t.descN);
            setText('desc-T', t.descT);
            setText('subtitle-constant', t.subtitleConstant);
            setText('btn-close', t.btnClose);
            setText('subtitle-laws', t.subtitleLaws);
            setText('title-boyle', t.titleBoyle);
            setText('title-charles', t.titleCharles);
            setText('title-gay', t.titleGay);
            
            updateChart();
        }

        window.toggleLanguage = function() {
            state.lang = state.lang === 'zh' ? 'en' : 'zh';
            updateLanguageText();
        }
        
        window.toggleModal = function() {
            const modal = document.getElementById('info-modal');
            const modalContent = document.getElementById('modal-content');
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.classList.remove('opacity-0');
                    modalContent.classList.remove('scale-95');
                }, 10);
            } else {
                modal.classList.add('opacity-0');
                modalContent.classList.add('scale-95');
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 250);
            }
        }

        // --- 5. Event Listeners ---
        domV.addEventListener('input', () => updateEquation('V'));
        domN.addEventListener('input', () => updateEquation('n'));
        domT.addEventListener('input', () => updateEquation('T'));
        domP.addEventListener('input', () => updateEquation('P'));

        // --- 6. Three.js & Animation ---
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x000000, 0.02);

        const camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 100);
        camera.position.set(0, 0, 25);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        container.appendChild(renderer.domElement);

        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);
        const pointLight = new THREE.PointLight(0x3b82f6, 1, 50);
        pointLight.position.set(5, 5, 5);
        scene.add(pointLight);

        // Box
        const boxGeometry = new THREE.BoxGeometry(1, 1, 1);
        const edges = new THREE.EdgesGeometry(boxGeometry);
        const boxMaterial = new THREE.LineBasicMaterial({ color: 0x94a3b8, transparent: true, opacity: 0.5 });
        const boxLines = new THREE.LineSegments(edges, boxMaterial);
        scene.add(boxLines);

        // Particles
        const MAX_PARTICLES = 500; 
        const particleGeo = new THREE.SphereGeometry(0.06, 8, 8);
        const particleMat = new THREE.MeshPhongMaterial({ color: 0x60a5fa, shininess: 100 });
        const particlesMesh = new THREE.InstancedMesh(particleGeo, particleMat, MAX_PARTICLES);
        scene.add(particlesMesh);

        const dummy = new THREE.Object3D();
        const particleData = [];
        for (let i = 0; i < MAX_PARTICLES; i++) {
            particleData.push({
                x: (Math.random() - 0.5) * 10,
                y: (Math.random() - 0.5) * 10,
                z: (Math.random() - 0.5) * 10,
                vx: (Math.random() - 0.5),
                vy: (Math.random() - 0.5),
                vz: (Math.random() - 0.5)
            });
        }

        function updatePhysics() {
            const scaleSize = Math.cbrt(state.V) * 25.0; 
            boxLines.scale.set(scaleSize, scaleSize, scaleSize);
            const speedFactor = Math.sqrt(state.T) * 0.02;
            const activeCount = Math.min(Math.floor(state.n * 50), MAX_PARTICLES);
            particlesMesh.count = activeCount;
            const halfSize = scaleSize / 2;

            for (let i = 0; i < activeCount; i++) {
                const p = particleData[i];
                p.x += p.vx * speedFactor;
                p.y += p.vy * speedFactor;
                p.z += p.vz * speedFactor;

                if (p.x > halfSize) { p.x = halfSize; p.vx *= -1; }
                if (p.x < -halfSize) { p.x = -halfSize; p.vx *= -1; }
                if (p.y > halfSize) { p.y = halfSize; p.vy *= -1; }
                if (p.y < -halfSize) { p.y = -halfSize; p.vy *= -1; }
                if (p.z > halfSize) { p.z = halfSize; p.vz *= -1; }
                if (p.z < -halfSize) { p.z = -halfSize; p.vz *= -1; }

                dummy.position.set(p.x, p.y, p.z);
                dummy.updateMatrix();
                particlesMesh.setMatrixAt(i, dummy.matrix);
            }
            particlesMesh.instanceMatrix.needsUpdate = true;

            const realVrms = Math.round(Math.sqrt(3 * 8.314 * state.T / 0.028)); 
            document.getElementById('display-velocity').innerText = `${realVrms} m/s`;
            
            const collisionMetric = (state.n / (state.V * 1000)) * Math.sqrt(state.T);
            let colText = "Low";
            if (collisionMetric > 0.1) colText = "Medium";
            if (collisionMetric > 0.3) colText = "High";
            if (collisionMetric > 0.5) colText = "Extreme";
            document.getElementById('display-collisions').innerText = state.lang === 'zh' ? 
                (colText === 'Low' ? '低' : (colText === 'Medium' ? '中' : '高')) : colText;
        }

        function animate() {
            requestAnimationFrame(animate);
            updatePhysics();
            controls.update();
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            const width = container.clientWidth;
            const height = container.clientHeight;
            renderer.setSize(width, height);
            camera.aspect = width / height;
            camera.updateProjectionMatrix();
        });

        // Initialize
        initChart();
        setMode('boyle'); // This triggers updateEquation
        animate();

    </script>
</body>
</html>