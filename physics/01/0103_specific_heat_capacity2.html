<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>比熱容量模擬實驗 (Specific Heat Capacity Lab)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* 自定義滑桿樣式 */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: currentColor;
            cursor: pointer;
            margin-top: -6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 6px;
            cursor: pointer;
            background: #e2e8f0;
            border-radius: 4px;
        }
        /* 針對不同顏色的滑桿 */
        .slider-blue::-webkit-slider-thumb { color: #2563eb; }
        .slider-orange::-webkit-slider-thumb { color: #ea580c; }
        .slider-green::-webkit-slider-thumb { color: #16a34a; }
        .slider-purple::-webkit-slider-thumb { color: #9333ea; }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-800 p-4 md:p-8 min-h-screen">

    <!-- Header -->
    <header class="mb-8 flex flex-col md:flex-row justify-between items-center border-b border-slate-200 pb-4 max-w-7xl mx-auto">
        <div>
            <h1 class="text-3xl font-bold text-blue-900 flex items-center gap-2">
                <!-- Icon: Flame -->
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-orange-500"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/></svg>
                比熱容量模擬實驗
            </h1>
            <p class="text-slate-500 mt-1">物理實驗室：探究 E = mcΔT</p>
        </div>
        <div class="mt-4 md:mt-0 flex gap-4 items-center">
            <div class="bg-white px-4 py-2 rounded-lg shadow-sm border border-slate-200">
                <span class="text-sm text-slate-500 font-mono">設定功率 (P): </span>
                <span id="header-power-display" class="text-xl font-bold text-orange-600">100 W</span>
            </div>
        </div>
    </header>

    <!-- Main Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 max-w-7xl mx-auto">
        
        <!-- Left Column: Controls (4 cols) -->
        <div class="lg:col-span-4 space-y-6">
            
            <!-- Control Panel -->
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <h2 class="text-xl font-semibold mb-4 flex items-center gap-2 text-slate-700">
                    <!-- Icon: Settings -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.51a2 2 0 0 1 1-1.72l.15-.1a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                    實驗參數設定
                </h2>

                <!-- Metal Selection -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-slate-600 mb-2">金屬種類</label>
                    <select id="metal-select" class="w-full p-3 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition">
                        <option value="aluminum">鋁 (Aluminum) (c = 900 J/kg°C)</option>
                        <option value="copper">銅 (Copper) (c = 385 J/kg°C)</option>
                        <option value="iron">鐵 (Iron) (c = 450 J/kg°C)</option>
                        <option value="gold">金 (Gold) (c = 129 J/kg°C)</option>
                        <option value="lead">鉛 (Lead) (c = 128 J/kg°C)</option>
                    </select>
                </div>

                <!-- Mass Slider -->
                <div class="mb-6">
                    <div class="flex justify-between mb-2">
                        <label class="text-sm font-medium text-slate-600">質量 (m)</label>
                        <span id="mass-display" class="font-bold text-blue-600">1.0 kg</span>
                    </div>
                    <input type="range" id="mass-slider" min="0.1" max="5" step="0.1" value="1.0" class="w-full slider-blue">
                </div>

                <!-- Power Slider -->
                <div class="mb-6">
                    <div class="flex justify-between mb-2">
                        <label class="text-sm font-medium text-slate-600">加熱器功率 (P)</label>
                        <span id="power-display" class="font-bold text-orange-600">100 W</span>
                    </div>
                    <input type="range" id="power-slider" min="0" max="400" step="10" value="100" class="w-full slider-orange">
                </div>

                <!-- Speed Slider -->
                <div class="mb-6">
                    <div class="flex justify-between mb-2">
                        <label class="text-sm font-medium text-slate-600 flex items-center gap-1">
                            <!-- Icon: FastForward -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 19 22 12 13 5 13 19"/><polygon points="2 19 11 12 2 5 2 19"/></svg>
                            模擬速度
                        </label>
                        <span id="speed-display" class="font-bold text-purple-600">1x</span>
                    </div>
                    <input type="range" id="speed-slider" min="1" max="5" step="1" value="1" class="w-full slider-purple">
                </div>

                <!-- Room Temp Slider -->
                <div class="mb-6">
                    <div class="flex justify-between mb-2">
                        <label class="text-sm font-medium text-slate-600">室溫 (Initial T)</label>
                        <span id="room-temp-display" class="font-bold text-green-600">25 °C</span>
                    </div>
                    <input type="range" id="room-temp-slider" min="0" max="40" step="1" value="25" class="w-full slider-green">
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-4 mt-8">
                    <button id="btn-toggle-heater" class="flex-1 py-3 rounded-xl font-semibold text-white flex justify-center items-center gap-2 transition shadow-md bg-green-600 hover:bg-green-700">
                        <!-- Icon: Power -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18.36 6.64a9 9 0 1 1-12.73 0"/><line x1="12" y1="2" x2="12" y2="12"/></svg>
                        <span id="btn-toggle-text">啟動電熱器</span>
                    </button>
                    <button id="btn-reset" class="px-6 py-3 rounded-xl font-semibold text-slate-600 bg-slate-100 hover:bg-slate-200 border border-slate-300 flex justify-center items-center gap-2 transition">
                        <!-- Updated Icon: Refresh Loop -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 21h5v-5"/></svg>
                        重置
                    </button>
                </div>
                
                <p id="residual-heat-msg" class="hidden text-xs text-center mt-2 text-orange-500 font-semibold animate-pulse">
                    ⚠️ 電熱器已關閉，餘熱升溫中...
                </p>
                <p id="simulation-end-msg" class="hidden text-xs text-center mt-2 text-green-600 font-bold">
                    ✅ 溫度已穩定並維持 10 秒，實驗結束。
                </p>
            </div>

            <!-- AI Assistant Panel -->
            <div class="bg-gradient-to-br from-indigo-50 to-purple-50 p-6 rounded-2xl shadow-sm border border-indigo-100">
                <h3 class="text-lg font-bold text-indigo-900 mb-4 flex items-center gap-2">
                    <!-- Icon: Sparkles -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-500"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></svg>
                    AI 實驗助手 (Gemini)
                </h3>
                
                <div class="flex gap-2 mb-4">
                    <button id="btn-ai-analyze" class="flex-1 py-2 px-3 bg-white text-indigo-600 text-sm font-semibold rounded-lg border border-indigo-200 hover:bg-indigo-50 disabled:opacity-50 disabled:cursor-not-allowed shadow-sm transition flex justify-center items-center gap-1">
                        <!-- Icon: Activity -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                        分析數據
                    </button>
                    <button id="btn-ai-quiz" class="flex-1 py-2 px-3 bg-indigo-600 text-white text-sm font-semibold rounded-lg hover:bg-indigo-700 disabled:opacity-50 shadow-sm transition flex justify-center items-center gap-1">
                        <!-- Icon: BrainCircuit -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .556 6.588A4 4 0 1 0 12 18Z"/><path d="M12 5a3 3 0 1 1 5.997.125 4 4 0 0 1 2.526 5.77 4 4 0 0 1-.556 6.588A4 4 0 1 1 12 18Z"/><path d="M15 13a4.5 4.5 0 0 1-3-4 4.5 4.5 0 0 1-3 4"/><path d="M17.599 6.5a3 3 0 0 0 .399-1.375"/><path d="M6.003 5.125A3 3 0 0 0 6.401 6.5"/><path d="M3.477 10.896a4 4 0 0 1 .585-.396"/><path d="M19.938 10.5a4 4 0 0 1 .585.396"/><path d="M6 18a4 4 0 0 1-1.97-1.375"/><path d="M18 18a4 4 0 0 0 1.97-1.375"/></svg>
                        隨堂測驗
                    </button>
                </div>

                <!-- AI Output Area -->
                <div id="ai-output-container" class="bg-white/80 rounded-xl p-4 min-h-[120px] border border-indigo-100 text-sm text-slate-700 flex flex-col justify-center">
                    <div id="ai-placeholder" class="text-center text-slate-400 py-4">
                        點擊上方按鈕，讓 AI 協助你分析實驗結果或進行測驗。
                    </div>
                    
                    <!-- Loader -->
                    <div id="ai-loader" class="hidden h-full flex flex-col items-center justify-center text-indigo-400 gap-2 py-4">
                        <svg class="animate-spin" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
                        <span>AI 正在思考中...</span>
                    </div>

                    <!-- Content -->
                    <div id="ai-content" class="hidden prose prose-sm prose-indigo max-w-none whitespace-pre-line leading-relaxed"></div>

                    <!-- Quiz UI -->
                    <div id="quiz-container" class="hidden animate-fade-in">
                        <p id="quiz-question" class="font-bold text-indigo-900 mb-3"></p>
                        <div id="quiz-options" class="space-y-2"></div>
                        <div id="quiz-explanation" class="hidden mt-3 p-2 bg-indigo-50 rounded-lg text-xs text-indigo-800 border border-indigo-100"></div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Center & Right: Visualization & Chart (8 cols) -->
        <div class="lg:col-span-8 flex flex-col gap-6">
            
            <!-- Visualization Area -->
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 relative overflow-hidden min-h-[300px] flex items-center justify-center bg-gradient-to-b from-gray-50 to-gray-100">
                
                <!-- Thermometer Display -->
                <div class="absolute top-4 right-4 bg-white p-3 rounded-xl shadow border border-slate-200 flex flex-col items-center z-10">
                    <div class="flex items-center gap-2 mb-1">
                        <!-- Icon: Thermometer -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-500"><path d="M14 14.76V3.5a2.5 2.5 0 0 0-5 0v11.26a4.5 4.5 0 1 0 5 0z"/></svg>
                        <span class="text-xs font-bold text-slate-400">溫度計</span>
                    </div>
                    <div class="text-3xl font-mono font-bold text-slate-800">
                        <span id="viz-temp">25.0</span> <span class="text-lg text-slate-500">°C</span>
                    </div>
                </div>

                <!-- Time Display (Experiment Time) -->
                <div class="absolute top-4 left-4 bg-white p-3 rounded-xl shadow border border-slate-200 flex flex-col items-center z-10">
                    <div class="flex items-center gap-2 mb-1">
                        <!-- Icon: Activity -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-500"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                        <span class="text-xs font-bold text-slate-400">實驗時間</span>
                    </div>
                    <div class="text-3xl font-mono font-bold text-slate-800">
                        <span id="viz-time">0.0</span> <span class="text-lg text-slate-500">s</span>
                    </div>
                    <div class="mt-1 text-xs text-orange-600 font-medium">
                        加熱時間: <span id="viz-heating-time">0.0</span> s
                    </div>
                </div>

                <!-- Heater Simulation -->
                <div class="relative flex flex-col items-center mt-10">
                    <!-- Immersion Heater Rods -->
                    <div class="flex gap-4 mb-[-10px] z-10 relative">
                        <!-- Heater Rod with Glow Effect -->
                        <div id="heater-rod" class="w-4 h-24 rounded-full transition-all duration-500 border-2 border-gray-400 bg-gray-200"></div>
                        <div class="w-2 h-24 bg-gray-300 rounded-full border border-gray-400 flex items-end justify-center pb-2">
                            <div class="w-1 h-2 bg-red-600 rounded-full"></div>
                        </div>
                    </div>

                    <!-- Metal Block -->
                    <div id="metal-block" class="relative flex items-center justify-center rounded-lg shadow-2xl border-b-8 border-r-8 border-black/10 transition-all duration-500"
                        style="background-color: #A0A0A0; width: 150px; height: 140px;">
                        
                        <span id="metal-name-display" class="text-white/90 font-bold text-xl drop-shadow-md z-20">鋁 (Aluminum)</span>
                        
                        <!-- Updated Position for Mass Display: Bottom Right inside block -->
                        <span id="metal-mass-display" class="absolute bottom-1 right-2 text-white/70 font-mono text-xs z-20">1 kg</span>
                        
                        <!-- Heat Effect Overlay -->
                        <div id="heat-overlay" class="absolute inset-0 rounded-lg pointer-events-none transition-opacity duration-300 mix-blend-overlay bg-red-600 opacity-0"></div>
                    </div>

                    <!-- Insulation Base -->
                    <div class="w-full h-4 bg-slate-300 mt-1 rounded-full opacity-50 blur-sm"></div>
                </div>
            </div>

            <!-- Chart Area -->
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 flex-1 min-h-[350px] flex flex-col">
                <h3 class="text-lg font-semibold text-slate-700 mb-4">溫度 vs 實驗時間 關係圖</h3>
                <div class="relative h-[300px] w-full flex-1">
                    <canvas id="tempChart"></canvas>
                </div>
                <div class="mt-4 bg-blue-50 p-4 rounded-lg border border-blue-100 text-sm text-blue-800">
                    <p><strong>物理提示：</strong> X 軸現在顯示「實驗總時間」。當您關閉電熱器時，您可以觀察到圖線會因為餘熱而繼續微幅上升，然後趨於平緩。</p>
                </div>
            </div>

        </div>
    </div>

    <!-- Scripts -->
    <script>
        // --- Constants & Data ---
        const METALS = {
            aluminum: { name: '鋁 (Aluminum)', c: 900, color: '#A0A0A0' },
            copper:   { name: '銅 (Copper)',   c: 385, color: '#B87333' },
            iron:     { name: '鐵 (Iron)',     c: 450, color: '#5D5D5D' },
            gold:     { name: '金 (Gold)',     c: 129, color: '#FFD700' },
            lead:     { name: '鉛 (Lead)',     c: 128, color: '#4A5568' },
        };

        const TIME_STEP = 0.5; // 基礎模擬時間步長 (秒)
        const UPDATE_INTERVAL = 500; // 實際更新頻率 (毫秒)
        const RESIDUAL_HEAT_DURATION = 4.0; // 關閉後餘熱持續時間 (秒)
        const STABLE_CHECK_DURATION = 10.0; // 溫度穩定後等待時間 (秒)

        // --- State Variables ---
        let state = {
            metal: 'aluminum',
            mass: 1.0,
            power: 100,
            roomTemp: 25,
            speed: 1,
            currentTemp: 25,
            heatingTime: 0, // 電熱器開啟的累積時間
            totalTime: 0,   // 實驗經過的總時間 (X軸)
            isRunning: false,
            isHeaterOn: false,
            residualTime: 0, // 餘熱倒數
            stableTimer: 0,  // 穩定後計時
            dataPoints: [{ x: 0, y: 25 }]
        };

        let intervalId = null;
        let chartInstance = null;

        // --- DOM Elements ---
        const els = {
            metalSelect: document.getElementById('metal-select'),
            massSlider: document.getElementById('mass-slider'),
            massDisplay: document.getElementById('mass-display'),
            powerSlider: document.getElementById('power-slider'),
            powerDisplay: document.getElementById('power-display'),
            headerPowerDisplay: document.getElementById('header-power-display'),
            speedSlider: document.getElementById('speed-slider'),
            speedDisplay: document.getElementById('speed-display'),
            roomTempSlider: document.getElementById('room-temp-slider'),
            roomTempDisplay: document.getElementById('room-temp-display'),
            btnToggleHeater: document.getElementById('btn-toggle-heater'),
            btnToggleText: document.getElementById('btn-toggle-text'),
            btnReset: document.getElementById('btn-reset'),
            residualHeatMsg: document.getElementById('residual-heat-msg'),
            simulationEndMsg: document.getElementById('simulation-end-msg'),
            
            // Viz
            vizTemp: document.getElementById('viz-temp'),
            vizTime: document.getElementById('viz-time'),
            vizHeatingTime: document.getElementById('viz-heating-time'),
            metalBlock: document.getElementById('metal-block'),
            metalNameDisplay: document.getElementById('metal-name-display'),
            metalMassDisplay: document.getElementById('metal-mass-display'),
            heaterRod: document.getElementById('heater-rod'),
            heatOverlay: document.getElementById('heat-overlay'),
            
            // AI
            btnAiAnalyze: document.getElementById('btn-ai-analyze'),
            btnAiQuiz: document.getElementById('btn-ai-quiz'),
            aiOutputContainer: document.getElementById('ai-output-container'),
            aiPlaceholder: document.getElementById('ai-placeholder'),
            aiLoader: document.getElementById('ai-loader'),
            aiContent: document.getElementById('ai-content'),
            quizContainer: document.getElementById('quiz-container'),
            quizQuestion: document.getElementById('quiz-question'),
            quizOptions: document.getElementById('quiz-options'),
            quizExplanation: document.getElementById('quiz-explanation')
        };

        // --- Initialization ---
        function initChart() {
            const ctx = document.getElementById('tempChart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: '溫度 (°C)',
                        data: state.dataPoints,
                        borderColor: METALS[state.metal].color,
                        backgroundColor: METALS[state.metal].color,
                        borderWidth: 3,
                        pointRadius: 0, // 效能優化，隱藏點
                        pointHoverRadius: 5,
                        fill: false,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false, // 關閉動畫以提高效能
                    scales: {
                        x: {
                            type: 'linear',
                            title: { display: true, text: '實驗時間 (s)' },
                            min: 0,
                            ticks: { stepSize: 10 }
                        },
                        y: {
                            title: { display: true, text: '溫度 (°C)' },
                            beginAtZero: true, // 強制從 0 開始
                            min: 0
                        }
                    },
                    plugins: {
                        legend: { display: true }
                    }
                }
            });
        }

        // --- Logic ---
        function updateUI() {
            // Controls
            els.massDisplay.textContent = `${state.mass} kg`;
            els.powerDisplay.textContent = `${state.power} W`;
            els.headerPowerDisplay.textContent = `${state.power} W`;
            els.speedDisplay.textContent = `${state.speed}x`;
            els.roomTempDisplay.textContent = `${state.roomTemp} °C`;

            // Metal Viz
            const metalData = METALS[state.metal];
            els.metalBlock.style.backgroundColor = metalData.color;
            els.metalBlock.style.width = `${Math.min(120 + state.mass * 30, 280)}px`;
            els.metalNameDisplay.textContent = metalData.name;
            els.metalMassDisplay.textContent = `${state.mass} kg`;

            // Heater Glow & State
            const heaterOpacity = state.isHeaterOn 
                ? Math.min(state.power / 400, 1) * 0.9 + 0.1 
                : (state.residualTime > 0 ? (state.residualTime / RESIDUAL_HEAT_DURATION) * 0.5 : 0.1);
            
            els.heaterRod.style.backgroundColor = (state.isHeaterOn || state.residualTime > 0) 
                ? `rgba(255, 69, 0, ${heaterOpacity})` 
                : '#ddd';
            
            els.heaterRod.style.boxShadow = (state.isHeaterOn || state.residualTime > 0)
                ? `0 0 ${(state.power/20) * heaterOpacity}px rgba(255, 69, 0, 0.6)`
                : 'none';

            // Heat Overlay
            const tempDiff = state.currentTemp - state.roomTemp;
            els.heatOverlay.style.opacity = Math.min(tempDiff / 100, 0.6);

            // Displays
            els.vizTemp.textContent = state.currentTemp.toFixed(1);
            els.vizTime.textContent = state.totalTime.toFixed(1); // 顯示總實驗時間
            els.vizHeatingTime.textContent = state.heatingTime.toFixed(1); // 顯示實際加熱時間

            // Button State
            if (state.isHeaterOn) {
                els.btnToggleHeater.classList.remove('bg-green-600', 'hover:bg-green-700', 'bg-slate-400', 'cursor-not-allowed', 'ring-2', 'ring-red-300');
                els.btnToggleHeater.classList.add('bg-red-500', 'hover:bg-red-600', 'ring-2', 'ring-red-300');
                els.btnToggleText.textContent = "關閉電熱器";
                els.btnToggleHeater.disabled = false;
                els.simulationEndMsg.classList.add('hidden');
            } else {
                els.btnToggleHeater.classList.remove('bg-red-500', 'hover:bg-red-600', 'bg-slate-400', 'cursor-not-allowed', 'ring-2', 'ring-red-300');
                els.btnToggleHeater.classList.add('bg-green-600', 'hover:bg-green-700');
                
                if (state.isRunning) {
                     els.btnToggleText.textContent = "恢復加熱";
                } else {
                     els.btnToggleText.textContent = "啟動電熱器";
                }
                els.btnToggleHeater.disabled = false;
            }

            // Status Messages
            if (state.isRunning && !state.isHeaterOn && state.residualTime > 0) {
                els.residualHeatMsg.classList.remove('hidden');
                els.residualHeatMsg.textContent = "⚠️ 電熱器已關閉，餘熱升溫中...";
            } else if (state.isRunning && !state.isHeaterOn && state.residualTime <= 0) {
                 els.residualHeatMsg.classList.remove('hidden');
                 els.residualHeatMsg.textContent = `⏳ 溫度已穩定，等待 ${Math.ceil(STABLE_CHECK_DURATION - state.stableTimer)} 秒後停止...`;
            } else {
                els.residualHeatMsg.classList.add('hidden');
            }

            if (!state.isRunning && state.heatingTime > 0 && !state.isHeaterOn) {
                 els.simulationEndMsg.classList.remove('hidden');
            } else {
                 els.simulationEndMsg.classList.add('hidden');
            }

            // Disable Inputs during run
            const isBusy = state.totalTime > 0;
            els.metalSelect.disabled = isBusy;
            els.roomTempSlider.disabled = isBusy;
            
            // AI Button State
            els.btnAiAnalyze.disabled = state.heatingTime === 0;
            if(state.heatingTime === 0) els.btnAiAnalyze.title = "請先開始實驗";
            else els.btnAiAnalyze.title = "";
        }

        function simulationStep() {
            const dt = TIME_STEP * state.speed;
            state.totalTime += dt; // 總實驗時間持續增加
            
            const c = METALS[state.metal].c;
            let effectivePower = 0;

            if (state.isHeaterOn) {
                effectivePower = state.power;
                state.heatingTime += dt;
                state.residualTime = RESIDUAL_HEAT_DURATION; // Reset residual heat buffer
                state.stableTimer = 0;
            } else {
                if (state.residualTime > 0) {
                    // 餘熱階段
                    const decayFactor = state.residualTime / RESIDUAL_HEAT_DURATION;
                    effectivePower = state.power * decayFactor * 0.8;
                    state.residualTime -= dt;
                } else {
                    // 餘熱耗盡，溫度穩定，開始倒數停止
                    effectivePower = 0;
                    state.stableTimer += dt;
                    if (state.stableTimer >= STABLE_CHECK_DURATION) {
                        // 達到穩定時間，停止實驗
                        state.isRunning = false;
                        clearInterval(intervalId);
                        intervalId = null;
                        updateUI();
                        return;
                    }
                }
            }

            const deltaT = (effectivePower * dt) / (state.mass * c);
            state.currentTemp += deltaT;

            // Push X: totalTime, Y: currentTemp
            state.dataPoints.push({
                x: parseFloat(state.totalTime.toFixed(1)),
                y: parseFloat(state.currentTemp.toFixed(2))
            });

            if(state.dataPoints.length > 500) {
                state.dataPoints.shift(); 
            }

            chartInstance.data.datasets[0].data = state.dataPoints;
            chartInstance.update('none'); 

            updateUI();
        }

        // --- Event Listeners ---
        els.metalSelect.addEventListener('change', (e) => {
            state.metal = e.target.value;
            // Update Chart Color
            chartInstance.data.datasets[0].borderColor = METALS[state.metal].color;
            chartInstance.data.datasets[0].backgroundColor = METALS[state.metal].color;
            chartInstance.update();
            resetExperiment(); 
        });

        els.massSlider.addEventListener('input', (e) => {
            state.mass = parseFloat(e.target.value);
            updateUI();
        });

        els.powerSlider.addEventListener('input', (e) => {
            state.power = parseInt(e.target.value);
            updateUI();
        });

        els.speedSlider.addEventListener('input', (e) => {
            state.speed = parseInt(e.target.value);
            updateUI();
        });

        els.roomTempSlider.addEventListener('input', (e) => {
            state.roomTemp = parseInt(e.target.value);
            if (state.totalTime === 0) {
                state.currentTemp = state.roomTemp;
                state.dataPoints = [{ x: 0, y: state.roomTemp }];
                chartInstance.data.datasets[0].data = state.dataPoints;
                chartInstance.update();
            }
            updateUI();
        });

        els.btnToggleHeater.addEventListener('click', () => {
            if (state.isHeaterOn) {
                // 關閉電熱器
                state.isHeaterOn = false;
                state.residualTime = RESIDUAL_HEAT_DURATION;
            } else {
                // 啟動/恢復
                state.isHeaterOn = true;
                state.isRunning = true;
                if (!intervalId) {
                    intervalId = setInterval(simulationStep, UPDATE_INTERVAL);
                }
            }
            updateUI();
        });

        els.btnReset.addEventListener('click', resetExperiment);

        function resetExperiment() {
            clearInterval(intervalId);
            intervalId = null;
            state.isRunning = false;
            state.isHeaterOn = false;
            state.residualTime = 0;
            state.stableTimer = 0;
            state.heatingTime = 0;
            state.totalTime = 0;
            state.currentTemp = state.roomTemp;
            state.dataPoints = [{ x: 0, y: state.roomTemp }];
            
            els.simulationEndMsg.classList.add('hidden');
            
            // Clear AI
            hideAI();
            
            // Reset Chart
            chartInstance.data.datasets[0].data = state.dataPoints;
            chartInstance.update();
            
            updateUI();
        }

        // --- AI Functions ---
        const apiKey = ""; // Runtime will provide the key

        async function callGemini(prompt, isJson = false) {
            const loadingEl = els.aiLoader;
            const contentEl = els.aiContent;
            const placeholderEl = els.aiPlaceholder;
            const quizEl = els.quizContainer;

            // UI Loading State
            placeholderEl.classList.add('hidden');
            contentEl.classList.add('hidden');
            quizEl.classList.add('hidden');
            loadingEl.classList.remove('hidden');
            
            try {
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: isJson ? { responseMimeType: "application/json" } : {}
                };

                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    }
                );

                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                
                loadingEl.classList.add('hidden');
                return text;
            } catch (error) {
                console.error("Gemini API Error:", error);
                loadingEl.classList.add('hidden');
                placeholderEl.classList.remove('hidden');
                placeholderEl.textContent = "AI 連線錯誤，請稍後再試。";
                return null;
            }
        }

        els.btnAiAnalyze.addEventListener('click', async () => {
            if (state.heatingTime === 0) return;
            
            const prompt = `
              你是一位物理老師。學生剛剛完成了一個比熱容量實驗。
              數據如下:
              - 金屬: ${METALS[state.metal].name} (比熱容量 c = ${METALS[state.metal].c} J/kg°C)
              - 質量 m: ${state.mass} kg
              - 功率 P: ${state.power} W
              - 總實驗時間: ${state.totalTime.toFixed(1)} s
              - 實際加熱時間: ${state.heatingTime.toFixed(1)} s
              - 最高溫度: ${state.currentTemp.toFixed(1)} °C
              - 溫度變化: ${(state.currentTemp - state.roomTemp).toFixed(1)} °C
              
              請用繁體中文簡短分析這個結果。
              1. 驗證理論上的斜率 (Slope = P/mc) 是否與加熱階段的實驗數據吻合。
              2. 解釋為什麼關閉電源後，溫度圖線變平緩但時間繼續增加（而非像之前顯示的垂直線）。
              3. 給予學生一句鼓勵的話。
              請保持回答在 150 字以內，使用條列式。
            `;

            const result = await callGemini(prompt);
            if (result) {
                els.aiContent.textContent = result;
                els.aiContent.classList.remove('hidden');
            }
        });

        els.btnAiQuiz.addEventListener('click', async () => {
            const prompt = `
              Generate a single multiple-choice question about Specific Heat Capacity or the properties of ${METALS[state.metal].name} in Traditional Chinese.
              The question should test the student's understanding of Q = mcΔT or why some metals heat up faster than others.
              
              Respond in this JSON format ONLY:
              {
                "question": "The question text",
                "options": ["Option A", "Option B", "Option C", "Option D"],
                "correctIndex": 0,
                "explanation": "Short explanation of why it is correct."
              }
            `;

            const result = await callGemini(prompt, true);
            if (result) {
                try {
                    const quizData = JSON.parse(result);
                    renderQuiz(quizData);
                } catch (e) {
                    console.error("JSON Parse Error", e);
                }
            }
        });

        function renderQuiz(data) {
            els.quizQuestion.textContent = data.question;
            els.quizOptions.innerHTML = '';
            els.quizExplanation.classList.add('hidden');
            els.quizExplanation.textContent = '';

            data.options.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left p-2 rounded-lg border bg-white border-slate-200 hover:border-indigo-300 hover:bg-indigo-50 transition text-xs sm:text-sm flex justify-between items-center";
                
                const span = document.createElement('span');
                span.textContent = opt;
                btn.appendChild(span);

                btn.onclick = () => {
                    // Disable all buttons
                    const allBtns = els.quizOptions.querySelectorAll('button');
                    allBtns.forEach(b => b.disabled = true);

                    if (idx === data.correctIndex) {
                        btn.classList.remove('bg-white', 'border-slate-200');
                        btn.classList.add('bg-green-100', 'border-green-300', 'text-green-800');
                        // Add check icon
                        btn.innerHTML += `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-600"><polyline points="20 6 9 17 4 12"/></svg>`;
                    } else {
                        btn.classList.remove('bg-white', 'border-slate-200');
                        btn.classList.add('bg-red-50', 'border-red-200', 'text-red-700');
                        // Add X icon
                        btn.innerHTML += `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-500"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>`;
                        
                        // Highlight correct one
                        allBtns[data.correctIndex].classList.add('bg-green-50', 'border-green-200');
                    }

                    els.quizExplanation.innerHTML = `<strong>解析：</strong> ${data.explanation}`;
                    els.quizExplanation.classList.remove('hidden');
                };
                els.quizOptions.appendChild(btn);
            });
            
            els.quizContainer.classList.remove('hidden');
        }

        function hideAI() {
            els.aiLoader.classList.add('hidden');
            els.aiContent.classList.add('hidden');
            els.quizContainer.classList.add('hidden');
            els.aiPlaceholder.classList.remove('hidden');
        }

        // --- Boot ---
        initChart();
        updateUI();

    </script>
</body>
</html>