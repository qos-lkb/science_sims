<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>物理教室：雙訊號拍頻演示</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; touch-action: manipulation; }
        
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%;
            background: #4F46E5; cursor: pointer; margin-top: -10px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.1); }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #E5E7EB; border-radius: 4px;
        }
        input[type=range]:focus { outline: none; }

        .oscilloscope-bg { background: radial-gradient(circle, rgba(30,27,75,1) 0%, rgba(17,24,39,1) 100%); }
        
        .modal { transition: opacity 0.3s ease-in-out; opacity: 0; pointer-events: none; }
        .modal.active { opacity: 1; pointer-events: auto; }

        .note-btn {
            transition: all 0.2s; background-color: #f1f5f9; color: #475569; border: 1px solid #e2e8f0;
        }
        .note-btn:hover {
            background-color: #e0e7ff; color: #4338ca; border-color: #c7d2fe; transform: translateY(-1px);
        }
        .note-btn:active { transform: scale(0.95) translateY(0); }

        .wave-btn { border: 2px solid #E2E8F0; transition: all 0.2s ease; }
        .wave-btn:hover { border-color: #6366F1; color: #4F46E5; background-color: #EEF2FF; }
        .wave-btn.active {
            background-color: #4F46E5; border-color: #4F46E5; color: white;
            box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2);
        }

        /* 針對兩個面板的樣式區隔 */
        .panel-container { transition: all 0.3s ease; }
        .panel-active { border-color: #818cf8; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col">

    <!-- 頂部導航列 -->
    <header class="bg-white shadow-md z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-wave-square text-indigo-600 text-2xl"></i>
                    <h1 class="text-xl font-bold text-slate-800 tracking-wide" id="app-title">物理教室：雙訊號拍頻演示</h1>
                </div>
                <div class="flex items-center space-x-3">
                    <!-- 原理按鈕 -->
                    <button onclick="toggleModal()" class="px-4 py-2 rounded-lg bg-white border border-slate-200 text-slate-600 font-medium hover:bg-indigo-50 hover:text-indigo-600 hover:border-indigo-200 transition flex items-center gap-2 shadow-sm">
                        <i class="fa-regular fa-lightbulb"></i> <span id="btn-theory">原理</span>
                    </button>
                    
                    <!-- AI 助教按鈕 (已移至此) -->
                    <button onclick="toggleAIModal()" class="px-4 py-2 rounded-lg bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white font-bold hover:shadow-lg hover:scale-105 transition flex items-center gap-2 shadow-md border border-white/20">
                        <i class="fa-solid fa-wand-magic-sparkles"></i> <span id="btn-ai">AI 助教</span>
                    </button>

                    <!-- 分隔線 -->
                    <div class="h-6 w-px bg-slate-300 mx-1"></div>
                    
                    <!-- 語言切換 (已移至此) -->
                    <button onclick="toggleLanguage()" class="px-3 py-2 rounded-lg bg-slate-100 text-slate-600 text-sm font-bold hover:bg-slate-200 transition border border-slate-200">
                        <span id="lang-display">中 / EN</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-grow flex flex-col items-center p-4 w-full max-w-7xl mx-auto space-y-6">
        
        <!-- 共用示波器 -->
        <div class="w-full bg-white rounded-3xl shadow-lg overflow-hidden border border-slate-200">
            <div class="relative w-full h-48 oscilloscope-bg flex items-center justify-center">
                <canvas id="oscilloscope" class="absolute inset-0 w-full h-full"></canvas>
                <div class="relative z-10 text-center select-none pointer-events-none bg-black/30 backdrop-blur-sm px-4 py-1 rounded-full border border-white/10">
                    <span class="text-indigo-200 text-sm font-medium tracking-wider" id="scope-label">疊加輸出 (Combined Output)</span>
                </div>
            </div>
        </div>

        <!-- 雙控制面板容器 -->
        <div class="w-full grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <!-- 訊號源 A -->
            <div id="panel-1" class="panel-container bg-white rounded-2xl shadow-md border-2 border-slate-100 p-6 flex flex-col h-full">
                <div class="flex items-center justify-between mb-6 border-b border-slate-100 pb-4">
                    <h2 class="text-lg font-bold text-indigo-600 flex items-center gap-2">
                        <span class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-sm">A</span>
                        <span id="label-source-a">訊號源 A</span>
                    </h2>
                    <div class="flex items-end gap-2">
                        <!-- 可編輯的頻率顯示區域 A -->
                        <div class="relative h-10 flex items-center justify-end min-w-[120px]">
                            <span id="freq-display-1" onclick="editFrequency(1)" class="text-3xl font-mono font-bold text-slate-700 tabular-nums cursor-pointer border-b-2 border-transparent hover:border-indigo-300 hover:text-indigo-600 transition-colors duration-200 px-1" title="點擊輸入數值">440</span>
                            <input type="number" id="freq-input-1" class="hidden absolute right-0 w-32 text-3xl font-mono font-bold text-indigo-600 bg-white border-b-2 border-indigo-600 outline-none text-right p-0" onblur="confirmFrequency(1)" onkeydown="checkEnter(event, 1)">
                        </div>
                        <span class="text-sm text-slate-400 font-sans mb-2">Hz</span>
                    </div>
                </div>

                <!-- 頻率滑桿 A -->
                <div class="mb-6">
                    <div class="relative flex items-center">
                        <input type="range" id="freq-slider-1" min="20" max="20000" value="440" step="1" class="z-10" oninput="updateFreq(1, this.value)">
                    </div>
                    <div class="flex justify-between text-xs text-slate-400 font-mono mt-2">
                        <span>20 Hz</span>
                        <span>20,000 Hz</span>
                    </div>
                </div>

                <!-- 波形 A -->
                <div class="mb-6">
                    <label class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 block" id="label-wave-a">波形</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="changeWaveform(1, 'sine')" id="btn-sine-1" class="wave-btn active rounded p-2 text-xs flex flex-col items-center gap-1"><i class="fa-solid fa-wave-square"></i> Sine</button>
                        <button onclick="changeWaveform(1, 'square')" id="btn-square-1" class="wave-btn rounded p-2 text-xs flex flex-col items-center gap-1"><i class="fa-solid fa-square"></i> Square</button>
                        <button onclick="changeWaveform(1, 'triangle')" id="btn-triangle-1" class="wave-btn rounded p-2 text-xs flex flex-col items-center gap-1"><i class="fa-solid fa-play fa-rotate-270"></i> Triangle</button>
                        <button onclick="changeWaveform(1, 'violin')" id="btn-violin-1" class="wave-btn rounded p-2 text-xs flex flex-col items-center gap-1"><i class="fa-solid fa-music"></i> Strings</button>
                        <button onclick="changeWaveform(1, 'clarinet')" id="btn-clarinet-1" class="wave-btn rounded p-2 text-xs flex flex-col items-center gap-1"><i class="fa-solid fa-wind"></i> Wood</button>
                        <button onclick="changeWaveform(1, 'trumpet')" id="btn-trumpet-1" class="wave-btn rounded p-2 text-xs flex flex-col items-center gap-1"><i class="fa-solid fa-bullhorn"></i> Brass</button>
                    </div>
                </div>

                <!-- 音階 A -->
                <div class="mb-6 flex-grow">
                    <label class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 block" id="label-note-a">音階</label>
                    <div class="space-y-2 max-h-40 overflow-y-auto pr-1">
                        <div class="flex flex-wrap justify-center gap-1" id="octave-3-container-1"></div>
                        <div class="flex flex-wrap justify-center gap-1" id="octave-4-container-1"></div>
                        <div class="flex flex-wrap justify-center gap-1" id="octave-5-container-1"></div>
                    </div>
                </div>

                <!-- 播放 A -->
                <button onclick="toggleSound(1)" id="play-btn-1" class="w-full py-3 rounded-xl bg-slate-100 text-slate-600 font-bold hover:bg-indigo-600 hover:text-white transition flex items-center justify-center gap-2 group">
                    <i class="fa-solid fa-play" id="play-icon-1"></i> <span id="btn-txt-1">播放 A</span>
                </button>
            </div>

            <!-- 訊號源 B -->
            <div id="panel-2" class="panel-container bg-white rounded-2xl shadow-md border-2 border-slate-100 p-6 flex flex-col h-full">
                <div class="flex items-center justify-between mb-6 border-b border-slate-100 pb-4">
                    <h2 class="text-lg font-bold text-emerald-600 flex items-center gap-2">
                        <span class="w-8 h-8 rounded-full bg-emerald-100 flex items-center justify-center text-sm">B</span>
                        <span id="label-source-b">訊號源 B</span>
                    </h2>
                    <div class="flex items-end gap-2">
                        <!-- 可編輯的頻率顯示區域 B -->
                        <div class="relative h-10 flex items-center justify-end min-w-[120px]">
                            <span id="freq-display-2" onclick="editFrequency(2)" class="text-3xl font-mono font-bold text-slate-700 tabular-nums cursor-pointer border-b-2 border-transparent hover:border-emerald-300 hover:text-emerald-600 transition-colors duration-200 px-1" title="點擊輸入數值">440</span>
                            <input type="number" id="freq-input-2" class="hidden absolute right-0 w-32 text-3xl font-mono font-bold text-emerald-600 bg-white border-b-2 border-emerald-600 outline-none text-right p-0" onblur="confirmFrequency(2)" onkeydown="checkEnter(event, 2)">
                        </div>
                        <span class="text-sm text-slate-400 font-sans mb-2">Hz</span>
                    </div>
                </div>

                <!-- 頻率滑桿 B -->
                <div class="mb-6">
                    <div class="relative flex items-center">
                        <input type="range" id="freq-slider-2" min="20" max="20000" value="440" step="1" class="z-10" oninput="updateFreq(2, this.value)">
                    </div>
                    <div class="flex justify-between text-xs text-slate-400 font-mono mt-2">
                        <span>20 Hz</span>
                        <span>20,000 Hz</span>
                    </div>
                </div>

                <!-- 波形 B -->
                <div class="mb-6">
                    <label class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 block" id="label-wave-b">波形</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="changeWaveform(2, 'sine')" id="btn-sine-2" class="wave-btn active rounded p-2 text-xs flex flex-col items-center gap-1"><i class="fa-solid fa-wave-square"></i> Sine</button>
                        <button onclick="changeWaveform(2, 'square')" id="btn-square-2" class="wave-btn rounded p-2 text-xs flex flex-col items-center gap-1"><i class="fa-solid fa-square"></i> Square</button>
                        <button onclick="changeWaveform(2, 'triangle')" id="btn-triangle-2" class="wave-btn rounded p-2 text-xs flex flex-col items-center gap-1"><i class="fa-solid fa-play fa-rotate-270"></i> Triangle</button>
                        <button onclick="changeWaveform(2, 'violin')" id="btn-violin-2" class="wave-btn rounded p-2 text-xs flex flex-col items-center gap-1"><i class="fa-solid fa-music"></i> Strings</button>
                        <button onclick="changeWaveform(2, 'clarinet')" id="btn-clarinet-2" class="wave-btn rounded p-2 text-xs flex flex-col items-center gap-1"><i class="fa-solid fa-wind"></i> Wood</button>
                        <button onclick="changeWaveform(2, 'trumpet')" id="btn-trumpet-2" class="wave-btn rounded p-2 text-xs flex flex-col items-center gap-1"><i class="fa-solid fa-bullhorn"></i> Brass</button>
                    </div>
                </div>

                <!-- 音階 B -->
                <div class="mb-6 flex-grow">
                    <label class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 block" id="label-note-b">音階</label>
                    <div class="space-y-2 max-h-40 overflow-y-auto pr-1">
                        <div class="flex flex-wrap justify-center gap-1" id="octave-3-container-2"></div>
                        <div class="flex flex-wrap justify-center gap-1" id="octave-4-container-2"></div>
                        <div class="flex flex-wrap justify-center gap-1" id="octave-5-container-2"></div>
                    </div>
                </div>

                <!-- 播放 B -->
                <button onclick="toggleSound(2)" id="play-btn-2" class="w-full py-3 rounded-xl bg-slate-100 text-slate-600 font-bold hover:bg-emerald-600 hover:text-white transition flex items-center justify-center gap-2 group">
                    <i class="fa-solid fa-play" id="play-icon-2"></i> <span id="btn-txt-2">播放 B</span>
                </button>
            </div>
        </div>
        
    </main>

    <footer class="py-6 text-center text-slate-400 text-sm">
        <p>&copy; 2025 Physics Lab Demo. Designed for Education.</p>
    </footer>

    <!-- 原理說明 Modal -->
    <div id="theory-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto transform transition-all scale-100">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center sticky top-0 bg-white z-10">
                <h2 class="text-2xl font-bold text-slate-800" id="modal-title">聲音物理原理說明</h2>
                <button onclick="toggleModal()" class="text-slate-400 hover:text-slate-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-100 transition"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div class="p-6 text-slate-600" id="modal-content">
                <!-- Content injected by JS -->
            </div>
            <div class="p-4 border-t border-slate-100 text-right bg-slate-50 rounded-b-2xl">
                <button onclick="toggleModal()" class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition font-medium" id="btn-close">關閉</button>
            </div>
        </div>
    </div>

    <!-- AI 助教 Modal -->
    <div id="ai-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[85vh] overflow-hidden flex flex-col transform transition-all scale-100 border border-violet-100">
            <!-- Header -->
            <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-gradient-to-r from-violet-50 to-fuchsia-50">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-violet-500 to-fuchsia-600 flex items-center justify-center text-white shadow-lg">
                        <i class="fa-solid fa-robot text-lg"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-slate-800">AI 物理助教</h2>
                        <p class="text-xs text-slate-500">Powered by Google Gemini</p>
                    </div>
                </div>
                <button onclick="toggleAIModal()" class="text-slate-400 hover:text-slate-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-white transition">
                    <i class="fa-solid fa-times text-xl"></i>
                </button>
            </div>

            <!-- Content Area -->
            <div class="flex-grow overflow-y-auto p-6 bg-slate-50/50" id="ai-content-area">
                
                <!-- 歡迎畫面 -->
                <div id="ai-welcome" class="text-center py-8 space-y-6">
                    <p class="text-slate-600 text-lg">嗨！我是你的 AI 實驗夥伴。我可以幫你分析目前的波形，或者為你設定一個有趣的物理實驗。</p>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 max-w-lg mx-auto">
                        <button onclick="analyzeCurrentState()" class="group p-4 bg-white rounded-xl border-2 border-indigo-100 hover:border-indigo-500 hover:shadow-md transition text-left flex flex-col gap-2">
                            <span class="w-10 h-10 rounded-lg bg-indigo-100 text-indigo-600 flex items-center justify-center group-hover:scale-110 transition">
                                <i class="fa-solid fa-magnifying-glass-waveform text-xl"></i>
                            </span>
                            <span class="font-bold text-slate-700">分析當前現象</span>
                            <span class="text-xs text-slate-500">解釋目前的頻率組合會產生什麼物理效果（如拍頻、和聲）。</span>
                        </button>

                        <button onclick="suggestExperiment()" class="group p-4 bg-white rounded-xl border-2 border-fuchsia-100 hover:border-fuchsia-500 hover:shadow-md transition text-left flex flex-col gap-2">
                            <span class="w-10 h-10 rounded-lg bg-fuchsia-100 text-fuchsia-600 flex items-center justify-center group-hover:scale-110 transition">
                                <i class="fa-solid fa-flask text-xl"></i>
                            </span>
                            <span class="font-bold text-slate-700">智能實驗建議</span>
                            <span class="text-xs text-slate-500">讓我為你自動設定一個有趣的聲學實驗！(自動調整滑桿)</span>
                        </button>
                    </div>
                </div>

                <!-- 載入中 -->
                <div id="ai-loading" class="hidden flex flex-col items-center justify-center py-12 space-y-4">
                    <div class="w-12 h-12 border-4 border-violet-200 border-t-violet-600 rounded-full animate-spin"></div>
                    <p class="text-violet-600 font-medium animate-pulse">AI 正在思考中...</p>
                </div>

                <!-- 結果顯示 -->
                <div id="ai-result" class="hidden space-y-4">
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 prose prose-slate max-w-none text-slate-700" id="ai-markdown-output">
                        <!-- Markdown content goes here -->
                    </div>
                    <div class="flex justify-center pt-4">
                        <button onclick="resetAIView()" class="px-6 py-2 bg-slate-200 text-slate-700 rounded-full hover:bg-slate-300 font-medium transition">
                            <i class="fa-solid fa-arrow-left mr-2"></i> 返回選單
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // --- 核心資料 ---
        const apiKey = ""; // System will inject key
        let audioCtx;
        let generators = {
            1: { active: false, osc: null, gain: null, freq: 440, type: 'sine' },
            2: { active: false, osc: null, gain: null, freq: 440, type: 'sine' }
        };
        let currentLang = 'zh';

        // 樂器泛音
        const instrumentHarmonics = {
            clarinet: { real: new Float32Array([0,0,0,0,0,0,0,0]), imag: new Float32Array([0,1,0,0.5,0,0.25,0,0.125]) },
            trumpet: { real: new Float32Array([0,0,0,0,0,0,0,0,0]), imag: new Float32Array([0,1,0.8,0.6,0.8,0.5,0.4,0.2,0.1]) }
        };

        // 音階資料
        const createOctaveData = (startFreq) => {
            const ratio = Math.pow(2, 1/12);
            let f = startFreq;
            const notes = [];
            const names = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            for (let i = 0; i < 12; i++) {
                notes.push({ name: names[i], freq: f });
                f = f * ratio;
            }
            return notes;
        };
        const musicalNotes = {
            3: createOctaveData(130.81),
            4: createOctaveData(261.63),
            5: createOctaveData(523.25)
        };

        // --- 語言包 ---
        const i18n = {
            zh: {
                title: "物理教室：雙訊號拍頻演示",
                theoryBtn: "原理",
                scopeLabel: "疊加輸出 (Combined Output)",
                sourceA: "訊號源 A", sourceB: "訊號源 B",
                waveLabel: "波形", noteLabel: "音階",
                playA: "播放 A", stopA: "停止 A",
                playB: "播放 B", stopB: "停止 B",
                modalTitle: "聲音物理原理說明",
                close: "關閉",
                content: `
                    <div class="space-y-6 text-slate-700">
                        <section>
                            <h3 class="flex items-center gap-2 font-bold text-indigo-700 text-lg mb-2">
                                <i class="fa-solid fa-wave-square"></i> 1. 訊號產生器的作用
                            </h3>
                            <p class="leading-relaxed">
                                訊號產生器 (Signal Generator) 是物理與電子實驗中的核心設備，能產生精確的電子振盪訊號。
                                在本實驗中，它驅動揚聲器振動空氣，將<strong>電訊號</strong>轉換為<strong>聲波</strong>。
                                透過調整頻率（音調高低）與波形（音色），我們可以研究聲波的物理特性。
                            </p>
                        </section>

                        <section>
                            <h3 class="flex items-center gap-2 font-bold text-indigo-700 text-lg mb-2">
                                <i class="fa-solid fa-ear-listen"></i> 2. 人類的聽頻範圍
                            </h3>
                            <p class="leading-relaxed mb-2">
                                人耳並非對所有頻率的聲音都有反應。一般健康年輕人的可聽範圍約為 <strong>20 Hz 至 20,000 Hz</strong>。
                            </p>
                            <div class="bg-slate-50 p-3 rounded-lg text-sm space-y-1 border border-slate-200">
                                <p><span class="font-bold text-slate-600">次聲波 (< 20 Hz)：</span> 頻率過低，人耳無法聽見，但身體可能感覺到振動。</p>
                                <p><span class="font-bold text-slate-600">超聲波 (> 20,000 Hz)：</span> 頻率過高，人耳無法聽見（蝙蝠、海豚可聽見）。</p>
                                <p class="text-slate-500 italic mt-1">* 隨著年齡增長，人對高頻聲音的敏感度會顯著下降（例如聽不到 15,000 Hz 以上的聲音）。</p>
                            </div>
                        </section>

                        <section>
                            <h3 class="flex items-center gap-2 font-bold text-indigo-700 text-lg mb-2">
                                <i class="fa-solid fa-stopwatch"></i> 3. 拍頻 (Beat Frequency)
                            </h3>
                            <p class="leading-relaxed mb-3">
                                當兩個<strong>頻率極為接近</strong>（例如 440 Hz 與 442 Hz）的聲波同時播放時，它們會發生<strong>疊加干涉 (Interference)</strong>。
                            </p>
                            
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
                                <div class="bg-indigo-50 p-3 rounded border-l-4 border-indigo-500">
                                    <h4 class="font-bold text-indigo-900 text-sm">相長干涉 (Constructive)</h4>
                                    <p class="text-xs text-indigo-800">波峰遇波峰 → 振幅變大 → <strong>聲音變大</strong></p>
                                </div>
                                <div class="bg-indigo-50 p-3 rounded border-l-4 border-indigo-500">
                                    <h4 class="font-bold text-indigo-900 text-sm">相消干涉 (Destructive)</h4>
                                    <p class="text-xs text-indigo-800">波峰遇波谷 → 振幅抵消 → <strong>聲音變小</strong></p>
                                </div>
                            </div>

                            <p class="leading-relaxed">
                                這種週期性的音量強弱變化稱為「拍」(Beats)。拍的頻率等於兩聲源頻率之差的絕對值：
                            </p>
                            <div class="text-center py-2">
                                <span class="inline-block px-4 py-1 bg-slate-100 rounded-full font-mono font-bold text-indigo-600 border border-slate-200">
                                    f<sub>beat</sub> = | f<sub>1</sub> - f<sub>2</sub> |
                                </span>
                            </div>
                            <p class="text-sm text-slate-500 mt-2">
                                <strong>範例：</strong> 若 f1 = 440 Hz，f2 = 442 Hz，則每秒會聽到 2 次聲音忽大忽小的變化 (2 Hz)。
                            </p>
                        </section>
                    </div>
                `
            },
            en: {
                title: "Physics Lab: Beat Frequency Demo",
                theoryBtn: "Theory",
                scopeLabel: "Combined Output",
                sourceA: "Source A", sourceB: "Source B",
                waveLabel: "Waveform", noteLabel: "Musical Notes",
                playA: "Play A", stopA: "Stop A",
                playB: "Play B", stopB: "Stop B",
                modalTitle: "Physics Principles Explained",
                close: "Close",
                content: `
                    <div class="space-y-6 text-slate-700">
                        <section>
                            <h3 class="flex items-center gap-2 font-bold text-indigo-700 text-lg mb-2">
                                <i class="fa-solid fa-wave-square"></i> 1. The Signal Generator
                            </h3>
                            <p class="leading-relaxed">
                                A Signal Generator is a core device in physics and electronics labs that produces precise electronic oscillation signals.
                                In this demo, it drives speakers to vibrate air, converting <strong>electrical signals</strong> into <strong>sound waves</strong>.
                                By adjusting frequency (pitch) and waveform (timbre), we can study the physical properties of waves.
                            </p>
                        </section>

                        <section>
                            <h3 class="flex items-center gap-2 font-bold text-indigo-700 text-lg mb-2">
                                <i class="fa-solid fa-ear-listen"></i> 2. Human Hearing Range
                            </h3>
                            <p class="leading-relaxed mb-2">
                                The human ear does not respond to all sound frequencies. The typical audible range for a healthy young person is <strong>20 Hz to 20,000 Hz</strong>.
                            </p>
                            <div class="bg-slate-50 p-3 rounded-lg text-sm space-y-1 border border-slate-200">
                                <p><span class="font-bold text-slate-600">Infrasound (< 20 Hz):</span> Frequency is too low to be heard but vibration might be felt.</p>
                                <p><span class="font-bold text-slate-600">Ultrasound (> 20,000 Hz):</span> Frequency is too high to be heard (audible to bats, dolphins, etc.).</p>
                                <p class="text-slate-500 italic mt-1">* Sensitivity to high frequencies declines significantly with age (e.g., inability to hear above 15,000 Hz).</p>
                            </div>
                        </section>

                        <section>
                            <h3 class="flex items-center gap-2 font-bold text-indigo-700 text-lg mb-2">
                                <i class="fa-solid fa-stopwatch"></i> 3. Beat Frequency
                            </h3>
                            <p class="leading-relaxed mb-3">
                                When two sound waves of <strong>very similar frequencies</strong> (e.g., 440 Hz and 442 Hz) are played together, they undergo <strong>Interference</strong>.
                            </p>
                            
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
                                <div class="bg-indigo-50 p-3 rounded border-l-4 border-indigo-500">
                                    <h4 class="font-bold text-indigo-900 text-sm">Constructive Interference</h4>
                                    <p class="text-xs text-indigo-800">Peak meets Peak → Amplitude increases → <strong>Louder Sound</strong></p>
                                </div>
                                <div class="bg-indigo-50 p-3 rounded border-l-4 border-indigo-500">
                                    <h4 class="font-bold text-indigo-900 text-sm">Destructive Interference</h4>
                                    <p class="text-xs text-indigo-800">Peak meets Trough → Amplitude cancels → <strong>Softer Sound</strong></p>
                                </div>
                            </div>

                            <p class="leading-relaxed">
                                This periodic variation in volume is called "Beats". The beat frequency equals the absolute difference between the two source frequencies:
                            </p>
                            <div class="text-center py-2">
                                <span class="inline-block px-4 py-1 bg-slate-100 rounded-full font-mono font-bold text-indigo-600 border border-slate-200">
                                    f<sub>beat</sub> = | f<sub>1</sub> - f<sub>2</sub> |
                                </span>
                            </div>
                            <p class="text-sm text-slate-500 mt-2">
                                <strong>Example:</strong> If f1 = 440 Hz and f2 = 442 Hz, you will hear the volume pulse 2 times per second (2 Hz).
                            </p>
                        </section>
                    </div>
                `
            }
        };

        // --- 初始化 ---
        function init() {
            initNoteButtons(1);
            initNoteButtons(2);
            updateTexts(); // 修正：初始化時立即載入文字內容
            animate();
        }

        function initAudio() {
            if (!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
            }
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        // 產生按鈕
        function initNoteButtons(id) {
            const createBtn = (note, octave) => {
                const btn = document.createElement('button');
                btn.className = 'note-btn w-10 h-8 sm:w-12 sm:h-10 flex items-center justify-center rounded text-xs sm:text-sm font-mono font-medium';
                btn.textContent = note.name + octave;
                btn.onclick = () => updateFreq(id, note.freq);
                return btn;
            };
            
            [3,4,5].forEach(octave => {
                const container = document.getElementById(`octave-${octave}-container-${id}`);
                // 增加安全性檢查
                if (container) {
                    container.innerHTML = '';
                    musicalNotes[octave].forEach(note => container.appendChild(createBtn(note, octave)));
                }
            });
        }

        // --- 核心控制 ---
        function updateFreq(id, val) {
            val = parseFloat(val).toFixed(2);
            generators[id].freq = val;
            
            // Update UI
            const slider = document.getElementById(`freq-slider-${id}`);
            const display = document.getElementById(`freq-display-${id}`);
            if (slider) slider.value = val;
            if (display) display.textContent = Math.round(val);

            // Update Audio
            const gen = generators[id];
            if (gen.active && gen.osc) {
                gen.osc.frequency.setTargetAtTime(val, audioCtx.currentTime, 0.02);
            }
        }

        // --- 手動輸入頻率功能 ---
        function editFrequency(id) {
            const display = document.getElementById(`freq-display-${id}`);
            const input = document.getElementById(`freq-input-${id}`);
            
            if (display && input) {
                // 設定當前值並顯示輸入框
                input.value = generators[id].freq;
                display.classList.add('hidden');
                input.classList.remove('hidden');
                input.focus();
                input.select(); // 全選文字方便修改
            }
        }

        function confirmFrequency(id) {
            const display = document.getElementById(`freq-display-${id}`);
            const input = document.getElementById(`freq-input-${id}`);
            
            if (input) {
                let val = parseFloat(input.value);
                
                // 驗證範圍
                if (isNaN(val)) val = generators[id].freq; // 若無效則還原
                if (val < 20) val = 20;
                if (val > 20000) val = 20000;
                
                // 更新系統
                updateFreq(id, val);
                
                // 還原介面
                input.classList.add('hidden');
                if (display) display.classList.remove('hidden');
            }
        }

        function checkEnter(event, id) {
            if (event.key === 'Enter') {
                const input = document.getElementById(`freq-input-${id}`);
                if (input) input.blur();
            }
        }

        function changeWaveform(id, type) {
            generators[id].type = type;
            
            // Update UI
            const types = ['sine', 'square', 'triangle', 'violin', 'clarinet', 'trumpet'];
            types.forEach(t => {
                const btn = document.getElementById(`btn-${t}-${id}`);
                if (btn) {
                    if(t === type) btn.classList.add('active');
                    else btn.classList.remove('active');
                }
            });

            // Update Audio
            const gen = generators[id];
            if (gen.active && gen.osc) {
                setOscillatorType(gen.osc, type);
            }
        }

        function toggleSound(id) {
            initAudio();
            const gen = generators[id];
            
            if (gen.active) {
                // Stop
                if(gen.gain) {
                    gen.gain.gain.cancelScheduledValues(audioCtx.currentTime);
                    gen.gain.gain.setValueAtTime(gen.gain.gain.value, audioCtx.currentTime);
                    gen.gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
                }
                if(gen.osc) gen.osc.stop(audioCtx.currentTime + 0.1);
                
                setTimeout(() => {
                    if(gen.osc) gen.osc.disconnect();
                    if(gen.gain) gen.gain.disconnect();
                    gen.osc = null;
                    gen.gain = null;
                }, 150);
                
                gen.active = false;
                updatePlayButton(id, false);
                const panel = document.getElementById(`panel-${id}`);
                if (panel) panel.classList.remove('panel-active');

            } else {
                // Start
                gen.osc = audioCtx.createOscillator();
                gen.gain = audioCtx.createGain();
                
                gen.osc.frequency.setValueAtTime(gen.freq, audioCtx.currentTime);
                setOscillatorType(gen.osc, gen.type);

                gen.osc.connect(gen.gain);
                gen.gain.connect(audioCtx.destination);

                // Gain 設為 0.25 (因為有兩個音源，避免總和過大)
                gen.gain.gain.setValueAtTime(0, audioCtx.currentTime);
                gen.gain.gain.linearRampToValueAtTime(0.25, audioCtx.currentTime + 0.1);

                gen.osc.start();
                gen.active = true;
                updatePlayButton(id, true);
                const panel = document.getElementById(`panel-${id}`);
                if (panel) panel.classList.add('panel-active');
            }
        }

        function setOscillatorType(osc, type) {
            if (type === 'violin') {
                osc.type = 'sawtooth';
            } else if (type === 'clarinet') {
                const wave = audioCtx.createPeriodicWave(instrumentHarmonics.clarinet.real, instrumentHarmonics.clarinet.imag);
                osc.setPeriodicWave(wave);
            } else if (type === 'trumpet') {
                const wave = audioCtx.createPeriodicWave(instrumentHarmonics.trumpet.real, instrumentHarmonics.trumpet.imag);
                osc.setPeriodicWave(wave);
            } else {
                osc.type = type;
            }
        }

        function updatePlayButton(id, isPlaying) {
            const btn = document.getElementById(`play-btn-${id}`);
            const icon = document.getElementById(`play-icon-${id}`);
            const txt = document.getElementById(`btn-txt-${id}`);
            const langData = i18n[currentLang];
            const colorClass = id === 1 ? 'hover:bg-indigo-600' : 'hover:bg-emerald-600';
            const activeColor = id === 1 ? 'bg-indigo-600' : 'bg-emerald-600';
            
            if (btn && icon && txt) {
                if (isPlaying) {
                    btn.className = `w-full py-3 rounded-xl text-white font-bold transition flex items-center justify-center gap-2 ${activeColor} shadow-inner`;
                    icon.className = 'fa-solid fa-stop';
                    txt.textContent = id === 1 ? langData.stopA : langData.stopB;
                } else {
                    btn.className = `w-full py-3 rounded-xl bg-slate-100 text-slate-600 font-bold ${colorClass} hover:text-white transition flex items-center justify-center gap-2 group`;
                    icon.className = 'fa-solid fa-play';
                    txt.textContent = id === 1 ? langData.playA : langData.playB;
                }
            }
        }

        // --- 示波器繪圖 ---
        function getWaveValue(type, angle) {
            let y = 0;
            if (type === 'sine') y = Math.sin(angle);
            else if (type === 'square') y = Math.sign(Math.sin(angle)) * 0.8;
            else if (type === 'triangle') y = (2/Math.PI) * Math.asin(Math.sin(angle));
            else if (type === 'violin') {
                let p = (angle % (2 * Math.PI));
                if (p < 0) p += 2 * Math.PI;
                y = -1 + (p / Math.PI);
            }
            else if (type === 'clarinet') {
                y += 1.0 * Math.sin(angle);
                y += 0.5 * Math.sin(3*angle);
                y += 0.25 * Math.sin(5*angle);
                y *= 0.6;
            }
            else if (type === 'trumpet') {
                 const h = instrumentHarmonics.trumpet.imag;
                 for(let n=1; n<h.length; n++) y += h[n]*Math.sin(n*angle);
                 y *= 0.35;
            }
            return y;
        }

        const canvas = document.getElementById('oscilloscope');
        const ctx = canvas.getContext('2d');
        let time = 0;

        function animate() {
            if (canvas.width !== canvas.offsetWidth || canvas.height !== canvas.offsetHeight) {
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
            }
            const w = canvas.width;
            const h = canvas.height;
            
            ctx.clearRect(0, 0, w, h);
            ctx.lineWidth = 3;
            ctx.strokeStyle = '#818cf8'; // indigo-400
            ctx.beginPath();

            // 若兩者都沒播放，畫平線
            if (!generators[1].active && !generators[2].active) {
                ctx.moveTo(0, h/2);
                ctx.lineTo(w, h/2);
                ctx.stroke();
                requestAnimationFrame(animate);
                return;
            }

            // 時間推進
            time += 0.2;

            for (let x = 0; x < w; x++) {
                let totalY = 0;
                
                // 訊號 1
                if (generators[1].active) {
                    const k1 = (generators[1].freq / 500) * 0.1;
                    const effK1 = Math.min(k1, 2.0);
                    // 為了視覺化拍頻，我們需要讓波稍微移動得快一點，或者用 spatial beat
                    // 這裡使用標準波動公式 sin(kx - wt)
                    totalY += getWaveValue(generators[1].type, x * effK1 - time);
                }

                // 訊號 2
                if (generators[2].active) {
                    const k2 = (generators[2].freq / 500) * 0.1;
                    const effK2 = Math.min(k2, 2.0);
                    // 稍微偏移相位或不做偏移直接加
                    totalY += getWaveValue(generators[2].type, x * effK2 - time);
                }

                // 縮放振幅以適應畫布 (如果兩個都開，振幅會疊加，所以除以較大的數)
                // 這裡 h/5 讓單波佔 20% 高，雙波疊加最大 40% 高，不會爆框
                const plotY = h/2 + totalY * (h/5);
                
                if (x === 0) ctx.moveTo(x, plotY);
                else ctx.lineTo(x, plotY);
            }
            
            ctx.stroke();
            requestAnimationFrame(animate);
        }

        // --- 語言切換 ---
        function toggleLanguage() {
            currentLang = currentLang === 'zh' ? 'en' : 'zh';
            updateTexts(); // 切換語言後更新文字
        }

        // 獨立出更新文字的函式，供初始化與切換語言時使用
        function updateTexts() {
            const data = i18n[currentLang];
            
            // 已固定顯示 中 / EN，不需切換 lang-display
            // document.getElementById('lang-display').textContent = currentLang === 'zh' ? 'EN' : '中';
            
            document.getElementById('app-title').textContent = data.title;
            document.getElementById('btn-theory').textContent = data.theoryBtn;
            document.getElementById('scope-label').textContent = data.scopeLabel;
            
            document.getElementById('label-source-a').textContent = data.sourceA;
            document.getElementById('label-source-b').textContent = data.sourceB;
            
            document.getElementById('label-wave-a').textContent = data.waveLabel;
            document.getElementById('label-wave-b').textContent = data.waveLabel;
            document.getElementById('label-note-a').textContent = data.noteLabel;
            document.getElementById('label-note-b').textContent = data.noteLabel;

            document.getElementById('modal-title').textContent = data.modalTitle;
            document.getElementById('modal-content').innerHTML = data.content;
            document.getElementById('btn-close').textContent = data.close;

            updatePlayButton(1, generators[1].active);
            updatePlayButton(2, generators[2].active);
        }

        function toggleModal() {
            const m = document.getElementById('theory-modal');
            if (m) {
                m.classList.toggle('active');
            }
        }
        
        // 確保元素存在再綁定事件
        const theoryModal = document.getElementById('theory-modal');
        if (theoryModal) {
            theoryModal.addEventListener('click', (e) => {
                if(e.target.id === 'theory-modal') toggleModal();
            });
        }

        // --- AI 助教功能 ---
        function toggleAIModal() {
            const m = document.getElementById('ai-modal');
            if (m) {
                m.classList.toggle('active');
                if (m.classList.contains('active')) {
                    resetAIView();
                }
            }
        }
        
        const aiModal = document.getElementById('ai-modal');
        if (aiModal) {
            aiModal.addEventListener('click', (e) => {
                if(e.target.id === 'ai-modal') toggleAIModal();
            });
        }

        function resetAIView() {
            const welcome = document.getElementById('ai-welcome');
            const loading = document.getElementById('ai-loading');
            const result = document.getElementById('ai-result');
            if (welcome && loading && result) {
                welcome.classList.remove('hidden');
                loading.classList.add('hidden');
                result.classList.add('hidden');
            }
        }

        function showAILoading() {
            const welcome = document.getElementById('ai-welcome');
            const loading = document.getElementById('ai-loading');
            const result = document.getElementById('ai-result');
            if (welcome && loading && result) {
                welcome.classList.add('hidden');
                loading.classList.remove('hidden');
                result.classList.add('hidden');
            }
        }

        function showAIResult(htmlContent) {
            const loading = document.getElementById('ai-loading');
            const result = document.getElementById('ai-result');
            const output = document.getElementById('ai-markdown-output');
            if (loading && result && output) {
                loading.classList.add('hidden');
                result.classList.remove('hidden');
                output.innerHTML = htmlContent;
            }
        }

        // 通用 Gemini API 呼叫
        async function callGemini(prompt, isJson = false) {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: isJson ? { responseMimeType: "application/json" } : {}
                    })
                });
                
                if (!response.ok) throw new Error('API Error');
                
                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                return isJson ? JSON.parse(text) : text;
            } catch (error) {
                console.error(error);
                return null;
            }
        }

        // 功能 1：分析當前現象
        async function analyzeCurrentState() {
            showAILoading();
            
            const stateDesc = `
                Source A: ${generators[1].freq} Hz, Waveform: ${generators[1].type}
                Source B: ${generators[2].freq} Hz, Waveform: ${generators[2].type}
                Active Status: A=${generators[1].active}, B=${generators[2].active}
            `;
            
            const prompt = `
                你是一位物理老師。請根據以下訊號產生器的設定，向學生解釋他們正在聽到的現象。
                當前設定：${stateDesc}
                
                請分析：
                1. 頻率關係（例如：拍頻、音程、同度）。
                2. 如果有拍頻，請計算拍頻頻率。
                3. 波形音色差異（如果有）。
                4. 給出一個簡短的觀察建議。
                
                請使用繁體中文，並使用簡單的 HTML 標籤 (<h3>, <p>, <ul>, <li>, <strong>) 來格式化輸出。不要使用 Markdown 代碼塊。
            `;

            const result = await callGemini(prompt);
            
            if (result) {
                showAIResult(result);
            } else {
                showAIResult("<p class='text-red-500'>抱歉，AI 暫時無法連線，請稍後再試。</p>");
            }
        }

        // 功能 2：智能實驗建議
        async function suggestExperiment() {
            showAILoading();
            
            const prompt = `
                你是一位物理老師。請設計一個有趣的聲學實驗，使用兩個訊號產生器。
                實驗類型可以是：拍頻演示(Beat Frequency)、音樂音程(Musical Intervals)、波形比較(Waveform Comparison)、或聽覺錯覺。
                
                請回傳一個 JSON 物件，包含以下欄位：
                {
                    "freqA": number (20-2000),
                    "freqB": number (20-2000),
                    "typeA": "sine"|"square"|"triangle"|"violin"|"clarinet"|"trumpet",
                    "typeB": "sine"|"square"|"triangle"|"violin"|"clarinet"|"trumpet",
                    "title": "實驗標題 (繁體中文)",
                    "description": "實驗說明與觀察重點 (繁體中文 HTML 格式)"
                }
                確保頻率差異是有意義的（例如拍頻差 1-10Hz，或音程符合簡單整數比）。
            `;

            const result = await callGemini(prompt, true);
            
            if (result) {
                // 自動套用設定
                updateFreq(1, result.freqA);
                changeWaveform(1, result.typeA);
                updateFreq(2, result.freqB);
                changeWaveform(2, result.typeB);
                
                // 確保聲音是開啟的（如果原本沒開）
                // 這裡選擇不自動開啟聲音以免嚇到使用者，而是設定好讓使用者自己按播放
                // 或者我們可以開啟它，加上一個提示
                
                const htmlContent = `
                    <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-200 mb-4">
                        <h3 class="text-xl font-bold text-indigo-800 mb-2">✨ AI 已為您設定實驗：${result.title}</h3>
                        <div class="flex gap-4 text-sm text-indigo-600 font-mono mb-2">
                            <span>A: ${result.freqA}Hz (${result.typeA})</span>
                            <span>B: ${result.freqB}Hz (${result.typeB})</span>
                        </div>
                        <p class="text-xs text-slate-500"><i class="fa-solid fa-check"></i> 參數已自動同步至控制面板</p>
                    </div>
                    <div class="mt-4">
                        <h4 class="font-bold text-slate-700 mb-2">實驗說明：</h4>
                        ${result.description}
                    </div>
                    <p class="mt-4 text-sm text-slate-500 italic">請按下「播放」按鈕來開始觀察！</p>
                `;
                
                showAIResult(htmlContent);
            } else {
                showAIResult("<p class='text-red-500'>抱歉，AI 暫時無法連線，請稍後再試。</p>");
            }
        }

        // 啟動
        init();
    </script>
</body>
</html>