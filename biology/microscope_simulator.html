<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¡¯å¾®é¡æ¨¡æ“¬å™¨æ•™å­¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- MathJax for rendering formulas -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            touch-action: manipulation;
        }
        .microscope-body {
            background: linear-gradient(135deg, #e0e0e0 0%, #c0c0c0 100%);
            border-radius: 8px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }
        .eyepiece {
            background: linear-gradient(180deg, #2d3748 0%, #1a202c 100%);
            border-radius: 50%;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .objective-lens {
            background: linear-gradient(180deg, #4a5568 0%, #2d3748 100%);
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            transition: transform 0.3s ease;
        }
        .objective-lens.active {
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }
        .stage {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            border: 2px solid #cbd5e0;
            border-radius: 4px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        .light-source {
            background: radial-gradient(circle, #fef3c7 0%, #fde68a 50%, #f59e0b 100%);
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.6);
            animation: pulse 2s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }
        .specimen-cell {
            transition: all 0.3s ease;
        }
        .focus-control {
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            cursor: pointer;
            user-select: none;
            border: none;
            transition: all 0.2s;
        }
        .focus-control:active {
            transform: scale(0.95);
        }
        .focus-control:hover {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
        }
        .view-area {
            background: radial-gradient(circle, rgba(255,255,255,0.9) 0%, rgba(240,240,240,0.9) 100%);
            border: 3px solid #2d3748;
            border-radius: 50%;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.2);
            aspect-ratio: 1 / 1;
            width: 100%;
            max-width: 100%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .view-area svg {
            width: 100%;
            height: 100%;
            display: block;
        }
        .cell-wall {
            stroke: #4a5568;
            stroke-width: 2;
            fill: none;
        }
        .cell-membrane {
            stroke: #718096;
            stroke-width: 1;
            fill: none;
        }
        .nucleus {
            fill: #4299e1;
            stroke: #2b6cb0;
            stroke-width: 2;
        }
        .cytoplasm {
            fill: #f0f4f8;
        }
        .vacuole {
            fill: #cbd5e0;
            opacity: 0.6;
        }
        .chromatin {
            fill: #2d3748;
        }
        .onion-cell {
            fill: #fef3c7;
        }
        .cheek-cell {
            fill: #fed7d7;
        }
        .plant-cell {
            fill: #c6f6d5;
        }
        /* Style adjustments for MathJax */
        mjx-container {
            font-size: 1em !important;
            color: inherit !important;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen flex flex-col">

    <!-- Header Bar -->
    <header class="bg-white border-b border-slate-200 shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <div>
                <h1 class="text-xl md:text-2xl font-bold text-slate-800" id="header-title">ğŸ”¬ è¤‡å¼é¡¯å¾®é¡æ¨¡æ“¬å™¨</h1>
                <p class="text-sm text-slate-600 hidden md:block" id="header-subtitle">æ¢ç´¢å¾®è§€ä¸–ç•Œçš„æ•™å­¸å·¥å…·</p>
            </div>
            <button onclick="toggleLanguage()" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg text-sm font-bold transition border border-slate-600" id="lang-btn">
                ä¸­ / EN
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col items-center p-4">

    <!-- Main Interface -->
    <main class="w-full max-w-6xl bg-white rounded-xl shadow-lg overflow-hidden border border-slate-200">
        
        <!-- Controls Area -->
        <div class="bg-slate-100 p-4 border-b border-slate-200">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                
                <!-- Eyepiece Lens Selection -->
                <div>
                    <h2 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-2" id="label-eyepiece">æ¥ç›®é¡å€ç‡</h2>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="changeEyepiece(5)" id="eye-5x" class="p-2 bg-white hover:bg-purple-50 border-2 border-slate-300 rounded-lg transition-all hover:shadow-md active:scale-95 font-medium text-slate-700">
                            5Ã—
                        </button>
                        <button onclick="changeEyepiece(10)" id="eye-10x" class="p-2 bg-white hover:bg-purple-50 border-2 border-slate-300 rounded-lg transition-all hover:shadow-md active:scale-95 font-medium text-slate-700">
                            10Ã—
                        </button>
                        <button onclick="changeEyepiece(15)" id="eye-15x" class="p-2 bg-white hover:bg-purple-50 border-2 border-slate-300 rounded-lg transition-all hover:shadow-md active:scale-95 font-medium text-slate-700">
                            15Ã—
                        </button>
                    </div>
                </div>

                <!-- Objective Lens Selection -->
                <div>
                    <h2 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-2" id="label-objective">æ¥ç‰©é¡å€ç‡</h2>
                    <div class="grid grid-cols-4 gap-2">
                        <button onclick="changeObjective(4)" id="obj-4x" class="p-2 bg-white hover:bg-blue-50 border-2 border-slate-300 rounded-lg transition-all hover:shadow-md active:scale-95 font-medium text-slate-700">
                            4Ã—
                        </button>
                        <button onclick="changeObjective(10)" id="obj-10x" class="p-2 bg-white hover:bg-blue-50 border-2 border-slate-300 rounded-lg transition-all hover:shadow-md active:scale-95 font-medium text-slate-700">
                            10Ã—
                        </button>
                        <button onclick="changeObjective(40)" id="obj-40x" class="p-2 bg-white hover:bg-blue-50 border-2 border-slate-300 rounded-lg transition-all hover:shadow-md active:scale-95 font-medium text-slate-700">
                            40Ã—
                        </button>
                        <button onclick="changeObjective(100)" id="obj-100x" class="p-2 bg-white hover:bg-blue-50 border-2 border-slate-300 rounded-lg transition-all hover:shadow-md active:scale-95 font-medium text-slate-700">
                            100Ã—
                        </button>
                    </div>
                </div>

                <!-- Specimen Selection -->
                <div>
                    <h2 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-2" id="label-specimen">æ¨£æœ¬é¸æ“‡</h2>
                    <div class="grid grid-cols-4 gap-2">
                        <button onclick="changeSpecimen('onion')" id="spec-onion" class="p-2 bg-white hover:bg-green-50 border-2 border-slate-300 rounded-lg transition-all hover:shadow-md active:scale-95 font-medium text-slate-700 text-sm" data-i18n-onion="onion">
                            æ´‹è”¥è¡¨çš®
                        </button>
                        <button onclick="changeSpecimen('cheek')" id="spec-cheek" class="p-2 bg-white hover:bg-green-50 border-2 border-slate-300 rounded-lg transition-all hover:shadow-md active:scale-95 font-medium text-slate-700 text-sm" data-i18n-cheek="cheek">
                            å£è…”ä¸Šçš®
                        </button>
                        <button onclick="changeSpecimen('plant')" id="spec-plant" class="p-2 bg-white hover:bg-green-50 border-2 border-slate-300 rounded-lg transition-all hover:shadow-md active:scale-95 font-medium text-slate-700 text-sm" data-i18n-plant="plant">
                            æ¤ç‰©ç´°èƒ
                        </button>
                        <button onclick="changeSpecimen('text')" id="spec-text" class="p-2 bg-white hover:bg-green-50 border-2 border-slate-300 rounded-lg transition-all hover:shadow-md active:scale-95 font-medium text-slate-700 text-sm" data-i18n-text="text">
                            æ–‡å­—
                        </button>
                    </div>
                </div>

                <!-- Light Control -->
                <div>
                    <h2 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-2" id="label-light">å…‰æºäº®åº¦</h2>
                    <input type="range" min="0" max="100" value="70" oninput="changeLightBrightness(this.value)" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                    <div class="flex justify-between text-xs text-slate-500 mt-1">
                        <span id="light-dark">æš—</span>
                        <span id="light-value">70%</span>
                        <span id="light-bright">äº®</span>
                    </div>
                </div>

            </div>
        </div>

        <!-- Microscope and View Area -->
        <div class="p-6">
            <div class="flex flex-col md:flex-row gap-6">
                
                <!-- Microscope Body -->
                <div class="w-full md:w-2/3 flex flex-col items-center">
                    <div class="microscope-body w-full max-w-md p-6 space-y-4">
                        
                        <!-- Eyepiece -->
                        <div class="flex justify-center">
                            <div class="eyepiece w-20 h-20 flex items-center justify-center">
                                <div class="w-12 h-12 bg-black rounded-full"></div>
                            </div>
                        </div>

                        <!-- Body Tube -->
                        <div class="h-8 bg-gradient-to-b from-slate-600 to-slate-700 rounded-t-lg"></div>

                        <!-- Revolving Nosepiece with Objectives -->
                        <div class="flex justify-center space-x-2">
                            <div class="objective-lens w-12 h-12 flex items-center justify-center active" id="obj-lens-4x" onclick="changeObjective(4)">
                                <span class="text-white text-xs font-bold">4Ã—</span>
                            </div>
                            <div class="objective-lens w-12 h-12 flex items-center justify-center" id="obj-lens-10x" onclick="changeObjective(10)">
                                <span class="text-white text-xs font-bold">10Ã—</span>
                            </div>
                            <div class="objective-lens w-12 h-12 flex items-center justify-center" id="obj-lens-40x" onclick="changeObjective(40)">
                                <span class="text-white text-xs font-bold">40Ã—</span>
                            </div>
                            <div class="objective-lens w-12 h-12 flex items-center justify-center" id="obj-lens-100x" onclick="changeObjective(100)">
                                <span class="text-white text-xs font-bold">100Ã—</span>
                            </div>
                        </div>

                        <!-- Stage -->
                        <div class="stage p-4 relative">
                            <div class="view-area overflow-hidden mx-auto" id="view-area">
                                <svg id="specimen-svg" viewBox="0 0 400 400">
                                    <defs>
                                        <clipPath id="circular-clip">
                                            <circle cx="200" cy="200" r="200"/>
                                        </clipPath>
                                    </defs>
                                    <g clip-path="url(#circular-clip)">
                                        <!-- Specimen will be drawn here -->
                                    </g>
                                </svg>
                            </div>
                            <div class="absolute top-2 right-2 bg-black bg-opacity-50 text-white px-2 py-1 rounded text-xs" id="label-stage">
                                è¼‰ç‰©å°
                            </div>
                        </div>

                        <!-- Focus Controls -->
                        <div class="flex justify-center space-x-4">
                            <div class="text-center">
                                <div class="flex flex-col items-center space-x-1">
                                    <button class="focus-control w-12 h-12 flex items-center justify-center mb-1" onmousedown="startCoarseFocus('up')" onmouseup="stopFocus()" ontouchstart="startCoarseFocus('up')" ontouchend="stopFocus()">
                                        <span class="text-white text-xs">â†‘</span>
                                    </button>
                                    <div class="text-white text-xs font-bold mb-1" id="label-coarse">ç²—èª¿</div>
                                    <button class="focus-control w-12 h-12 flex items-center justify-center" onmousedown="startCoarseFocus('down')" onmouseup="stopFocus()" ontouchstart="startCoarseFocus('down')" ontouchend="stopFocus()">
                                        <span class="text-white text-xs">â†“</span>
                                    </button>
                                </div>
                                <div class="text-xs text-slate-600 mt-1" id="label-coarse-wheel">ç²—èª¿ç¯€å™¨</div>
                            </div>
                            <div class="text-center">
                                <div class="flex flex-col items-center space-x-1">
                                    <button class="focus-control w-10 h-10 flex items-center justify-center mb-1" onmousedown="startFineFocus('up')" onmouseup="stopFocus()" ontouchstart="startFineFocus('up')" ontouchend="stopFocus()">
                                        <span class="text-white text-[10px]">â†‘</span>
                                    </button>
                                    <div class="text-white text-[10px] mb-1" id="label-fine">ç´°èª¿</div>
                                    <button class="focus-control w-10 h-10 flex items-center justify-center" onmousedown="startFineFocus('down')" onmouseup="stopFocus()" ontouchstart="startFineFocus('down')" ontouchend="stopFocus()">
                                        <span class="text-white text-[10px]">â†“</span>
                                    </button>
                                </div>
                                <div class="text-xs text-slate-600 mt-1" id="label-fine-wheel">å¾®èª¿ç¯€å™¨</div>
                            </div>
                        </div>

                        <!-- Light Source -->
                        <div class="flex justify-center">
                            <div class="light-source w-16 h-16" id="light-source"></div>
                        </div>

                    </div>
                </div>

                <!-- Information Panel -->
                <div class="w-full md:w-1/3 bg-slate-50 rounded-lg p-6 space-y-4">
                    <h2 class="text-xl font-bold text-slate-800 mb-4" id="info-title">é¡¯å¾®é¡è³‡è¨Š</h2>
                    
                    <div class="space-y-3">
                        <div class="bg-white p-4 rounded-lg shadow-sm">
                            <div class="text-sm text-slate-500 mb-1" id="label-total-mag">ç¸½æ”¾å¤§å€ç‡</div>
                            <div class="text-2xl font-bold text-blue-600" id="total-magnification">20Ã—</div>
                            <div class="text-xs text-slate-400 mt-1">
                                å…¬å¼ï¼š\(M_{ç¸½} = M_{ç›®é¡} \times M_{ç‰©é¡}\)
                            </div>
                        </div>

                        <div class="bg-white p-4 rounded-lg shadow-sm">
                            <div class="text-sm text-slate-500 mb-1" id="label-current-specimen">ç•¶å‰æ¨£æœ¬</div>
                            <div class="text-lg font-semibold text-slate-700" id="current-specimen">æ´‹è”¥è¡¨çš®ç´°èƒ</div>
                        </div>

                        <div class="bg-white p-4 rounded-lg shadow-sm">
                            <div class="text-sm text-slate-500 mb-1" id="label-focus-status">ç„¦è·ç‹€æ…‹</div>
                            <div class="text-lg font-semibold text-slate-700" id="focus-status">å·²å°ç„¦</div>
                            <div class="text-xs text-slate-400 mt-1">
                                <span id="label-focus-value">ç„¦è·</span>ï¼š<span id="focus-value">0</span> Î¼m
                            </div>
                        </div>

                        <div class="bg-white p-4 rounded-lg shadow-sm">
                            <div class="text-sm text-slate-500 mb-1" id="label-resolution">è§£æåº¦</div>
                            <div class="text-lg font-semibold text-slate-700" id="resolution">3.36 Î¼m</div>
                            <div class="text-xs text-slate-400 mt-1">
                                å…¬å¼ï¼š\(R = \frac{0.61\lambda}{NA}\)
                            </div>
                        </div>

                        <div class="bg-white p-4 rounded-lg shadow-sm">
                            <h3 class="text-sm font-bold text-slate-700 mb-2" id="label-structure">é¡¯å¾®é¡çµæ§‹èªªæ˜</h3>
                            <ul class="text-xs text-slate-600 space-y-1" id="structure-list">
                                <li>â€¢ <strong>ç›®é¡</strong>ï¼šé€šå¸¸ç‚º 10Ã— æˆ– 15Ã—</li>
                                <li>â€¢ <strong>ç‰©é¡</strong>ï¼š4Ã—, 10Ã—, 40Ã—, 100Ã—</li>
                                <li>â€¢ <strong>è¼‰ç‰©å°</strong>ï¼šæ”¾ç½®æ¨£æœ¬</li>
                                <li>â€¢ <strong>ç²—èª¿ç„¦è¼ª</strong>ï¼šå¿«é€Ÿèª¿æ•´ç„¦è·</li>
                                <li>â€¢ <strong>ç´°èª¿ç„¦è¼ª</strong>ï¼šç²¾ç´°èª¿æ•´ç„¦è·</li>
                                <li>â€¢ <strong>å…‰æº</strong>ï¼šæä¾›ç…§æ˜</li>
                            </ul>
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </main>
    </div>

    <script>
        // State variables
        let eyepieceMagnification = 5; // ç•¶å‰ç›®é¡å€ç‡
        let objectiveMagnification = 4; // ç•¶å‰ç‰©é¡å€ç‡
        let currentSpecimen = 'onion';
        let lightBrightness = 70;
        let focusPosition = 0; // ç„¦è·ä½ç½® (Î¼m)
        let focusInterval = null;
        let isFocusing = false;
        let currentLang = 'zh'; // ç•¶å‰èªè¨€

        // Translations
        const translations = {
            zh: {
                title: 'ğŸ”¬ è¤‡å¼é¡¯å¾®é¡æ¨¡æ“¬å™¨',
                subtitle: 'æ¢ç´¢å¾®è§€ä¸–ç•Œçš„æ•™å­¸å·¥å…·',
                labelEyepiece: 'æ¥ç›®é¡å€ç‡',
                labelObjective: 'æ¥ç‰©é¡å€ç‡',
                labelSpecimen: 'æ¨£æœ¬é¸æ“‡',
                labelLight: 'å…‰æºäº®åº¦',
                lightDark: 'æš—',
                lightBright: 'äº®',
                labelTotalMag: 'ç¸½æ”¾å¤§å€ç‡',
                labelCurrentSpecimen: 'ç•¶å‰æ¨£æœ¬',
                labelFocusStatus: 'ç„¦è·ç‹€æ…‹',
                labelFocusValue: 'ç„¦è·',
                labelResolution: 'è§£æåº¦',
                labelStructure: 'é¡¯å¾®é¡çµæ§‹èªªæ˜',
                labelStage: 'è¼‰ç‰©å°',
                labelCoarse: 'ç²—èª¿',
                labelFine: 'ç´°èª¿',
                labelCoarseWheel: 'ç²—èª¿ç¯€å™¨',
                labelFineWheel: 'å¾®èª¿ç¯€å™¨',
                infoTitle: 'é¡¯å¾®é¡è³‡è¨Š',
                focusIn: 'å·²å°ç„¦',
                focusOut: 'æœªå°ç„¦',
                specimens: {
                    onion: 'æ´‹è”¥è¡¨çš®ç´°èƒ',
                    cheek: 'å£è…”ä¸Šçš®ç´°èƒ',
                    plant: 'æ¤ç‰©è‘‰ç‰‡ç´°èƒ',
                    text: 'æ–‡å­—æ¨£æœ¬'
                },
                specimenButtons: {
                    onion: 'æ´‹è”¥è¡¨çš®',
                    cheek: 'å£è…”ä¸Šçš®',
                    plant: 'æ¤ç‰©ç´°èƒ',
                    text: 'æ–‡å­—'
                },
                structureList: [
                    'â€¢ <strong>ç›®é¡</strong>ï¼šé€šå¸¸ç‚º 5Ã—, 10Ã— æˆ– 15Ã—',
                    'â€¢ <strong>ç‰©é¡</strong>ï¼š4Ã—, 10Ã—, 40Ã—, 100Ã—',
                    'â€¢ <strong>è¼‰ç‰©å°</strong>ï¼šæ”¾ç½®æ¨£æœ¬',
                    'â€¢ <strong>ç²—èª¿ç¯€å™¨</strong>ï¼šå¿«é€Ÿèª¿æ•´ç„¦è·',
                    'â€¢ <strong>å¾®èª¿ç¯€å™¨</strong>ï¼šç²¾ç´°èª¿æ•´ç„¦è·',
                    'â€¢ <strong>å…‰æº</strong>ï¼šæä¾›ç…§æ˜'
                ]
            },
            en: {
                title: 'ğŸ”¬ Compound Microscope Simulator',
                subtitle: 'Teaching tool for exploring the microscopic world',
                labelEyepiece: 'Eyepiece Magnification',
                labelObjective: 'Objective Magnification',
                labelSpecimen: 'Specimen Selection',
                labelLight: 'Light Brightness',
                lightDark: 'Dark',
                lightBright: 'Bright',
                labelTotalMag: 'Total Magnification',
                labelCurrentSpecimen: 'Current Specimen',
                labelFocusStatus: 'Focus Status',
                labelFocusValue: 'Focus',
                labelResolution: 'Resolution',
                labelStructure: 'Microscope Structure',
                labelStage: 'Stage',
                labelCoarse: 'Coarse',
                labelFine: 'Fine',
                labelCoarseWheel: 'Coarse Adjuster',
                labelFineWheel: 'Fine Adjuster',
                infoTitle: 'Microscope Information',
                focusIn: 'In Focus',
                focusOut: 'Out of Focus',
                specimens: {
                    onion: 'Onion Epidermal Cell',
                    cheek: 'Cheek Epithelial Cell',
                    plant: 'Plant Leaf Cell',
                    text: 'Text Specimen'
                },
                specimenButtons: {
                    onion: 'Onion',
                    cheek: 'Cheek',
                    plant: 'Plant',
                    text: 'Text'
                },
                structureList: [
                    'â€¢ <strong>Eyepiece</strong>: Usually 5Ã—, 10Ã— or 15Ã—',
                    'â€¢ <strong>Objective</strong>: 4Ã—, 10Ã—, 40Ã—, 100Ã—',
                    'â€¢ <strong>Stage</strong>: Place specimen',
                    'â€¢ <strong>Coarse Adjuster</strong>: Quick focus adjustment',
                    'â€¢ <strong>Fine Adjuster</strong>: Precise focus adjustment',
                    'â€¢ <strong>Light Source</strong>: Provides illumination'
                ]
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Set initial button states
            document.getElementById('eye-5x').classList.add('bg-purple-500', 'text-white', 'border-purple-600');
            document.getElementById('eye-5x').classList.remove('bg-white', 'text-slate-700', 'border-slate-300');
            document.getElementById('obj-4x').classList.add('bg-blue-500', 'text-white', 'border-blue-600');
            document.getElementById('obj-4x').classList.remove('bg-white', 'text-slate-700', 'border-slate-300');
            document.getElementById('spec-onion').classList.add('bg-green-500', 'text-white', 'border-green-600');
            document.getElementById('spec-onion').classList.remove('bg-white', 'text-slate-700', 'border-slate-300');
            
            updateMagnification();
            updateResolution();
            drawSpecimen();
            updateFocusStatus();
            changeLightBrightness(70);
            updateTexts();
        });

        // Toggle language
        function toggleLanguage() {
            currentLang = currentLang === 'zh' ? 'en' : 'zh';
            updateTexts();
        }

        // Update all texts based on current language
        function updateTexts() {
            const t = translations[currentLang];
            
            // Header
            document.getElementById('header-title').textContent = t.title;
            document.getElementById('header-subtitle').textContent = t.subtitle;
            
            // Labels
            document.getElementById('label-eyepiece').textContent = t.labelEyepiece;
            document.getElementById('label-objective').textContent = t.labelObjective;
            document.getElementById('label-specimen').textContent = t.labelSpecimen;
            document.getElementById('label-light').textContent = t.labelLight;
            document.getElementById('light-dark').textContent = t.lightDark;
            document.getElementById('light-bright').textContent = t.lightBright;
            document.getElementById('label-total-mag').textContent = t.labelTotalMag;
            document.getElementById('label-current-specimen').textContent = t.labelCurrentSpecimen;
            document.getElementById('label-focus-status').textContent = t.labelFocusStatus;
            document.getElementById('label-focus-value').textContent = t.labelFocusValue;
            document.getElementById('label-resolution').textContent = t.labelResolution;
            document.getElementById('label-structure').textContent = t.labelStructure;
            document.getElementById('label-stage').textContent = t.labelStage;
            document.getElementById('label-coarse').textContent = t.labelCoarse;
            document.getElementById('label-fine').textContent = t.labelFine;
            document.getElementById('label-coarse-wheel').textContent = t.labelCoarseWheel;
            document.getElementById('label-fine-wheel').textContent = t.labelFineWheel;
            document.getElementById('info-title').textContent = t.infoTitle;
            
            // Structure list
            const structureList = document.getElementById('structure-list');
            structureList.innerHTML = t.structureList.map(item => `<li>${item}</li>`).join('');
            
            // Update specimen name
            document.getElementById('current-specimen').textContent = t.specimens[currentSpecimen];
            
            // Update specimen button texts
            document.getElementById('spec-onion').textContent = t.specimenButtons.onion;
            document.getElementById('spec-cheek').textContent = t.specimenButtons.cheek;
            document.getElementById('spec-plant').textContent = t.specimenButtons.plant;
            if (document.getElementById('spec-text')) {
                document.getElementById('spec-text').textContent = t.specimenButtons.text;
            }
            
            // Update focus status text
            updateFocusStatus();
            
            // Re-render MathJax
            if (window.MathJax) {
                MathJax.typesetPromise();
            }
        }

        // Change eyepiece lens
        function changeEyepiece(magnification) {
            eyepieceMagnification = magnification;
            
            // Update button states
            document.querySelectorAll('[id^="eye-"]').forEach(btn => {
                btn.classList.remove('bg-purple-500', 'text-white', 'border-purple-600');
                btn.classList.add('bg-white', 'text-slate-700', 'border-slate-300');
            });
            const btn = document.getElementById(`eye-${magnification}x`);
            if (btn) {
                btn.classList.add('bg-purple-500', 'text-white', 'border-purple-600');
                btn.classList.remove('bg-white', 'text-slate-700', 'border-slate-300');
            }

            updateMagnification();
            drawSpecimen();
        }

        // Change objective lens
        function changeObjective(magnification) {
            objectiveMagnification = magnification;
            
            // Update button states
            document.querySelectorAll('[id^="obj-"]').forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white', 'border-blue-600');
                btn.classList.add('bg-white', 'text-slate-700', 'border-slate-300');
            });
            document.getElementById(`obj-${magnification}x`).classList.add('bg-blue-500', 'text-white', 'border-blue-600');
            document.getElementById(`obj-${magnification}x`).classList.remove('bg-white', 'text-slate-700', 'border-slate-300');

            // Update lens visual states
            document.querySelectorAll('[id^="obj-lens-"]').forEach(lens => {
                lens.classList.remove('active');
            });
            document.getElementById(`obj-lens-${magnification}x`).classList.add('active');

            updateMagnification();
            updateResolution();
            drawSpecimen();
        }

        // Change specimen
        function changeSpecimen(specimen) {
            currentSpecimen = specimen;
            
            // Update button states
            document.querySelectorAll('[id^="spec-"]').forEach(btn => {
                btn.classList.remove('bg-green-500', 'text-white', 'border-green-600');
                btn.classList.add('bg-white', 'text-slate-700', 'border-slate-300');
            });
            document.getElementById(`spec-${specimen}`).classList.add('bg-green-500', 'text-white', 'border-green-600');
            document.getElementById(`spec-${specimen}`).classList.remove('bg-white', 'text-slate-700', 'border-slate-300');

            // Update specimen name
            const t = translations[currentLang];
            document.getElementById('current-specimen').textContent = t.specimens[specimen];

            drawSpecimen();
        }

        // Change light brightness
        function changeLightBrightness(value) {
            lightBrightness = parseInt(value);
            document.getElementById('light-value').textContent = value + '%';
            
            const lightSource = document.getElementById('light-source');
            const opacity = 0.3 + (lightBrightness / 100) * 0.7;
            lightSource.style.opacity = opacity;
            
            // Update view area brightness
            const viewArea = document.getElementById('view-area');
            const brightness = 0.5 + (lightBrightness / 100) * 0.5;
            viewArea.style.filter = `brightness(${brightness})`;
        }

        // Update total magnification
        function updateMagnification() {
            const totalMag = eyepieceMagnification * objectiveMagnification;
            document.getElementById('total-magnification').textContent = totalMag + 'Ã—';
        }

        // Update resolution
        function updateResolution() {
            // Simplified resolution calculation
            // R = 0.61 * lambda / NA
            // For visible light (lambda â‰ˆ 550 nm) and typical NA values
            const naValues = {
                4: 0.1,
                10: 0.25,
                40: 0.65,
                100: 1.25
            };
            const lambda = 0.55; // Î¼m
            const na = naValues[objectiveMagnification] || 0.65;
            const resolution = (0.61 * lambda / na).toFixed(2);
            document.getElementById('resolution').textContent = resolution + ' Î¼m';
        }

        // Start coarse focus
        function startCoarseFocus(direction) {
            if (isFocusing) {
                stopFocus();
            }
            isFocusing = true;
            const step = direction === 'up' ? 5 : -5;
            focusInterval = setInterval(() => {
                focusPosition += step;
                // Limit focus range
                focusPosition = Math.max(-100, Math.min(100, focusPosition));
                updateFocusStatus();
                drawSpecimen();
            }, 50);
        }

        // Start fine focus
        function startFineFocus(direction) {
            if (isFocusing) {
                stopFocus();
            }
            isFocusing = true;
            const step = direction === 'up' ? 1 : -1;
            focusInterval = setInterval(() => {
                focusPosition += step;
                // Limit focus range
                focusPosition = Math.max(-100, Math.min(100, focusPosition));
                updateFocusStatus();
                drawSpecimen();
            }, 50);
        }

        // Stop focus
        function stopFocus() {
            if (focusInterval) {
                clearInterval(focusInterval);
                focusInterval = null;
            }
            isFocusing = false;
        }

        // Update focus status
        function updateFocusStatus() {
            const focusValue = document.getElementById('focus-value');
            focusValue.textContent = focusPosition.toFixed(0);
            
            const focusStatus = document.getElementById('focus-status');
            const t = translations[currentLang];
            // Consider in focus if within Â±10 Î¼m
            if (Math.abs(focusPosition) < 10) {
                focusStatus.textContent = t.focusIn;
                focusStatus.classList.remove('text-red-600');
                focusStatus.classList.add('text-green-600');
            } else {
                focusStatus.textContent = t.focusOut;
                focusStatus.classList.remove('text-green-600');
                focusStatus.classList.add('text-red-600');
            }
        }

        // Draw specimen
        function drawSpecimen() {
            const svg = document.getElementById('specimen-svg');
            
            // Get or create the clip group
            let clipGroup = svg.querySelector('g[clip-path]');
            if (!clipGroup) {
                // Ensure defs exists
                let defs = svg.querySelector('defs');
                if (!defs) {
                    defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
                    const clipPath = document.createElementNS('http://www.w3.org/2000/svg', 'clipPath');
                    clipPath.setAttribute('id', 'circular-clip');
                    const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    circle.setAttribute('cx', '200');
                    circle.setAttribute('cy', '200');
                    circle.setAttribute('r', '200');
                    clipPath.appendChild(circle);
                    defs.appendChild(clipPath);
                    svg.insertBefore(defs, svg.firstChild);
                }
                clipGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                clipGroup.setAttribute('clip-path', 'url(#circular-clip)');
                svg.appendChild(clipGroup);
            } else {
                // Clear existing content in clip group
                clipGroup.innerHTML = '';
            }

            // Calculate cell size based on total magnification
            // Higher magnification = cells appear larger (proportional relationship)
            // Base cell size increases as magnification increases
            const totalMag = eyepieceMagnification * objectiveMagnification;
            const baseCellSize = 50; // Base size at 40Ã— total magnification
            const cellSize = baseCellSize * (totalMag / 40); // Direct proportional relationship
            const cellCount = Math.max(1, Math.floor(400 / cellSize));
            const offset = (400 - cellCount * cellSize) / 2;

            // Calculate blur based on focus
            const blurAmount = Math.abs(focusPosition) / 5;
            const blur = blurAmount > 0 ? `blur(${Math.min(blurAmount, 10)}px)` : 'none';
            clipGroup.style.filter = blur;

            if (currentSpecimen === 'text') {
                // Draw text specimen (inverted)
                drawTextSpecimen(clipGroup, totalMag);
            } else {
                // Draw cell specimens
                for (let i = 0; i < cellCount; i++) {
                    for (let j = 0; j < cellCount; j++) {
                        const x = offset + i * cellSize;
                        const y = offset + j * cellSize;
                        drawCell(clipGroup, x, y, cellSize);
                    }
                }
            }
        }

        // Draw text specimen (inverted as in real microscope)
        function drawTextSpecimen(container, totalMag) {
            // Microscope produces inverted image (upside down and left-right reversed)
            const textGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            // Invert: scale(-1, -1) to flip both horizontally and vertically
            // Translate to center, scale, then translate back
            textGroup.setAttribute('transform', 'translate(200, 200) scale(-1, -1) translate(-200, -200)');
            
            // Calculate text size based on magnification
            const baseFontSize = 60;
            const fontSize = baseFontSize * (totalMag / 40);
            
            // Draw text in center - this will appear inverted due to the transform
            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.setAttribute('x', '200');
            text.setAttribute('y', '200');
            text.setAttribute('font-size', fontSize);
            text.setAttribute('font-family', 'Arial, sans-serif');
            text.setAttribute('font-weight', 'bold');
            text.setAttribute('fill', '#1e293b');
            text.setAttribute('text-anchor', 'middle');
            text.setAttribute('dominant-baseline', 'middle');
            text.textContent = 'ABC';
            
            textGroup.appendChild(text);
            container.appendChild(textGroup);
        }

        // Draw a single cell
        function drawCell(svg, x, y, size) {
            const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            g.setAttribute('class', 'specimen-cell');
            g.setAttribute('transform', `translate(${x}, ${y})`);

            if (currentSpecimen === 'onion') {
                // Onion epidermal cell
                const cellRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                cellRect.setAttribute('x', size * 0.1);
                cellRect.setAttribute('y', size * 0.1);
                cellRect.setAttribute('width', size * 0.8);
                cellRect.setAttribute('height', size * 0.8);
                cellRect.setAttribute('class', 'cell-wall');
                g.appendChild(cellRect);

                const nucleus = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                nucleus.setAttribute('cx', size * 0.5);
                nucleus.setAttribute('cy', size * 0.5);
                nucleus.setAttribute('r', size * 0.15);
                nucleus.setAttribute('class', 'nucleus');
                g.appendChild(nucleus);

                const cytoplasm = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                cytoplasm.setAttribute('x', size * 0.15);
                cytoplasm.setAttribute('y', size * 0.15);
                cytoplasm.setAttribute('width', size * 0.7);
                cytoplasm.setAttribute('height', size * 0.7);
                cytoplasm.setAttribute('class', 'cytoplasm onion-cell');
                g.appendChild(cytoplasm);

            } else if (currentSpecimen === 'cheek') {
                // Cheek cell (animal cell)
                const cellCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                cellCircle.setAttribute('cx', size * 0.5);
                cellCircle.setAttribute('cy', size * 0.5);
                cellCircle.setAttribute('r', size * 0.4);
                cellCircle.setAttribute('class', 'cell-membrane');
                g.appendChild(cellCircle);

                const cytoplasm = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                cytoplasm.setAttribute('cx', size * 0.5);
                cytoplasm.setAttribute('cy', size * 0.5);
                cytoplasm.setAttribute('r', size * 0.38);
                cytoplasm.setAttribute('class', 'cytoplasm cheek-cell');
                g.appendChild(cytoplasm);

                const nucleus = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                nucleus.setAttribute('cx', size * 0.5);
                nucleus.setAttribute('cy', size * 0.5);
                nucleus.setAttribute('r', size * 0.2);
                nucleus.setAttribute('class', 'nucleus');
                g.appendChild(nucleus);

                // Chromatin dots
                for (let i = 0; i < 5; i++) {
                    const dot = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    const angle = (i * 2 * Math.PI) / 5;
                    dot.setAttribute('cx', size * 0.5 + Math.cos(angle) * size * 0.15);
                    dot.setAttribute('cy', size * 0.5 + Math.sin(angle) * size * 0.15);
                    dot.setAttribute('r', size * 0.03);
                    dot.setAttribute('class', 'chromatin');
                    g.appendChild(dot);
                }

            } else if (currentSpecimen === 'plant') {
                // Plant cell
                const cellRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                cellRect.setAttribute('x', size * 0.1);
                cellRect.setAttribute('y', size * 0.1);
                cellRect.setAttribute('width', size * 0.8);
                cellRect.setAttribute('height', size * 0.8);
                cellRect.setAttribute('class', 'cell-wall');
                g.appendChild(cellRect);

                const cytoplasm = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                cytoplasm.setAttribute('x', size * 0.15);
                cytoplasm.setAttribute('y', size * 0.15);
                cytoplasm.setAttribute('width', size * 0.7);
                cytoplasm.setAttribute('height', size * 0.7);
                cytoplasm.setAttribute('class', 'cytoplasm plant-cell');
                g.appendChild(cytoplasm);

                const nucleus = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                nucleus.setAttribute('cx', size * 0.5);
                nucleus.setAttribute('cy', size * 0.5);
                nucleus.setAttribute('r', size * 0.12);
                nucleus.setAttribute('class', 'nucleus');
                g.appendChild(nucleus);

                // Vacuole
                const vacuole = document.createElementNS('http://www.w3.org/2000/svg', 'ellipse');
                vacuole.setAttribute('cx', size * 0.6);
                vacuole.setAttribute('cy', size * 0.6);
                vacuole.setAttribute('rx', size * 0.2);
                vacuole.setAttribute('ry', size * 0.15);
                vacuole.setAttribute('class', 'vacuole');
                g.appendChild(vacuole);

                // Chloroplasts
                for (let i = 0; i < 3; i++) {
                    const chloroplast = document.createElementNS('http://www.w3.org/2000/svg', 'ellipse');
                    const angle = (i * 2 * Math.PI) / 3;
                    chloroplast.setAttribute('cx', size * 0.5 + Math.cos(angle) * size * 0.2);
                    chloroplast.setAttribute('cy', size * 0.5 + Math.sin(angle) * size * 0.2);
                    chloroplast.setAttribute('rx', size * 0.08);
                    chloroplast.setAttribute('ry', size * 0.12);
                    chloroplast.setAttribute('fill', '#22c55e');
                    chloroplast.setAttribute('stroke', '#16a34a');
                    chloroplast.setAttribute('stroke-width', '1');
                    g.appendChild(chloroplast);
                }
            }

            svg.appendChild(g);
        }

        // Initialize MathJax after page load
        window.addEventListener('load', function() {
            if (window.MathJax) {
                MathJax.typesetPromise();
            }
        });
    </script>

</body>
</html>

