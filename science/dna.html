<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­ä¸€ç§‘å­¸ï¼šDNA 3D å¯¦é©—å®¤ (Canvasç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8fafc;
            overflow-x: hidden; /* é˜²æ­¢ canvas å°è‡´æ»¾å‹•æ¢ */
        }
        canvas {
            touch-action: none; /* é˜²æ­¢æ‰‹æ©Ÿä¸Šè§¸æ§ canvas æ™‚æ»¾å‹•é é¢ */
        }
        .control-panel {
            backdrop-filter: blur(8px);
            background-color: rgba(255, 255, 255, 0.95);
        }
        /* è‡ªå®šç¾©æ»¾å‹•æ¢ */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        /* Modal å‹•ç•« */
        .modal-enter {
            opacity: 0;
            transform: scale(0.95);
        }
        .modal-enter-active {
            opacity: 1;
            transform: scale(1);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }
        .modal-exit {
            opacity: 1;
            transform: scale(1);
        }
        .modal-exit-active {
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 0.2s ease-in, transform 0.2s ease-in;
        }
    </style>
</head>
<body class="flex flex-col h-screen text-slate-800">

    <!-- é ‚éƒ¨å°èˆª -->
    <header class="bg-indigo-600 text-white shadow-lg z-20 shrink-0">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <span class="text-2xl">ğŸ§¬</span>
                <div>
                    <h1 id="app-title" class="text-xl font-bold leading-tight">DNA æ§‹é€ èˆ‡éºå‚³å¯†ç¢¼</h1>
                    <p id="app-subtitle" class="text-xs text-indigo-200">ä¸­ä¸€ç§‘å­¸äº’å‹•æ•™æ (Canvas æ¸²æŸ“)</p>
                </div>
            </div>
            
            <div class="flex items-center gap-3">
                <button onclick="openExplanation()" class="flex items-center space-x-1 bg-white/20 hover:bg-white/30 text-white px-3 py-1.5 rounded-lg transition text-sm font-bold border border-white/30">
                    <span>ğŸ“–</span>
                    <span id="btn-explain">ç§‘å­¸è§£èªª</span>
                </button>

                <!-- èªè¨€åˆ‡æ›æŒ‰éˆ• (ç§»è‡³æœ€å³æ–¹ï¼Œæ–‡å­—æ”¹ç‚º ä¸­ / EN) -->
                <button onclick="toggleLanguage()" class="flex items-center space-x-1 bg-indigo-700 hover:bg-indigo-800 text-white px-3 py-1.5 rounded-lg transition text-sm font-bold border border-indigo-500 shadow-sm">
                    <span id="lang-btn-text">ä¸­ / EN</span>
                </button>
            </div>
        </div>
    </header>

    <!-- ä¸»è¦å…§å®¹å€ï¼šå·¦å´æ§åˆ¶ï¼Œå³å´ Canvas -->
    <div class="flex flex-1 overflow-hidden relative">
        
        <!-- å·¦å´é¢æ¿ (æ‡¸æµ®æˆ–å›ºå®š) -->
        <aside class="control-panel w-full md:w-80 lg:w-96 flex flex-col border-r border-slate-200 shadow-xl z-10 overflow-y-auto absolute md:relative h-full transition-transform transform md:translate-x-0 -translate-x-full" id="sidebar">
            <div class="p-6 space-y-6">
                
                <!-- ç‹€æ…‹é¡¯ç¤º -->
                <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                    <h2 id="stats-title" class="text-sm font-bold text-indigo-800 uppercase tracking-wide mb-3">ç•¶å‰æ¨£æœ¬åˆ†æ</h2>
                    <div class="grid grid-cols-4 gap-2 text-center">
                        <div class="bg-white p-2 rounded shadow-sm border-b-2 border-red-500">
                            <div class="text-xs text-slate-500">A</div>
                            <div class="font-bold text-xl text-red-600" id="stat-a">0</div>
                        </div>
                        <div class="bg-white p-2 rounded shadow-sm border-b-2 border-blue-500">
                            <div class="text-xs text-slate-500">T</div>
                            <div class="font-bold text-xl text-blue-600" id="stat-t">0</div>
                        </div>
                        <div class="bg-white p-2 rounded shadow-sm border-b-2 border-green-500">
                            <div class="text-xs text-slate-500">C</div>
                            <div class="font-bold text-xl text-green-600" id="stat-c">0</div>
                        </div>
                        <div class="bg-white p-2 rounded shadow-sm border-b-2 border-yellow-500">
                            <div class="text-xs text-slate-500">G</div>
                            <div class="font-bold text-xl text-yellow-600" id="stat-g">0</div>
                        </div>
                    </div>
                    <div id="chargaff-rule" class="mt-3 text-xs text-indigo-600 text-center">
                        Chargaffæ³•å‰‡é©—è­‰: A â‰ˆ T, C â‰ˆ G
                    </div>
                </div>

                <!-- æ§åˆ¶æŒ‰éˆ• -->
                <div class="space-y-3">
                    <h3 id="control-title" class="font-bold text-slate-700">å¯¦é©—æ§åˆ¶</h3>
                    <button onclick="toggleAnimation()" id="btn-play" class="w-full flex items-center justify-center space-x-2 bg-slate-800 hover:bg-slate-700 text-white py-3 px-4 rounded-lg transition shadow-md active:transform active:scale-95">
                        <span>â¸ï¸</span> <span id="btn-play-text">æš«åœæ—‹è½‰</span>
                    </button>
                    
                    <button onclick="randomizeDNA()" class="w-full flex items-center justify-center space-x-2 bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 py-3 px-4 rounded-lg transition shadow-sm active:transform active:scale-95">
                        <span>ğŸ²</span> <span id="btn-random-text">éš¨æ©Ÿé‡çµ„åºåˆ— (çªè®Š)</span>
                    </button>
                    
                    <div class="pt-2">
                        <label id="speed-label" class="text-xs text-slate-500 font-bold block mb-1">æ—‹è½‰é€Ÿåº¦</label>
                        <input type="range" min="0" max="100" value="30" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600" oninput="updateSpeed(this.value)">
                    </div>
                </div>

                <!-- æ•™å­¸æŒ‡å¼• -->
                <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-200 text-sm space-y-2">
                    <h3 class="font-bold text-yellow-800 flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span id="learning-title">å­¸ç¿’é‡é»</span>
                    </h3>
                    <ul id="learning-list" class="list-disc list-inside text-yellow-900 space-y-2 ml-1">
                        <!-- Content injected via JS -->
                    </ul>
                </div>
            </div>
            
            <div class="mt-auto p-4 border-t border-slate-200 text-xs text-slate-400 text-center">
                Built with Canvas API & Tailwind CSS
            </div>
        </aside>

        <!-- æ‰‹æ©Ÿç‰ˆ Menu Toggle -->
        <button onclick="toggleSidebar()" class="md:hidden absolute top-4 left-4 z-30 bg-white p-2 rounded-full shadow-lg text-indigo-600 border border-indigo-100">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
        </button>

        <!-- Canvas å®¹å™¨ -->
        <main class="flex-1 relative bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 overflow-hidden cursor-crosshair">
            <!-- èƒŒæ™¯è£é£¾ -->
            <div class="absolute inset-0 opacity-10 pointer-events-none" style="background-image: radial-gradient(#6366f1 1px, transparent 1px); background-size: 30px 30px;"></div>
            
            <canvas id="dnaCanvas" class="block w-full h-full"></canvas>
            
            <!-- æµ®å‹•æç¤º -->
            <div id="tooltip" class="absolute pointer-events-none bg-black/80 text-white px-3 py-1 rounded text-sm opacity-0 transition-opacity transform -translate-x-1/2 -translate-y-full mb-2 z-50 whitespace-nowrap">
                Tooltip
            </div>

            <!-- Canvas å…§çš„æ“ä½œæç¤º -->
            <div id="canvas-hint" class="absolute bottom-6 left-1/2 transform -translate-x-1/2 text-white/50 text-sm font-mono pointer-events-none animate-pulse">
                é»æ“Šé¹¼åŸºå°é€²è¡Œç·¨è¼¯
            </div>
        </main>

    </div>

    <!-- è§£èªª Modal -->
    <div id="explanation-modal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <!-- èƒŒæ™¯é®ç½© -->
        <div class="absolute inset-0 bg-slate-900/75 backdrop-blur-sm transition-opacity" onclick="closeExplanation()"></div>
        
        <!-- Modal å…§å®¹ -->
        <div class="relative z-10 flex min-h-full items-center justify-center p-4">
            <div class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-2xl modal-enter" id="modal-content">
                
                <!-- æ¨™é¡Œå€ -->
                <div class="bg-indigo-600 px-6 py-4 flex justify-between items-center">
                    <h3 class="text-lg font-bold text-white flex items-center gap-2">
                        <span id="modal-title-text">ğŸ“– ç§‘å­¸æ¦‚å¿µè§£èªª</span>
                    </h3>
                    <button onclick="closeExplanation()" class="text-indigo-100 hover:text-white transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>

                <!-- å…§å®¹å€ -->
                <div class="px-6 py-6 max-h-[70vh] overflow-y-auto">
                    
                    <div class="space-y-6">
                        <!-- 1. éª¨æ¶ -->
                        <div class="flex gap-4">
                            <div class="shrink-0 w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center text-2xl">ğŸªœ</div>
                            <div>
                                <h4 id="modal-h1" class="font-bold text-lg text-slate-800">1. ç³–-ç£·é…¸éª¨æ¶ (Sugar-Phosphate Backbone)</h4>
                                <p id="modal-p1" class="text-sm text-slate-600 mt-1">
                                    åœ–ä¸­é€£æ¥æ‰€æœ‰çƒé«”çš„<strong>ç°ç™½è‰²èºæ—‹å¸¶</strong>ã€‚å®ƒç”±è„«æ°§æ ¸ç³–å’Œç£·é…¸åŸºåœ˜äº¤æ›¿é€£æ¥è€Œæˆï¼Œæä¾›çµæ§‹æ”¯æ’ã€‚
                                    <br><span class="text-slate-500 text-xs bg-slate-100 px-2 py-0.5 rounded">æ¯”å–»ï¼šæ¢¯å­çš„å…©é‚Šæ‰¶æ‰‹ã€‚</span>
                                </p>
                            </div>
                        </div>

                        <!-- 2. é¹¼åŸº -->
                        <div class="flex gap-4">
                            <div class="shrink-0 w-12 h-12 bg-green-100 rounded-full flex items-center justify-center text-2xl">ğŸ§©</div>
                            <div>
                                <h4 id="modal-h2" class="font-bold text-lg text-green-900">2. é¹¼åŸº (Bases)</h4>
                                <p id="modal-p2" class="text-sm text-slate-600 mt-1">
                                    Aã€Tã€Cã€G å››ç¨®åŒ–å­¸ç‰©è³ªã€‚å®ƒå€‘é™„è‘—åœ¨éª¨æ¶ä¸Šï¼Œå‘å…§å»¶ä¼¸ä¸¦èˆ‡å°é¢çš„é¹¼åŸºé…å°ã€‚
                                    <br><strong>è¦å‰‡ï¼š</strong> <span class="text-red-500 font-bold">A</span> â¤ï¸ <span class="text-blue-500 font-bold">T</span>ï¼Œ<span class="text-green-500 font-bold">C</span> ğŸ’š <span class="text-yellow-500 font-bold">G</span>ã€‚
                                </p>
                            </div>
                        </div>

                        <!-- 3. DNA -->
                        <div class="flex gap-4">
                            <div class="shrink-0 w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-2xl">ğŸ§¬</div>
                            <div>
                                <h4 id="modal-h3" class="font-bold text-lg text-blue-900">3. DNA (è„«æ°§æ ¸ç³–æ ¸é…¸)</h4>
                                <p id="modal-p3" class="text-sm text-slate-600 mt-1">
                                    ç”±éª¨æ¶å’Œé¹¼åŸºçµ„æˆçš„æ•´é«”ï¼Œå‘ˆ<strong>é›™èºæ—‹çµæ§‹ (Double Helix)</strong>ã€‚
                                </p>
                            </div>
                        </div>

                        <!-- 4. åŸºå›  -->
                        <div class="flex gap-4">
                            <div class="shrink-0 w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center text-2xl">ğŸ”‘</div>
                            <div>
                                <h4 id="modal-h4" class="font-bold text-lg text-yellow-900">4. åŸºå›  (Gene)</h4>
                                <p id="modal-p4" class="text-sm text-slate-600 mt-1">
                                    DNA ä¸Šçš„ä¸€æ®µç‰¹å®šåºåˆ—ï¼ˆé‡‘è‰²éƒ¨åˆ†ï¼‰ï¼Œæ±ºå®šç”Ÿç‰©ç‰¹å¾µã€‚
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8 p-4 bg-slate-50 rounded-lg border border-slate-200 text-center">
                        <p id="modal-hierarchy" class="text-sm font-bold text-slate-500 mb-2">çµæ§‹å±¤æ¬¡</p>
                        <div id="modal-flow" class="flex items-center justify-center text-sm font-mono text-slate-700 gap-2 flex-wrap">
                           <!-- Injected via JS -->
                        </div>
                    </div>
                </div>

                <!-- åº•éƒ¨æŒ‰éˆ• -->
                <div class="bg-slate-50 px-6 py-3 flex justify-end">
                    <button id="modal-close" type="button" onclick="closeExplanation()" class="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">
                        æ˜ç™½äº†ï¼
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        /**
         * å¤šèªè¨€è¨­å®š
         */
        let currentLang = 'zh';

        const TRANSLATIONS = {
            zh: {
                appTitle: "DNA æ§‹é€ èˆ‡éºå‚³å¯†ç¢¼",
                appSubtitle: "ä¸­ä¸€ç§‘å­¸äº’å‹•æ•™æ (Canvas æ¸²æŸ“)",
                btnExplain: "ç§‘å­¸è§£èªª",
                statsTitle: "ç•¶å‰æ¨£æœ¬åˆ†æ",
                chargaffRule: "Chargaffæ³•å‰‡é©—è­‰: A â‰ˆ T, C â‰ˆ G",
                controlTitle: "å¯¦é©—æ§åˆ¶",
                btnPause: "â¸ï¸ æš«åœæ—‹è½‰",
                btnResume: "â–¶ï¸ ç¹¼çºŒæ—‹è½‰",
                btnRandom: "ğŸ² éš¨æ©Ÿé‡çµ„åºåˆ— (çªè®Š)",
                speedLabel: "æ—‹è½‰é€Ÿåº¦",
                learningTitle: "å­¸ç¿’é‡é»",
                learningList: [
                    "<strong>ç³–-ç£·é…¸éª¨æ¶</strong>ï¼šå°±åƒæ¢¯å­çš„å…©é‚Šæ‰¶æ‰‹ï¼ˆåœ–ä¸­ç°ç™½è‰²çš„å¸¶å­ï¼‰ï¼Œè² è²¬æ”¯æ’æ•´å€‹çµæ§‹ã€‚",
                    "<strong>é¹¼åŸºå°</strong>ï¼šåƒæ˜¯æ¢¯å­çš„æ©«éšï¼ŒA é… Tï¼ŒC é… Gã€‚",
                    "<strong>åŸºå› </strong>ï¼šé‡‘è‰²æ¨™è¨˜çš„ç‰¹å®šç‰‡æ®µã€‚"
                ],
                canvasHint: "é»æ“Šé¹¼åŸºå°é€²è¡Œç·¨è¼¯",
                geneLabel: "ğŸ§¬ åŸºå› ç‰‡æ®µ (Gene)",
                geneDesc: "æ±ºå®šç‰¹å¾µçš„åºåˆ—",
                
                // Bases Names
                baseA: "è…ºå˜Œå‘¤ (A)",
                baseT: "èƒ¸è…ºå˜§å•¶ (T)",
                baseC: "èƒå˜§å•¶ (C)",
                baseG: "é³¥å˜Œå‘¤ (G)",

                // Modal
                modalTitle: "ğŸ“– ç§‘å­¸æ¦‚å¿µè§£èªª",
                modalH1: "1. ç³–-ç£·é…¸éª¨æ¶ (Sugar-Phosphate Backbone)",
                modalP1: "åœ–ä¸­é€£æ¥æ‰€æœ‰çƒé«”çš„<strong>ç°ç™½è‰²èºæ—‹å¸¶</strong>ã€‚å®ƒç”±è„«æ°§æ ¸ç³–å’Œç£·é…¸åŸºåœ˜äº¤æ›¿é€£æ¥è€Œæˆï¼Œæä¾›çµæ§‹æ”¯æ’ã€‚<br><span class='text-slate-500 text-xs bg-slate-100 px-2 py-0.5 rounded'>æ¯”å–»ï¼šæ¢¯å­çš„å…©é‚Šæ‰¶æ‰‹ã€‚</span>",
                modalH2: "2. é¹¼åŸº (Bases)",
                modalP2: "Aã€Tã€Cã€G å››ç¨®åŒ–å­¸ç‰©è³ªã€‚å®ƒå€‘é™„è‘—åœ¨éª¨æ¶ä¸Šï¼Œå‘å…§å»¶ä¼¸ä¸¦èˆ‡å°é¢çš„é¹¼åŸºé…å°ã€‚<br><strong>è¦å‰‡ï¼š</strong> <span class='text-red-500 font-bold'>A</span> â¤ï¸ <span class='text-blue-500 font-bold'>T</span>ï¼Œ<span class='text-green-500 font-bold'>C</span> ğŸ’š <span class='text-yellow-500 font-bold'>G</span>ã€‚",
                modalH3: "3. DNA (è„«æ°§æ ¸ç³–æ ¸é…¸)",
                modalP3: "ç”±éª¨æ¶å’Œé¹¼åŸºçµ„æˆçš„æ•´é«”ï¼Œå‘ˆ<strong>é›™èºæ—‹çµæ§‹ (Double Helix)</strong>ã€‚",
                modalH4: "4. åŸºå›  (Gene)",
                modalP4: "DNA ä¸Šçš„ä¸€æ®µç‰¹å®šåºåˆ—ï¼ˆé‡‘è‰²éƒ¨åˆ†ï¼‰ï¼Œæ±ºå®šç”Ÿç‰©ç‰¹å¾µã€‚",
                modalHierarchy: "çµæ§‹å±¤æ¬¡",
                modalFlow: `
                    <span class="bg-white px-3 py-1 rounded shadow-sm border">ç´°èƒ</span>
                    <span>â†’</span>
                    <span class="bg-white px-3 py-1 rounded shadow-sm border">ç´°èƒæ ¸</span>
                    <span>â†’</span>
                    <span class="bg-white px-3 py-1 rounded shadow-sm border">æŸ“è‰²é«”</span>
                    <span>â†’</span>
                    <span class="bg-white px-3 py-1 rounded shadow-sm border ring-2 ring-indigo-400">DNA</span>
                `,
                modalClose: "æ˜ç™½äº†ï¼"
            },
            en: {
                appTitle: "DNA Structure & Genetic Code",
                appSubtitle: "S1 Science Interactive (Canvas)",
                btnExplain: "Explanation",
                statsTitle: "Sample Analysis",
                chargaffRule: "Chargaff's Rule: A â‰ˆ T, C â‰ˆ G",
                controlTitle: "Controls",
                btnPause: "â¸ï¸ Pause Rotation",
                btnResume: "â–¶ï¸ Resume Rotation",
                btnRandom: "ğŸ² Randomize (Mutate)",
                speedLabel: "Rotation Speed",
                learningTitle: "Key Concepts",
                learningList: [
                    "<strong>Sugar-Phosphate Backbone</strong>: Acts like the handrails of a ladder (grey ribbons), supporting the structure.",
                    "<strong>Base Pairs</strong>: Act like the rungs of the ladder. A pairs with T, C pairs with G.",
                    "<strong>Gene</strong>: The gold-highlighted specific segment."
                ],
                canvasHint: "Click base pairs to edit",
                geneLabel: "ğŸ§¬ Gene Segment",
                geneDesc: "Sequence determining traits",
                
                // Bases Names
                baseA: "Adenine (A)",
                baseT: "Thymine (T)",
                baseC: "Cytosine (C)",
                baseG: "Guanine (G)",

                // Modal
                modalTitle: "ğŸ“– Scientific Explanation",
                modalH1: "1. Sugar-Phosphate Backbone",
                modalP1: "The <strong>grey-white spiral ribbons</strong> connecting all spheres. It consists of alternating sugar and phosphate groups, providing structural support.<br><span class='text-slate-500 text-xs bg-slate-100 px-2 py-0.5 rounded'>Analogy: The handrails of a ladder.</span>",
                modalH2: "2. Bases",
                modalP2: "Four types of chemicals: A, T, C, G. They attach to the backbone and pair with the base opposite them.<br><strong>Rule:</strong> <span class='text-red-500 font-bold'>A</span> â¤ï¸ <span class='text-blue-500 font-bold'>T</span>, <span class='text-green-500 font-bold'>C</span> ğŸ’š <span class='text-yellow-500 font-bold'>G</span>.",
                modalH3: "3. DNA (Deoxyribonucleic Acid)",
                modalP3: "The entire molecule consisting of the backbone and bases, forming a <strong>Double Helix</strong> structure.",
                modalH4: "4. Gene",
                modalP4: "A specific sequence on the DNA (gold section) that determines biological traits.",
                modalHierarchy: "Structural Hierarchy",
                modalFlow: `
                    <span class="bg-white px-3 py-1 rounded shadow-sm border">Cell</span>
                    <span>â†’</span>
                    <span class="bg-white px-3 py-1 rounded shadow-sm border">Nucleus</span>
                    <span>â†’</span>
                    <span class="bg-white px-3 py-1 rounded shadow-sm border">Chromosome</span>
                    <span>â†’</span>
                    <span class="bg-white px-3 py-1 rounded shadow-sm border ring-2 ring-indigo-400">DNA</span>
                `,
                modalClose: "Got it!"
            }
        };

        function toggleLanguage() {
            currentLang = currentLang === 'zh' ? 'en' : 'zh';
            // Button text stays static as per request
            updateTextContent();
            updateBasesNames();
        }

        function updateTextContent() {
            const t = TRANSLATIONS[currentLang];
            
            // Header
            document.getElementById('app-title').innerText = t.appTitle;
            document.getElementById('app-subtitle').innerText = t.appSubtitle;
            document.getElementById('btn-explain').innerText = t.btnExplain;
            
            // Sidebar
            document.getElementById('stats-title').innerText = t.statsTitle;
            document.getElementById('chargaff-rule').innerText = t.chargaffRule;
            document.getElementById('control-title').innerText = t.controlTitle;
            // Note: Button text logic handles Pause/Resume state separately
            updatePlayButtonText();
            document.getElementById('btn-random-text').innerText = t.btnRandom;
            document.getElementById('speed-label').innerText = t.speedLabel;
            document.getElementById('learning-title').innerText = t.learningTitle;
            document.getElementById('canvas-hint').innerText = t.canvasHint;
            
            // Learning List
            const list = document.getElementById('learning-list');
            list.innerHTML = '';
            t.learningList.forEach(item => {
                const li = document.createElement('li');
                li.innerHTML = item;
                list.appendChild(li);
            });

            // Modal
            document.getElementById('modal-title-text').innerText = t.modalTitle;
            document.getElementById('modal-h1').innerText = t.modalH1;
            document.getElementById('modal-p1').innerHTML = t.modalP1;
            document.getElementById('modal-h2').innerText = t.modalH2;
            document.getElementById('modal-p2').innerHTML = t.modalP2;
            document.getElementById('modal-h3').innerText = t.modalH3;
            document.getElementById('modal-p3').innerHTML = t.modalP3;
            document.getElementById('modal-h4').innerText = t.modalH4;
            document.getElementById('modal-p4').innerHTML = t.modalP4;
            document.getElementById('modal-hierarchy').innerText = t.modalHierarchy;
            document.getElementById('modal-flow').innerHTML = t.modalFlow;
            document.getElementById('modal-close').innerText = t.modalClose;
        }

        function updatePlayButtonText() {
            const t = TRANSLATIONS[currentLang];
            const btnText = document.getElementById('btn-play-text');
            if (isPlaying) {
                btnText.innerText = t.btnPause.replace('â¸ï¸ ', '');
            } else {
                btnText.innerText = t.btnResume.replace('â–¶ï¸ ', '');
            }
        }

        /**
         * éºå‚³å­¸è³‡æ–™èˆ‡é‚è¼¯
         */
        const BASES = {
            'A': { id: 'baseA', color: '#ef4444', pair: 'T' }, 
            'T': { id: 'baseT', color: '#3b82f6', pair: 'A' }, 
            'C': { id: 'baseC', color: '#22c55e', pair: 'G' }, 
            'G': { id: 'baseG', color: '#eab308', pair: 'C' }  
        };
        
        // Helper to get name
        function getBaseName(key) {
            return TRANSLATIONS[currentLang][BASES[key].id];
        }
        
        function updateBasesNames() {
            // This function is purely to trigger any re-renders if needed, 
            // but since getBaseName is called dynamically in draw/tooltip, 
            // we mainly just need to ensure the logic uses getBaseName.
        }

        const NUM_PAIRS = 20;
        // å®šç¾©åŸºå› ç‰‡æ®µç¯„åœ (ç´¢å¼• 5 åˆ° 10)
        const GENE_START_INDEX = 5;
        const GENE_LENGTH = 6;
        
        let dnaSequence = [];

        // åˆå§‹åŒ–éš¨æ©Ÿ DNA åºåˆ—
        function initSequence() {
            dnaSequence = [];
            const keys = ['A', 'T', 'C', 'G'];
            for(let i = 0; i < NUM_PAIRS; i++) {
                const leftBase = keys[Math.floor(Math.random() * keys.length)];
                dnaSequence.push({
                    id: i,
                    left: leftBase,
                    right: BASES[leftBase].pair
                });
            }
            updateStats();
        }

        // çªè®Šï¼ˆæ”¹è®Šï¼‰æŸä¸€è¡Œçš„é¹¼åŸº
        function mutateRow(index) {
            const currentLeft = dnaSequence[index].left;
            let nextLeft;
            // å¾ªç’°é †åº A -> T -> C -> G -> A
            if (currentLeft === 'A') nextLeft = 'T';
            else if (currentLeft === 'T') nextLeft = 'C';
            else if (currentLeft === 'C') nextLeft = 'G';
            else nextLeft = 'A';

            dnaSequence[index].left = nextLeft;
            dnaSequence[index].right = BASES[nextLeft].pair;
            
            // è§¸ç™¼è¦–è¦ºç‰¹æ•ˆï¼ˆä¾‹å¦‚é–ƒå…‰ï¼Œé€™è£¡é€éæ¨™è¨˜è®“ Canvas è™•ç†ï¼‰
            visualEffects.push({
                type: 'flash',
                index: index,
                life: 1.0
            });
            
            updateStats();
        }

        function updateStats() {
            const counts = { A: 0, T: 0, C: 0, G: 0 };
            dnaSequence.forEach(row => {
                counts[row.left]++;
                counts[row.right]++;
            });
            document.getElementById('stat-a').innerText = counts.A;
            document.getElementById('stat-t').innerText = counts.T;
            document.getElementById('stat-c').innerText = counts.C;
            document.getElementById('stat-g').innerText = counts.G;
        }

        /**
         * Canvas æ¸²æŸ“å¼•æ“
         */
        const canvas = document.getElementById('dnaCanvas');
        const ctx = canvas.getContext('2d');
        const tooltip = document.getElementById('tooltip');
        
        // è¦–è¦ºåƒæ•¸
        let rotation = 0;
        let rotationSpeed = 0.02;
        let isPlaying = true;
        let visualEffects = []; // å­˜å„²ç‰¹æ•ˆç‰©ä»¶
        
        // éŸ¿æ‡‰å¼å°ºå¯¸
        let width, height;
        let scaleFactor = 1;

        function resize() {
            const parent = canvas.parentElement;
            width = parent.clientWidth;
            height = parent.clientHeight;
            
            // è™•ç†é«˜è§£æåº¦è¢å¹• (Retina)
            const dpr = window.devicePixelRatio || 1;
            canvas.width = width * dpr;
            canvas.height = height * dpr;
            ctx.scale(dpr, dpr);
            
            // èª¿æ•´å…§å®¹ç¸®æ”¾
            scaleFactor = Math.min(width, height) / 600; 
        }
        window.addEventListener('resize', resize);
        resize();

        // äº’å‹•æª¢æ¸¬ç›¸é—œè®Šæ•¸
        let mouseX = 0;
        let mouseY = 0;
        let hoveredRowIndex = -1;

        canvas.addEventListener('mousemove', e => {
            const rect = canvas.getBoundingClientRect();
            mouseX = e.clientX - rect.left;
            mouseY = e.clientY - rect.top;
            
            // æ›´æ–° Tooltip ä½ç½®
            if (hoveredRowIndex !== -1) {
                tooltip.style.left = (e.clientX) + 'px';
                tooltip.style.top = (e.clientY) + 'px';
                tooltip.style.opacity = 1;
                
                const row = dnaSequence[hoveredRowIndex];
                
                // å‹•æ…‹ç²å–åç¨± (i18n)
                const leftName = getBaseName(row.left);
                const rightName = getBaseName(row.right);

                tooltip.innerHTML = `
                    <div class="flex flex-col gap-1">
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 rounded-full" style="background:${BASES[row.left].color}"></span> 
                            <span>${leftName}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 rounded-full" style="background:${BASES[row.right].color}"></span> 
                            <span>${rightName}</span>
                        </div>
                    </div>
                `;
            } else {
                tooltip.style.opacity = 0;
            }
        });

        canvas.addEventListener('click', () => {
            if (hoveredRowIndex !== -1) {
                mutateRow(hoveredRowIndex);
            }
        });

        canvas.addEventListener('mouseleave', () => {
            hoveredRowIndex = -1;
            tooltip.style.opacity = 0;
        });

        // 3D æŠ•å½±å¹«åŠ©å‡½æ•¸
        function project(x, y, z) {
            // ç°¡å–®çš„é€è¦–æŠ•å½±
            // å‡è¨­ç›¸æ©Ÿåœ¨ z = -500 çš„ä½ç½®
            const perspective = 400 / (400 + z);
            const x2d = x * perspective + width / 2;
            const y2d = y * perspective + height / 2;
            const scale = perspective * scaleFactor;
            return { x: x2d, y: y2d, scale: scale, zIndex: z };
        }

        // ä¸»æ¸²æŸ“å¾ªç’°
        function draw() {
            // æ¸…ç©ºç•«å¸ƒ
            ctx.clearRect(0, 0, width, height);

            if (isPlaying) {
                rotation += rotationSpeed;
            }

            // æº–å‚™ç¹ªè£½åˆ—è¡¨ (ç‚ºäº†æ­£ç¢ºè™•ç†å‰å¾Œé®æ“‹é—œä¿‚ - Z-buffer æ’åº)
            const drawList = [];
            const helixRadius = 100;
            const rowHeight = 35;
            const totalHeight = NUM_PAIRS * rowHeight;
            const startY = -totalHeight / 2;
            
            // 1. å…ˆè¨ˆç®—æ‰€æœ‰é»çš„åº§æ¨™ï¼Œæ–¹ä¾¿ç”Ÿæˆéª¨æ¶é€£ç·š
            const points = [];
            for (let i = 0; i < NUM_PAIRS; i++) {
                const yBase = startY + i * rowHeight;
                const angle = i * 0.5 + rotation;
                
                // Strand 1 (Left)
                const x1 = Math.sin(angle) * helixRadius;
                const z1 = Math.cos(angle) * helixRadius;
                
                // Strand 2 (Right) - 180åº¦å°è§’
                const x2 = Math.sin(angle + Math.PI) * helixRadius;
                const z2 = Math.cos(angle + Math.PI) * helixRadius;

                points.push({
                    i: i,
                    row: dnaSequence[i],
                    s1: { x: x1, y: yBase, z: z1, p: project(x1, yBase, z1) },
                    s2: { x: x2, y: yBase, z: z2, p: project(x2, yBase, z2) }
                });
            }
            
            // åŸºå› æ¨™è¨˜åº§æ¨™ (ç”¨æ–¼ç¹ªè£½æ‹¬è™Ÿ)
            let geneYStart = 0;
            let geneYEnd = 0;

            // 2. ç”Ÿæˆç¹ªè£½ç‰©ä»¶
            points.forEach((curr, idx) => {
                const isHighlight = (idx === hoveredRowIndex);
                const isGene = idx >= GENE_START_INDEX && idx < GENE_START_INDEX + GENE_LENGTH;

                // è¨˜éŒ„åŸºå› åº§æ¨™
                const pCenter = project(0, curr.s1.y, 0); // ä¸­å¿ƒè»¸
                if (idx === GENE_START_INDEX) geneYStart = pCenter.y;
                if (idx === GENE_START_INDEX + GENE_LENGTH - 1) geneYEnd = pCenter.y;

                // --- æ©«å‘é€£æ¥ (Hydrogen Bond) ---
                drawList.push({
                    type: 'bond',
                    z: (curr.s1.z + curr.s2.z) / 2,
                    p1: curr.s1.p,
                    p2: curr.s2.p,
                    color: isGene ? '#fcd34d' : '#94a3b8',
                    isGene: isGene,
                    isHighlight: isHighlight
                });

                // --- é¹¼åŸºçƒé«” (Nucleotides) ---
                drawList.push({
                    type: 'nucleotide',
                    base: curr.row.left,
                    z: curr.s1.z,
                    p: curr.s1.p,
                    color: BASES[curr.row.left].color,
                    isHighlight: isHighlight
                });
                drawList.push({
                    type: 'nucleotide',
                    base: curr.row.right,
                    z: curr.s2.z,
                    p: curr.s2.p,
                    color: BASES[curr.row.right].color,
                    isHighlight: isHighlight
                });

                // --- éª¨æ¶é€£æ¥ (Backbone) ---
                // é€£æ¥ç•¶å‰å±¤åˆ°ä¸‹ä¸€å±¤
                if (idx < points.length - 1) {
                    const next = points[idx + 1];
                    
                    // Strand 1 Backbone Segment
                    drawList.push({
                        type: 'backbone',
                        z: (curr.s1.z + next.s1.z) / 2, // å¹³å‡æ·±åº¦
                        p1: curr.s1.p,
                        p2: next.s1.p,
                        color: '#cbd5e1' // æ·ºç°è—è‰²
                    });

                    // Strand 2 Backbone Segment
                    drawList.push({
                        type: 'backbone',
                        z: (curr.s2.z + next.s2.z) / 2,
                        p1: curr.s2.p,
                        p2: next.s2.p,
                        color: '#cbd5e1'
                    });
                }
            });

            // 3. æ’åºï¼šZ å€¼è¶Šå¤§è¡¨ç¤ºè¶Šæ·±(é ) é‚„æ˜¯ è¶Šæ·º(è¿‘)?
            drawList.sort((a, b) => b.z - a.z);

            // 4. ç¹ªè£½å¾ªç’°
            drawList.forEach(item => {
                
                ctx.globalAlpha = 1;
                // é€šç”¨ï¼šæ ¹æ“šæ·±åº¦è¨ˆç®—äº®åº¦ (æ¨¡æ“¬è¿·éœ§)
                let itemScale = item.p ? item.p.scale : (item.p1.scale + item.p2.scale) / 2;
                const brightness = Math.max(0.4, Math.min(1, itemScale * 1.5));

                if (item.type === 'backbone') {
                    // ç¹ªè£½éª¨æ¶ç·å¸¶
                    ctx.beginPath();
                    ctx.moveTo(item.p1.x, item.p1.y);
                    ctx.lineTo(item.p2.x, item.p2.y);
                    
                    // éª¨æ¶å¯¬åº¦éš¨æ·±åº¦è®ŠåŒ–ï¼Œè¿‘å¤§é å°
                    ctx.lineWidth = 10 * itemScale; 
                    ctx.strokeStyle = item.color;
                    ctx.lineCap = 'round'; // åœ“æ»‘æ¥é ­
                    
                    ctx.globalAlpha = brightness; 
                    ctx.stroke();
                    ctx.globalAlpha = 1;
                    ctx.lineCap = 'butt'; // é‚„åŸ

                } else if (item.type === 'bond') {
                    
                    ctx.beginPath();
                    ctx.moveTo(item.p1.x, item.p1.y);
                    ctx.lineTo(item.p2.x, item.p2.y);
                    
                    if (item.isGene && !item.isHighlight) {
                        ctx.shadowBlur = 10;
                        ctx.shadowColor = '#fcd34d';
                    } else {
                        ctx.shadowBlur = 0;
                    }

                    ctx.strokeStyle = item.isHighlight ? '#fbbf24' : (item.isGene ? '#fcd34d' : `rgba(148, 163, 184, ${brightness})`);
                    ctx.lineWidth = item.isHighlight ? 6 * itemScale : 3 * itemScale;
                    ctx.stroke();
                    ctx.shadowBlur = 0;

                } else if (item.type === 'nucleotide') {
                    const r = (item.isHighlight ? 18 : 14) * item.p.scale;
                    
                    ctx.beginPath();
                    ctx.arc(item.p.x, item.p.y, r, 0, Math.PI * 2);
                    
                    const grad = ctx.createRadialGradient(
                        item.p.x - r/3, item.p.y - r/3, r/10,
                        item.p.x, item.p.y, r
                    );
                    
                    const baseColor = item.color;
                    grad.addColorStop(0, adjustBrightness(baseColor, 40)); 
                    grad.addColorStop(1, adjustBrightness(baseColor, -20)); 
                    
                    ctx.fillStyle = grad;
                    
                    if (item.isHighlight) {
                        ctx.strokeStyle = '#fff';
                        ctx.lineWidth = 2;
                        ctx.stroke();
                    }
                    
                    ctx.fill();

                    // æ–‡å­—
                    ctx.fillStyle = '#fff';
                    ctx.font = `bold ${12 * item.p.scale}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.globalAlpha = brightness; // æ–‡å­—éš¨æ·±åº¦è®Šæš—
                    ctx.fillText(item.base, item.p.x, item.p.y);
                    ctx.globalAlpha = 1;
                }
            });

            // ç¹ªè£½ã€ŒåŸºå› ã€æ¨™è¨˜æ‹¬è™Ÿ
            if (geneYStart && geneYEnd) {
                const bracketX = width / 2 + 140 * scaleFactor;
                const bracketTop = geneYStart - 10 * scaleFactor;
                const bracketBottom = geneYEnd + 10 * scaleFactor;
                const bracketWidth = 10 * scaleFactor;

                ctx.beginPath();
                ctx.strokeStyle = '#fcd34d'; // Gold
                ctx.lineWidth = 3;
                ctx.moveTo(bracketX, bracketTop);
                ctx.lineTo(bracketX + bracketWidth, bracketTop);
                ctx.lineTo(bracketX + bracketWidth, bracketBottom);
                ctx.lineTo(bracketX, bracketBottom);
                ctx.stroke();

                ctx.fillStyle = '#f59e0b';
                ctx.font = `bold ${14 * scaleFactor}px sans-serif`;
                ctx.textAlign = 'left';
                ctx.textBaseline = 'middle';
                
                // å‹•æ…‹ç²å–åŸºå› æ–‡å­—
                const t = TRANSLATIONS[currentLang];
                ctx.fillText(t.geneLabel, bracketX + bracketWidth + 10, (bracketTop + bracketBottom) / 2);
                
                ctx.fillStyle = '#94a3b8';
                ctx.font = `${10 * scaleFactor}px sans-serif`;
                ctx.fillText(t.geneDesc, bracketX + bracketWidth + 10, (bracketTop + bracketBottom) / 2 + 16 * scaleFactor);
            }
            
            // ç¹ªè£½ç‰¹æ•ˆ
            visualEffects = visualEffects.filter(fx => fx.life > 0);
            visualEffects.forEach(fx => {
                fx.life -= 0.05;
                const yBase = startY + fx.index * rowHeight;
                const p = project(0, yBase, 0); 
                
                ctx.beginPath();
                const radius = Math.max(0, 100 * (2.5 - fx.life));
                ctx.arc(p.x, p.y, radius, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(255, 255, 255, ${fx.life * 0.5})`;
                ctx.fill();
            });

            // Hit Detection æ›´æ–°
            updateHoverDetection(startY, rowHeight, helixRadius);

            requestAnimationFrame(draw);
        }

        // åˆ†é›¢å‡ºçš„æª¢æ¸¬é‚è¼¯
        function updateHoverDetection(startY, rowHeight, helixRadius) {
            let minDistance = 1000;
            let targetIndex = -1;

            dnaSequence.forEach((row, i) => {
                const yBase = startY + i * rowHeight;
                const pCenter = project(0, yBase, 0);
                const dy = Math.abs(mouseY - pCenter.y);
                const dx = Math.abs(mouseX - pCenter.x);
                
                if (dy < 15 * pCenter.scale && dx < 120 * pCenter.scale) {
                    const dist = Math.hypot(dx, dy);
                    if (dist < minDistance) {
                        minDistance = dist;
                        targetIndex = i;
                    }
                }
            });

            hoveredRowIndex = targetIndex;
            canvas.style.cursor = (hoveredRowIndex !== -1) ? 'pointer' : 'default';
        }

        // é¡è‰²äº®åº¦èª¿æ•´å·¥å…·
        function adjustBrightness(hex, percent) {
            let r = parseInt(hex.substring(1, 3), 16);
            let g = parseInt(hex.substring(3, 5), 16);
            let b = parseInt(hex.substring(5, 7), 16);

            r = Math.min(255, Math.max(0, r + percent));
            g = Math.min(255, Math.max(0, g + percent));
            b = Math.min(255, Math.max(0, b + percent));

            const rr = ((r.toString(16).length === 1) ? "0" + r.toString(16) : r.toString(16));
            const gg = ((g.toString(16).length === 1) ? "0" + g.toString(16) : g.toString(16));
            const bb = ((b.toString(16).length === 1) ? "0" + b.toString(16) : b.toString(16));

            return "#" + rr + gg + bb;
        }

        // UI äº¤äº’åŠŸèƒ½
        function toggleAnimation() {
            isPlaying = !isPlaying;
            const btn = document.getElementById('btn-play');
            const iconSpan = btn.querySelector('span:first-child');
            
            if (isPlaying) {
                iconSpan.innerText = 'â¸ï¸';
                btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                btn.classList.add('bg-slate-800', 'hover:bg-slate-700');
            } else {
                iconSpan.innerText = 'â–¶ï¸';
                btn.classList.remove('bg-slate-800', 'hover:bg-slate-700');
                btn.classList.add('bg-green-600', 'hover:bg-green-700');
            }
            updatePlayButtonText();
        }

        function randomizeDNA() {
            visualEffects.push({ index: Math.floor(NUM_PAIRS/2), life: 2.0, type: 'flash' });
            initSequence();
            updateStats();
        }

        function updateSpeed(val) {
            rotationSpeed = val / 1500;
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
            } else {
                sidebar.classList.add('-translate-x-full');
            }
        }

        // Modal æ§åˆ¶é‚è¼¯
        function openExplanation() {
            const modal = document.getElementById('explanation-modal');
            const content = document.getElementById('modal-content');
            modal.classList.remove('hidden');
            content.classList.remove('modal-exit', 'modal-exit-active');
            content.classList.add('modal-enter-active');
        }

        function closeExplanation() {
            const modal = document.getElementById('explanation-modal');
            const content = document.getElementById('modal-content');
            content.classList.remove('modal-enter', 'modal-enter-active');
            content.classList.add('modal-exit-active');
            setTimeout(() => {
                modal.classList.add('hidden');
                content.classList.remove('modal-exit-active');
            }, 200);
        }

        // å•Ÿå‹•ï¼Œå…ˆè¼‰å…¥é è¨­èªè¨€å…§å®¹
        updateTextContent();
        initSequence();
        draw();

    </script>
</body>
</html>