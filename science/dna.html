<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­ä¸€ç§‘å­¸ï¼šDNA 3D å¯¦é©—å®¤ (Canvasç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8fafc;
            overflow-x: hidden; /* é˜²æ­¢ canvas å°è‡´æ»¾å‹•æ¢ */
        }
        canvas {
            touch-action: none; /* é˜²æ­¢æ‰‹æ©Ÿä¸Šè§¸æ§ canvas æ™‚æ»¾å‹•é é¢ */
        }
        .control-panel {
            backdrop-filter: blur(8px);
            background-color: rgba(255, 255, 255, 0.95);
        }
        /* è‡ªå®šç¾©æ»¾å‹•æ¢ */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        /* Modal å‹•ç•« */
        .modal-enter {
            opacity: 0;
            transform: scale(0.95);
        }
        .modal-enter-active {
            opacity: 1;
            transform: scale(1);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }
        .modal-exit {
            opacity: 1;
            transform: scale(1);
        }
        .modal-exit-active {
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 0.2s ease-in, transform 0.2s ease-in;
        }
    </style>
</head>
<body class="flex flex-col h-screen text-slate-800">

    <!-- é ‚éƒ¨å°èˆª -->
    <header class="bg-indigo-600 text-white shadow-lg z-20 shrink-0">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <span class="text-2xl">ğŸ§¬</span>
                <div>
                    <h1 class="text-xl font-bold leading-tight">DNA æ§‹é€ èˆ‡éºå‚³å¯†ç¢¼</h1>
                    <p class="text-xs text-indigo-200">ä¸­ä¸€ç§‘å­¸äº’å‹•æ•™æ (Canvas æ¸²æŸ“)</p>
                </div>
            </div>
            
            <div class="flex items-center gap-3">
                <button onclick="openExplanation()" class="flex items-center space-x-1 bg-white/20 hover:bg-white/30 text-white px-3 py-1.5 rounded-lg transition text-sm font-bold border border-white/30">
                    <span>ğŸ“–</span>
                    <span>ç§‘å­¸è§£èªª</span>
                </button>
                <div class="hidden md:block text-xs bg-indigo-800/50 px-3 py-1 rounded-full border border-indigo-400/30">
                    S1 Science
                </div>
            </div>
        </div>
    </header>

    <!-- ä¸»è¦å…§å®¹å€ï¼šå·¦å´æ§åˆ¶ï¼Œå³å´ Canvas -->
    <div class="flex flex-1 overflow-hidden relative">
        
        <!-- å·¦å´é¢æ¿ (æ‡¸æµ®æˆ–å›ºå®š) -->
        <aside class="control-panel w-full md:w-80 lg:w-96 flex flex-col border-r border-slate-200 shadow-xl z-10 overflow-y-auto absolute md:relative h-full transition-transform transform md:translate-x-0 -translate-x-full" id="sidebar">
            <div class="p-6 space-y-6">
                
                <!-- ç‹€æ…‹é¡¯ç¤º -->
                <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                    <h2 class="text-sm font-bold text-indigo-800 uppercase tracking-wide mb-3">ç•¶å‰æ¨£æœ¬åˆ†æ</h2>
                    <div class="grid grid-cols-4 gap-2 text-center">
                        <div class="bg-white p-2 rounded shadow-sm border-b-2 border-red-500">
                            <div class="text-xs text-slate-500">A</div>
                            <div class="font-bold text-xl text-red-600" id="stat-a">0</div>
                        </div>
                        <div class="bg-white p-2 rounded shadow-sm border-b-2 border-blue-500">
                            <div class="text-xs text-slate-500">T</div>
                            <div class="font-bold text-xl text-blue-600" id="stat-t">0</div>
                        </div>
                        <div class="bg-white p-2 rounded shadow-sm border-b-2 border-green-500">
                            <div class="text-xs text-slate-500">C</div>
                            <div class="font-bold text-xl text-green-600" id="stat-c">0</div>
                        </div>
                        <div class="bg-white p-2 rounded shadow-sm border-b-2 border-yellow-500">
                            <div class="text-xs text-slate-500">G</div>
                            <div class="font-bold text-xl text-yellow-600" id="stat-g">0</div>
                        </div>
                    </div>
                    <div class="mt-3 text-xs text-indigo-600 text-center">
                        Chargaffæ³•å‰‡é©—è­‰: A â‰ˆ T, C â‰ˆ G
                    </div>
                </div>

                <!-- æ§åˆ¶æŒ‰éˆ• -->
                <div class="space-y-3">
                    <h3 class="font-bold text-slate-700">å¯¦é©—æ§åˆ¶</h3>
                    <button onclick="toggleAnimation()" id="btn-play" class="w-full flex items-center justify-center space-x-2 bg-slate-800 hover:bg-slate-700 text-white py-3 px-4 rounded-lg transition shadow-md active:transform active:scale-95">
                        <span>â¸ï¸</span> <span>æš«åœæ—‹è½‰</span>
                    </button>
                    
                    <button onclick="randomizeDNA()" class="w-full flex items-center justify-center space-x-2 bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 py-3 px-4 rounded-lg transition shadow-sm active:transform active:scale-95">
                        <span>ğŸ²</span> <span>éš¨æ©Ÿé‡çµ„åºåˆ— (çªè®Š)</span>
                    </button>
                    
                    <div class="pt-2">
                        <label class="text-xs text-slate-500 font-bold block mb-1">æ—‹è½‰é€Ÿåº¦</label>
                        <input type="range" min="0" max="100" value="30" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600" oninput="updateSpeed(this.value)">
                    </div>
                </div>

                <!-- æ•™å­¸æŒ‡å¼• -->
                <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-200 text-sm space-y-2">
                    <h3 class="font-bold text-yellow-800 flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        å­¸ç¿’é‡é»
                    </h3>
                    <ul class="list-disc list-inside text-yellow-900 space-y-2 ml-1">
                        <li><strong>åŸºå›  (Gene)</strong>ï¼šDNA ä¸Šçš„ä¸€æ®µç‰¹å®šåºåˆ—ï¼ˆå¦‚åœ–ä¸­é‡‘è‰²æ¨™è¨˜éƒ¨åˆ†ï¼‰ï¼Œå®ƒæ±ºå®šäº†ç”Ÿç‰©çš„ç‰¹å¾µï¼ˆä¾‹å¦‚å–®çœ¼çš®æˆ–é›™çœ¼çš®ï¼‰ã€‚</li>
                        <li><strong>é¹¼åŸºé…å°</strong>ï¼šA åªèƒ½é… Tï¼ŒC åªèƒ½é… Gã€‚</li>
                        <li><strong>é›™èºæ—‹</strong>ï¼šå…©æ¢é•·éˆåƒèºæ—‹æ¢¯ä¸€æ¨£çºç¹ã€‚</li>
                    </ul>
                </div>
            </div>
            
            <div class="mt-auto p-4 border-t border-slate-200 text-xs text-slate-400 text-center">
                Built with Canvas API & Tailwind CSS
            </div>
        </aside>

        <!-- æ‰‹æ©Ÿç‰ˆ Menu Toggle -->
        <button onclick="toggleSidebar()" class="md:hidden absolute top-4 left-4 z-30 bg-white p-2 rounded-full shadow-lg text-indigo-600 border border-indigo-100">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
        </button>

        <!-- Canvas å®¹å™¨ -->
        <main class="flex-1 relative bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 overflow-hidden cursor-crosshair">
            <!-- èƒŒæ™¯è£é£¾ -->
            <div class="absolute inset-0 opacity-10 pointer-events-none" style="background-image: radial-gradient(#6366f1 1px, transparent 1px); background-size: 30px 30px;"></div>
            
            <canvas id="dnaCanvas" class="block w-full h-full"></canvas>
            
            <!-- æµ®å‹•æç¤º -->
            <div id="tooltip" class="absolute pointer-events-none bg-black/80 text-white px-3 py-1 rounded text-sm opacity-0 transition-opacity transform -translate-x-1/2 -translate-y-full mb-2 z-50 whitespace-nowrap">
                Tooltip
            </div>

            <!-- Canvas å…§çš„æ“ä½œæç¤º -->
            <div class="absolute bottom-6 left-1/2 transform -translate-x-1/2 text-white/50 text-sm font-mono pointer-events-none animate-pulse">
                é»æ“Šé¹¼åŸºå°é€²è¡Œç·¨è¼¯
            </div>
        </main>

    </div>

    <!-- è§£èªª Modal -->
    <div id="explanation-modal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <!-- èƒŒæ™¯é®ç½© -->
        <div class="absolute inset-0 bg-slate-900/75 backdrop-blur-sm transition-opacity" onclick="closeExplanation()"></div>
        
        <!-- Modal å…§å®¹ -->
        <div class="relative z-10 flex min-h-full items-center justify-center p-4">
            <div class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-2xl modal-enter" id="modal-content">
                
                <!-- æ¨™é¡Œå€ -->
                <div class="bg-indigo-600 px-6 py-4 flex justify-between items-center">
                    <h3 class="text-lg font-bold text-white flex items-center gap-2">
                        ğŸ“– ç§‘å­¸æ¦‚å¿µè§£èªª
                    </h3>
                    <button onclick="closeExplanation()" class="text-indigo-100 hover:text-white transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>

                <!-- å…§å®¹å€ -->
                <div class="px-6 py-6 max-h-[70vh] overflow-y-auto">
                    
                    <div class="space-y-6">
                        <!-- 1. æŸ“è‰²é«” -->
                        <div class="flex gap-4">
                            <div class="shrink-0 w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center text-2xl">ğŸ§¶</div>
                            <div>
                                <h4 class="font-bold text-lg text-indigo-900">1. æŸ“è‰²é«” (Chromosome)</h4>
                                <p class="text-sm text-slate-600 mt-1">
                                    å­˜åœ¨æ–¼ç´°èƒæ ¸å…§ã€‚å®ƒæ˜¯ç”± DNA é•·éˆç·Šå¯†æ²æ›²è€Œæˆçš„æ§‹é€ ã€‚
                                    <br><span class="text-indigo-600 text-xs bg-indigo-50 px-2 py-0.5 rounded">æ¯”å–»ï¼šåƒæ˜¯ä¸€åœ˜æ²å¥½çš„æ¯›å†·çƒã€‚</span>
                                </p>
                            </div>
                        </div>

                        <!-- 2. DNA -->
                        <div class="flex gap-4">
                            <div class="shrink-0 w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-2xl">ğŸ§¬</div>
                            <div>
                                <h4 class="font-bold text-lg text-blue-900">2. DNA (è„«æ°§æ ¸ç³–æ ¸é…¸)</h4>
                                <p class="text-sm text-slate-600 mt-1">
                                    éºå‚³ç‰©è³ªçš„è¼‰é«”ï¼Œå‘ˆ<strong>é›™èºæ—‹çµæ§‹ (Double Helix)</strong>ã€‚
                                    <br><span class="text-blue-600 text-xs bg-blue-50 px-2 py-0.5 rounded">æ¯”å–»ï¼šåƒä¸€æ¢æ‰­æ›²çš„æ¢¯å­ã€‚</span>
                                </p>
                            </div>
                        </div>

                        <!-- 3. åŸºå›  -->
                        <div class="flex gap-4">
                            <div class="shrink-0 w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center text-2xl">ğŸ”‘</div>
                            <div>
                                <h4 class="font-bold text-lg text-yellow-900">3. åŸºå›  (Gene)</h4>
                                <p class="text-sm text-slate-600 mt-1">
                                    DNA åˆ†å­ä¸Šçš„ä¸€æ®µç‰¹å®šç‰‡æ®µï¼ˆå¦‚æ¨¡å‹ä¸­çš„é‡‘è‰²éƒ¨åˆ†ï¼‰ã€‚å®ƒæ±ºå®šäº†ç”Ÿç‰©çš„æŸå€‹ç‰¹å¾µï¼ˆä¾‹å¦‚å–®çœ¼çš®æˆ–é›™çœ¼çš®ï¼‰ã€‚
                                    <br><span class="text-yellow-600 text-xs bg-yellow-50 px-2 py-0.5 rounded">æ¯”å–»ï¼šåƒæ˜¯ä¸€æœ¬é£Ÿè­œä¸­çš„å…¶ä¸­ä¸€é“èœã€‚</span>
                                </p>
                            </div>
                        </div>

                        <!-- 4. é¹¼åŸº -->
                        <div class="flex gap-4">
                            <div class="shrink-0 w-12 h-12 bg-green-100 rounded-full flex items-center justify-center text-2xl">ğŸ§©</div>
                            <div>
                                <h4 class="font-bold text-lg text-green-900">4. é¹¼åŸº (Bases)</h4>
                                <p class="text-sm text-slate-600 mt-1">
                                    çµ„æˆ DNA çš„åŒ–å­¸ç‰©è³ªï¼Œæœ‰å››ç¨®ï¼šA, T, C, Gã€‚
                                    <br><strong>é‡è¦è¦å‰‡ï¼š</strong> <span class="text-red-500 font-bold">A</span> åªèƒ½é… <span class="text-blue-500 font-bold">T</span>ï¼Œ<span class="text-green-500 font-bold">C</span> åªèƒ½é… <span class="text-yellow-500 font-bold">G</span>ã€‚
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8 p-4 bg-slate-50 rounded-lg border border-slate-200 text-center">
                        <p class="text-sm font-bold text-slate-500 mb-2">å¤§å°é—œä¿‚åœ–</p>
                        <div class="flex items-center justify-center text-sm font-mono text-slate-700 gap-2 flex-wrap">
                            <span class="bg-white px-3 py-1 rounded shadow-sm border">ç´°èƒæ ¸</span>
                            <span>></span>
                            <span class="bg-white px-3 py-1 rounded shadow-sm border">æŸ“è‰²é«”</span>
                            <span>></span>
                            <span class="bg-white px-3 py-1 rounded shadow-sm border">DNA</span>
                            <span>></span>
                            <span class="bg-white px-3 py-1 rounded shadow-sm border ring-2 ring-yellow-400">åŸºå› </span>
                            <span>></span>
                            <span class="bg-white px-3 py-1 rounded shadow-sm border">é¹¼åŸº</span>
                        </div>
                    </div>
                </div>

                <!-- åº•éƒ¨æŒ‰éˆ• -->
                <div class="bg-slate-50 px-6 py-3 flex justify-end">
                    <button type="button" onclick="closeExplanation()" class="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">
                        æ˜ç™½äº†ï¼
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        /**
         * éºå‚³å­¸è³‡æ–™èˆ‡é‚è¼¯
         */
        const BASES = {
            'A': { name: 'è…ºå˜Œå‘¤ (A)', color: '#ef4444', pair: 'T' }, // Red
            'T': { name: 'èƒ¸è…ºå˜§å•¶ (T)', color: '#3b82f6', pair: 'A' }, // Blue
            'C': { name: 'èƒå˜§å•¶ (C)', color: '#22c55e', pair: 'G' }, // Green
            'G': { name: 'é³¥å˜Œå‘¤ (G)', color: '#eab308', pair: 'C' }  // Yellow
        };

        const NUM_PAIRS = 20;
        // å®šç¾©åŸºå› ç‰‡æ®µç¯„åœ (ç´¢å¼• 5 åˆ° 10)
        const GENE_START_INDEX = 5;
        const GENE_LENGTH = 6;
        
        let dnaSequence = [];

        // åˆå§‹åŒ–éš¨æ©Ÿ DNA åºåˆ—
        function initSequence() {
            dnaSequence = [];
            const keys = ['A', 'T', 'C', 'G'];
            for(let i = 0; i < NUM_PAIRS; i++) {
                const leftBase = keys[Math.floor(Math.random() * keys.length)];
                dnaSequence.push({
                    id: i,
                    left: leftBase,
                    right: BASES[leftBase].pair
                });
            }
            updateStats();
        }

        // çªè®Šï¼ˆæ”¹è®Šï¼‰æŸä¸€è¡Œçš„é¹¼åŸº
        function mutateRow(index) {
            const currentLeft = dnaSequence[index].left;
            let nextLeft;
            // å¾ªç’°é †åº A -> T -> C -> G -> A
            if (currentLeft === 'A') nextLeft = 'T';
            else if (currentLeft === 'T') nextLeft = 'C';
            else if (currentLeft === 'C') nextLeft = 'G';
            else nextLeft = 'A';

            dnaSequence[index].left = nextLeft;
            dnaSequence[index].right = BASES[nextLeft].pair;
            
            // è§¸ç™¼è¦–è¦ºç‰¹æ•ˆï¼ˆä¾‹å¦‚é–ƒå…‰ï¼Œé€™è£¡é€éæ¨™è¨˜è®“ Canvas è™•ç†ï¼‰
            visualEffects.push({
                type: 'flash',
                index: index,
                life: 1.0
            });
            
            updateStats();
        }

        function updateStats() {
            const counts = { A: 0, T: 0, C: 0, G: 0 };
            dnaSequence.forEach(row => {
                counts[row.left]++;
                counts[row.right]++;
            });
            document.getElementById('stat-a').innerText = counts.A;
            document.getElementById('stat-t').innerText = counts.T;
            document.getElementById('stat-c').innerText = counts.C;
            document.getElementById('stat-g').innerText = counts.G;
        }

        /**
         * Canvas æ¸²æŸ“å¼•æ“
         */
        const canvas = document.getElementById('dnaCanvas');
        const ctx = canvas.getContext('2d');
        const tooltip = document.getElementById('tooltip');
        
        // è¦–è¦ºåƒæ•¸
        let rotation = 0;
        let rotationSpeed = 0.02;
        let isPlaying = true;
        let visualEffects = []; // å­˜å„²ç‰¹æ•ˆç‰©ä»¶
        
        // éŸ¿æ‡‰å¼å°ºå¯¸
        let width, height;
        let scaleFactor = 1;

        function resize() {
            const parent = canvas.parentElement;
            width = parent.clientWidth;
            height = parent.clientHeight;
            
            // è™•ç†é«˜è§£æåº¦è¢å¹• (Retina)
            const dpr = window.devicePixelRatio || 1;
            canvas.width = width * dpr;
            canvas.height = height * dpr;
            ctx.scale(dpr, dpr);
            
            // èª¿æ•´å…§å®¹ç¸®æ”¾
            scaleFactor = Math.min(width, height) / 600; 
        }
        window.addEventListener('resize', resize);
        resize();

        // äº’å‹•æª¢æ¸¬ç›¸é—œè®Šæ•¸
        let mouseX = 0;
        let mouseY = 0;
        let hoveredRowIndex = -1;

        canvas.addEventListener('mousemove', e => {
            const rect = canvas.getBoundingClientRect();
            mouseX = e.clientX - rect.left;
            mouseY = e.clientY - rect.top;
            
            // æ›´æ–° Tooltip ä½ç½®
            if (hoveredRowIndex !== -1) {
                tooltip.style.left = (e.clientX) + 'px';
                tooltip.style.top = (e.clientY) + 'px';
                tooltip.style.opacity = 1;
                
                const row = dnaSequence[hoveredRowIndex];
                tooltip.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span class="w-3 h-3 rounded-full" style="background:${BASES[row.left].color}"></span> ${row.left}
                        <span class="text-gray-400">--</span>
                        <span class="w-3 h-3 rounded-full" style="background:${BASES[row.right].color}"></span> ${row.right}
                    </div>
                `;
            } else {
                tooltip.style.opacity = 0;
            }
        });

        canvas.addEventListener('click', () => {
            if (hoveredRowIndex !== -1) {
                mutateRow(hoveredRowIndex);
            }
        });

        canvas.addEventListener('mouseleave', () => {
            hoveredRowIndex = -1;
            tooltip.style.opacity = 0;
        });

        // 3D æŠ•å½±å¹«åŠ©å‡½æ•¸
        function project(x, y, z) {
            // ç°¡å–®çš„é€è¦–æŠ•å½±
            // å‡è¨­ç›¸æ©Ÿåœ¨ z = -500 çš„ä½ç½®
            const perspective = 400 / (400 + z);
            const x2d = x * perspective + width / 2;
            const y2d = y * perspective + height / 2;
            const scale = perspective * scaleFactor;
            return { x: x2d, y: y2d, scale: scale, zIndex: z };
        }

        // ä¸»æ¸²æŸ“å¾ªç’°
        function draw() {
            // æ¸…ç©ºç•«å¸ƒ
            ctx.clearRect(0, 0, width, height);

            if (isPlaying) {
                rotation += rotationSpeed;
            }

            // æº–å‚™ç¹ªè£½åˆ—è¡¨ (ç‚ºäº†æ­£ç¢ºè™•ç†å‰å¾Œé®æ“‹é—œä¿‚ - Z-buffer æ’åº)
            const drawList = [];
            const helixRadius = 100;
            const rowHeight = 35;
            const totalHeight = NUM_PAIRS * rowHeight;
            const startY = -totalHeight / 2;
            
            // åŸºå› æ¨™è¨˜çš„åº§æ¨™è¨ˆç®— (å–é–‹å§‹å’ŒçµæŸçš„ä¸­å¿ƒYä½ç½®ï¼Œå¿½ç•¥æ—‹è½‰å¸¶ä¾†çš„Xä½ç§»)
            let geneYStart = 0;
            let geneYEnd = 0;

            dnaSequence.forEach((row, i) => {
                const yBase = startY + i * rowHeight;
                // è§’åº¦è¨ˆç®—ï¼šæ¯å±¤æ—‹è½‰ 30 åº¦ (0.52 å¼§åº¦) + æ•´é«”è‡ªè½‰
                const angle = i * 0.5 + rotation;

                // å·¦èºæ—‹éˆåº§æ¨™ (Strand 1)
                const x1 = Math.sin(angle) * helixRadius;
                const z1 = Math.cos(angle) * helixRadius;
                
                // å³èºæ—‹éˆåº§æ¨™ (Strand 2) - ç›¸å·® PI (180åº¦)
                const x2 = Math.sin(angle + Math.PI) * helixRadius;
                const z2 = Math.cos(angle + Math.PI) * helixRadius;

                // æŠ•å½±åˆ° 2D
                const p1 = project(x1, yBase, z1);
                const p2 = project(x2, yBase, z2);
                
                // è¨˜éŒ„åŸºå› ç‰‡æ®µçš„å±å¹•ä½ç½® (ä½¿ç”¨ä¸­å¿ƒè»¸æŠ•å½±)
                const pCenter = project(0, yBase, 0);
                if (i === GENE_START_INDEX) geneYStart = pCenter.y;
                if (i === GENE_START_INDEX + GENE_LENGTH - 1) geneYEnd = pCenter.y;

                // åˆ¤æ–·æ˜¯å¦ç‚ºåŸºå› ç‰‡æ®µ
                const isGene = i >= GENE_START_INDEX && i < GENE_START_INDEX + GENE_LENGTH;
                const isHighlight = (i === hoveredRowIndex);

                // æ§‹å»ºç¹ªåœ–ç‰©ä»¶ï¼šé€£æ¥æ¡¿ (Bond)
                drawList.push({
                    type: 'bond',
                    z: (z1 + z2) / 2, // å¹³å‡æ·±åº¦
                    p1: p1,
                    p2: p2,
                    color: isGene ? '#fcd34d' : '#94a3b8', // åŸºå› ç‰‡æ®µç”¨é‡‘è‰²ï¼Œå…¶ä»–ç”¨ç°è‰²
                    isGene: isGene,
                    isHighlight: isHighlight
                });

                // æ§‹å»ºç¹ªåœ–ç‰©ä»¶ï¼šé¹¼åŸº (Nucleotides)
                // å·¦é‚Š
                drawList.push({
                    type: 'nucleotide',
                    base: row.left,
                    z: z1,
                    p: p1,
                    color: BASES[row.left].color,
                    isHighlight: isHighlight
                });

                // å³é‚Š
                drawList.push({
                    type: 'nucleotide',
                    base: row.right,
                    z: z2,
                    p: p2,
                    color: BASES[row.right].color,
                    isHighlight: isHighlight
                });
            });

            // æ’åºç¹ªåœ–ç‰©ä»¶ï¼šZ å€¼è¶Šå¤§è¶Šé  (painter's algorithm: ç•«é çš„ -> ç•«è¿‘çš„)
            // ä¿®æ­£ï¼šZ åº§æ¨™ç³»çµ±ä¸­ï¼Œz è¶Šå¤§è¡¨ç¤ºè¶Šé  (åœ¨ project å‡½æ•¸ä¸­ perspective = 400/(400+z))
            // æ‰€ä»¥æˆ‘å€‘å…ˆç•« z å¤§çš„
            drawList.sort((a, b) => b.z - a.z);

            // ç¹ªè£½å¾ªç’°
            drawList.forEach(item => {
                
                ctx.globalAlpha = 1;
                
                // å®‰å…¨è®€å– scale (ä¿®å¾©éŒ¯èª¤ï¼šbond é¡å‹æ²’æœ‰ item.p)
                const scale = item.p ? item.p.scale : item.p1.scale;
                
                // æ ¹æ“šæ·±åº¦èª¿æ•´äº®åº¦ (Depth Fog)
                const brightness = Math.max(0.4, Math.min(1, scale * 1.5));
                
                if (item.type === 'bond') {
                    
                    ctx.beginPath();
                    ctx.moveTo(item.p1.x, item.p1.y);
                    ctx.lineTo(item.p2.x, item.p2.y);
                    
                    if (item.isGene && !item.isHighlight) {
                        // åŸºå› ç‰‡æ®µçš„ç‰¹æ®Šå…‰æšˆ
                        ctx.shadowBlur = 10;
                        ctx.shadowColor = '#fcd34d';
                    } else {
                        ctx.shadowBlur = 0;
                    }

                    ctx.strokeStyle = item.isHighlight ? '#fbbf24' : (item.isGene ? '#fcd34d' : `rgba(148, 163, 184, ${brightness})`);
                    ctx.lineWidth = item.isHighlight ? 6 * scale : 3 * scale;
                    ctx.stroke();
                    ctx.shadowBlur = 0; // é‡ç½®

                } else if (item.type === 'nucleotide') {
                    const r = (item.isHighlight ? 18 : 14) * item.p.scale;
                    
                    ctx.beginPath();
                    ctx.arc(item.p.x, item.p.y, r, 0, Math.PI * 2);
                    
                    // å¡«å……é¡è‰² (å¸¶æ¼¸è®Šæ›´æœ‰ç«‹é«”æ„Ÿ)
                    const grad = ctx.createRadialGradient(
                        item.p.x - r/3, item.p.y - r/3, r/10,
                        item.p.x, item.p.y, r
                    );
                    
                    // è§£æé¡è‰²ä¸¦èª¿æš—
                    const baseColor = item.color;
                    grad.addColorStop(0, adjustBrightness(baseColor, 40)); // Highlight
                    grad.addColorStop(1, adjustBrightness(baseColor, -20)); // Shadow
                    
                    ctx.fillStyle = grad;
                    
                    // é‚Šæ¡†
                    if (item.isHighlight) {
                        ctx.strokeStyle = '#fff';
                        ctx.lineWidth = 2;
                        ctx.stroke();
                    }
                    
                    ctx.fill();

                    // æ–‡å­—
                    ctx.fillStyle = '#fff';
                    ctx.font = `bold ${12 * item.p.scale}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.globalAlpha = brightness;
                    ctx.fillText(item.base, item.p.x, item.p.y);
                    ctx.globalAlpha = 1;
                }
            });

            // ç¹ªè£½ã€ŒåŸºå› ã€æ¨™è¨˜æ‹¬è™Ÿ
            // åœ¨ DNA çš„å³å´ç¹ªè£½ä¸€å€‹æ‹¬è™Ÿ
            if (geneYStart && geneYEnd) {
                const bracketX = width / 2 + 140 * scaleFactor; // è·é›¢ä¸­å¿ƒçš„ä½ç½®
                const bracketTop = geneYStart - 10 * scaleFactor;
                const bracketBottom = geneYEnd + 10 * scaleFactor;
                const bracketWidth = 10 * scaleFactor;

                ctx.beginPath();
                ctx.strokeStyle = '#fcd34d'; // Gold
                ctx.lineWidth = 3;
                // ä¸Šæ©«ç·š
                ctx.moveTo(bracketX, bracketTop);
                ctx.lineTo(bracketX + bracketWidth, bracketTop);
                // è±ç·š
                ctx.lineTo(bracketX + bracketWidth, bracketBottom);
                // ä¸‹æ©«ç·š
                ctx.lineTo(bracketX, bracketBottom);
                ctx.stroke();

                // æ–‡å­—æ¨™ç±¤
                ctx.fillStyle = '#f59e0b'; // Darker Gold
                ctx.font = `bold ${14 * scaleFactor}px sans-serif`;
                ctx.textAlign = 'left';
                ctx.textBaseline = 'middle';
                ctx.fillText('ğŸ§¬ åŸºå› ç‰‡æ®µ (Gene)', bracketX + bracketWidth + 10, (bracketTop + bracketBottom) / 2);
                
                // è£œå……èªªæ˜æ–‡å­—
                ctx.fillStyle = '#94a3b8';
                ctx.font = `${10 * scaleFactor}px sans-serif`;
                ctx.fillText('æ±ºå®šç‰¹å¾µçš„åºåˆ—', bracketX + bracketWidth + 10, (bracketTop + bracketBottom) / 2 + 16 * scaleFactor);
            }
            
            // ç¹ªè£½ç‰¹æ•ˆ (Flash effect)
            visualEffects = visualEffects.filter(fx => fx.life > 0);
            visualEffects.forEach(fx => {
                fx.life -= 0.05;
                // æ‰¾å‡ºè©²è¡Œçš„ Y è»¸ä½ç½®å¤§è‡´åœ¨å“ª (ç‚ºäº†ç°¡å–®ï¼Œé‡æ–°è¨ˆç®—ä¸€æ¬¡æŠ•å½±)
                const yBase = startY + fx.index * rowHeight;
                const p = project(0, yBase, 0); // ä¸­å¿ƒé»
                
                ctx.beginPath();
                // FIX: ç¢ºä¿åŠå¾‘æ°¸é ä¸ç‚ºè² æ•¸ã€‚åŸå§‹å…¬å¼åœ¨ life > 1.5 æ™‚æœƒè®Šè² ã€‚
                const radius = Math.max(0, 100 * (2.5 - fx.life));
                ctx.arc(p.x, p.y, radius, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(255, 255, 255, ${fx.life * 0.5})`;
                ctx.fill();
            });

            // çœŸæ­£çš„ Hit Detection Update Loop (æ¯å¹€è¨ˆç®—ä¸€æ¬¡æœ€ä½³ hover)
            updateHoverDetection(startY, rowHeight, helixRadius);

            requestAnimationFrame(draw);
        }

        // åˆ†é›¢å‡ºçš„æª¢æ¸¬é‚è¼¯
        function updateHoverDetection(startY, rowHeight, helixRadius) {
            let minDistance = 1000;
            let targetIndex = -1;

            dnaSequence.forEach((row, i) => {
                const yBase = startY + i * rowHeight;
                const angle = i * 0.5 + rotation;
                
                // è¨ˆç®—ä¸­å¿ƒé» (å…©å€‹èºæ—‹çš„ä¸­é»å…¶å¯¦å°±æ˜¯æ—‹è½‰è»¸ä¸Šçš„é»ï¼Œä½†å¸¶æœ‰é€è¦–)
                // å¯¦éš›ä¸Šæ»‘é¼ æ›´å®¹æ˜“é»æ“Šé€£æ¥æ£’ã€‚é€£æ¥æ£’çš„ä¸­å¿ƒåœ¨ (0, yBase, 0)
                const pCenter = project(0, yBase, 0);
                
                // åˆ¤æ–·æ»‘é¼ èˆ‡è©²å±¤ä¸­å¿ƒçš„è·é›¢
                // å› ç‚ºæ˜¯ 3Dï¼Œæˆ‘å€‘åªåˆ¤æ–· Y è»¸è·é›¢æ˜¯å¦åœ¨è¡Œé«˜ç¯„åœå…§ï¼Œä¸” X è»¸åœ¨èºæ—‹å¯¬åº¦å…§
                const dy = Math.abs(mouseY - pCenter.y);
                const dx = Math.abs(mouseX - pCenter.x);
                
                // å¯¬é¬†åˆ¤æ–·ç¯„åœ
                if (dy < 15 * pCenter.scale && dx < 120 * pCenter.scale) {
                    // æ‰¾åˆ°æ»‘é¼ æœ€è¿‘çš„ä¸€è¡Œ
                    const dist = Math.hypot(dx, dy);
                    if (dist < minDistance) {
                        minDistance = dist;
                        targetIndex = i;
                    }
                }
            });

            hoveredRowIndex = targetIndex;
            canvas.style.cursor = (hoveredRowIndex !== -1) ? 'pointer' : 'default';
        }

        // é¡è‰²äº®åº¦èª¿æ•´å·¥å…·
        function adjustBrightness(hex, percent) {
            // ç°¡å–®çš„ HEX äº®åº¦èª¿æ•´
            let r = parseInt(hex.substring(1, 3), 16);
            let g = parseInt(hex.substring(3, 5), 16);
            let b = parseInt(hex.substring(5, 7), 16);

            r = Math.min(255, Math.max(0, r + percent));
            g = Math.min(255, Math.max(0, g + percent));
            b = Math.min(255, Math.max(0, b + percent));

            const rr = ((r.toString(16).length === 1) ? "0" + r.toString(16) : r.toString(16));
            const gg = ((g.toString(16).length === 1) ? "0" + g.toString(16) : g.toString(16));
            const bb = ((b.toString(16).length === 1) ? "0" + b.toString(16) : b.toString(16));

            return "#" + rr + gg + bb;
        }

        // UI äº¤äº’åŠŸèƒ½
        function toggleAnimation() {
            isPlaying = !isPlaying;
            const btn = document.getElementById('btn-play');
            if (isPlaying) {
                btn.innerHTML = '<span>â¸ï¸</span> <span>æš«åœæ—‹è½‰</span>';
                btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                btn.classList.add('bg-slate-800', 'hover:bg-slate-700');
            } else {
                btn.innerHTML = '<span>â–¶ï¸</span> <span>ç¹¼çºŒæ—‹è½‰</span>';
                btn.classList.remove('bg-slate-800', 'hover:bg-slate-700');
                btn.classList.add('bg-green-600', 'hover:bg-green-700');
            }
        }

        function randomizeDNA() {
            // è¦–è¦ºç‰¹æ•ˆï¼šé–ƒçˆä¸€ä¸‹
            visualEffects.push({ index: Math.floor(NUM_PAIRS/2), life: 2.0, type: 'flash' });
            initSequence();
            updateStats();
        }

        function updateSpeed(val) {
            // map 0-100 to 0-0.1
            rotationSpeed = val / 1500;
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            // åˆ‡æ› transform
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
            } else {
                sidebar.classList.add('-translate-x-full');
            }
        }

        // Modal æ§åˆ¶é‚è¼¯
        function openExplanation() {
            const modal = document.getElementById('explanation-modal');
            const content = document.getElementById('modal-content');
            modal.classList.remove('hidden');
            // æ·»åŠ å‹•ç•« class
            content.classList.remove('modal-exit', 'modal-exit-active');
            content.classList.add('modal-enter-active');
        }

        function closeExplanation() {
            const modal = document.getElementById('explanation-modal');
            const content = document.getElementById('modal-content');
            
            // ç§»é™¤é€²å…¥å‹•ç•«ï¼Œæ·»åŠ é€€å‡ºå‹•ç•«
            content.classList.remove('modal-enter', 'modal-enter-active');
            content.classList.add('modal-exit-active');

            // ç­‰å¾…å‹•ç•«çµæŸå¾Œéš±è— (200ms)
            setTimeout(() => {
                modal.classList.add('hidden');
                content.classList.remove('modal-exit-active');
            }, 200);
        }

        // å•Ÿå‹•
        initSequence();
        draw();

    </script>
</body>
</html>