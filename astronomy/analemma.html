<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸–ç•Œæ—¥è¡Œè·¡è§€æ¸¬å„€ (Analemma)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .canvas-container { cursor: crosshair; }
        
        /* æ»‘æ¡¿è‡ªå®šç¾©æ¨£å¼ */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #f59e0b;
            margin-top: -6px; 
            cursor: pointer;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            background: #475569;
            border-radius: 2px;
        }
        
        /* Modal å‹•ç•« */
        .modal-enter { opacity: 0; }
        .modal-enter-active { opacity: 1; transition: opacity 300ms; }
        .modal-exit { opacity: 1; }
        .modal-exit-active { opacity: 0; transition: opacity 300ms; }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 h-screen flex flex-col overflow-hidden font-sans">

    <!-- é ‚éƒ¨æ¨™é¡Œ -->
    <header class="bg-slate-900 border-b border-slate-800 p-4 flex justify-between items-center shadow-lg z-10">
        <div>
            <h1 class="text-xl md:text-2xl font-bold text-amber-500 tracking-wider flex items-center">
                <span class="text-2xl mr-2">â˜€</span><span data-i18n="appTitle">ä¸–ç•Œæ—¥è¡Œè·¡è§€æ¸¬å„€</span>
            </h1>
            <p class="text-[10px] md:text-xs text-slate-400 mt-1" data-i18n="appSubtitle">è§€æ¸¬å¤ªé™½åœ¨å›ºå®šç•¶åœ°æ™‚é–“çš„è»Œè·¡è®ŠåŒ– (Local Time)</p>
        </div>
        
        <!-- å³å´åŠŸèƒ½å€ -->
        <div class="flex items-center gap-3">
             <button id="help-btn" class="bg-slate-800 hover:bg-slate-700 hover:text-sky-300 text-sky-400 text-xs md:text-sm px-3 py-1.5 rounded-full border border-slate-700 transition-all flex items-center gap-1 shadow-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span class="hidden md:inline font-bold" data-i18n="helpBtn">æ—¥è¡Œè·¡è§£èªª</span>
                <span class="md:hidden">?</span>
            </button>
            
            <!-- èªè¨€åˆ‡æ›æŒ‰éˆ• (ç§»è‡³æœ€å³) -->
            <button id="lang-btn" class="bg-slate-800 hover:bg-slate-700 hover:text-white text-slate-300 text-xs font-bold px-3 py-1.5 rounded-full border border-slate-700 transition-all shadow-sm">
                ä¸­ / Eng
            </button>
        </div>
    </header>

    <!-- ä¸»å…§å®¹å€ -->
    <div class="flex flex-1 overflow-hidden relative">
        
        <!-- å·¦å´ï¼šè¨­å®šèˆ‡é¸å–® -->
        <aside class="w-1/3 md:w-72 bg-slate-900 border-r border-slate-800 flex flex-col z-20 shadow-xl p-5 gap-6 overflow-y-auto">
            
            <!-- 1. åŸå¸‚é¸æ“‡ -->
            <div class="flex flex-col gap-2">
                <label for="city-select" class="text-xs font-bold text-slate-400 uppercase tracking-wide" data-i18n="cityLabel">è§€æ¸¬åŸå¸‚</label>
                <select id="city-select" class="bg-slate-800 text-white border border-slate-600 rounded-md p-2 focus:ring-2 focus:ring-amber-500 outline-none text-sm transition-all hover:border-slate-500">
                    <!-- Javascript å¡«å…… -->
                </select>
                <div class="text-[10px] text-slate-500 flex justify-between font-mono px-1">
                    <span id="city-lat">--</span>
                    <span>UTC <span id="city-offset">--</span></span>
                </div>
            </div>

            <!-- 2. æ™‚é–“æ»‘æ¡¿ -->
            <div class="flex flex-col gap-3">
                <div class="flex justify-between items-center">
                    <label for="time-slider" class="text-xs font-bold text-slate-400 uppercase tracking-wide" data-i18n="timeLabel">æ¯æ—¥è§€æ¸¬æ™‚é–“ (ç•¶åœ°)</label>
                    <span id="time-display" class="text-amber-400 font-mono font-bold text-sm bg-slate-800 px-2 py-0.5 rounded border border-slate-700">18:30</span>
                </div>
                <input type="range" id="time-slider" min="16" max="22" step="0.1" value="18.5" class="w-full">
                <div class="flex justify-between text-[10px] text-slate-500 px-1">
                    <span>16:00</span>
                    <span>22:00</span>
                </div>
            </div>

            <hr class="border-slate-800">

            <!-- 3. æ—¥æœŸé¸æ“‡ -->
            <div class="flex flex-col gap-4">
                <div class="text-xs font-bold text-slate-400 uppercase tracking-wide" data-i18n="dateSelectionLabel">æ—¥æœŸå®šä½</div>
                
                <div class="grid grid-cols-2 gap-2">
                    <div class="flex flex-col gap-1">
                        <label class="text-[10px] text-slate-500" data-i18n="monthLabel">æœˆä»½</label>
                        <select id="month-select" class="bg-slate-800 text-white border border-slate-600 rounded p-1.5 focus:ring-2 focus:ring-amber-500 outline-none text-sm">
                            <!-- Javascript å¡«å…… -->
                        </select>
                    </div>
                    <div class="flex flex-col gap-1">
                        <label class="text-[10px] text-slate-500" data-i18n="dayLabel">æ—¥æœŸ</label>
                        <select id="day-select" class="bg-slate-800 text-white border border-slate-600 rounded p-1.5 focus:ring-2 focus:ring-amber-500 outline-none text-sm">
                            <!-- Javascript å¡«å…… -->
                        </select>
                    </div>
                </div>
            </div>

            <!-- åº•éƒ¨èªªæ˜ -->
            <div class="mt-auto pt-4 text-[10px] text-slate-600 text-center border-t border-slate-800" data-i18n="footerNote">
                è¨»ï¼šè¨ˆç®—æ¡ç”¨æ¨™æº–æ™‚é–“ï¼Œä¸å«å¤ä»¤æ™‚é–“èª¿æ•´<br>
                ä»¥ç¢ºä¿è»Œè·¡å¹³æ»‘é€£çºŒ
            </div>
        </aside>

        <!-- å³å´ï¼šå¯è¦–åŒ–ç•«å¸ƒ -->
        <main class="flex-1 relative bg-slate-200 canvas-container flex items-center justify-center overflow-hidden" id="main-area">
            
            <!-- Canvas -->
            <canvas id="skyCanvas" class="absolute inset-0 z-0"></canvas>

            <!-- æ•¸æ“šé¡¯ç¤ºæµ®å±¤ -->
            <div id="info-panel" class="absolute top-4 right-4 bg-white/90 backdrop-blur-sm border border-slate-200 p-4 rounded-lg shadow-2xl w-64 transform transition-all duration-300 opacity-0 translate-y-[-10px] text-slate-800 pointer-events-none">
                <h3 class="text-amber-600 font-bold text-lg mb-2 border-b border-slate-200 pb-1 flex justify-between">
                    <span id="info-date">--æœˆ--æ—¥</span>
                </h3>
                <div class="space-y-1.5 text-sm">
                    <div class="flex justify-between">
                        <span class="text-slate-500" data-i18n="azimuth">æ–¹ä½è§’ (Az):</span>
                        <span class="font-mono text-emerald-600 font-bold" id="info-az">--Â°</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-slate-500" data-i18n="altitude">ä»°è§’ (Alt):</span>
                        <span class="font-mono text-cyan-600 font-bold" id="info-alt">--Â°</span>
                    </div>
                    <div class="mt-2 pt-2 border-t border-slate-100">
                        <span class="block text-center font-bold text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-600" id="info-status">--</span>
                    </div>
                </div>
            </div>

            <!-- æç¤ºæ–‡å­— -->
            <div class="absolute bottom-6 left-1/2 transform -translate-x-1/2 text-white/90 text-xs pointer-events-none text-center bg-slate-900/40 px-4 py-2 rounded-full backdrop-blur-md border border-white/10 shadow-lg" data-i18n="hint">
                æ­£è¥¿æ–¹è¦–è§’ â€¢ è‡ªå‹•ç½®ä¸­æ¨¡å¼
            </div>
        </main>
    </div>

    <!-- è§£èªª Modal -->
    <div id="help-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="bg-slate-900 w-full max-w-2xl max-h-[85vh] mx-4 rounded-2xl border border-slate-700 shadow-2xl overflow-hidden flex flex-col transform scale-95 transition-transform duration-300" id="help-content-container">
            <!-- Modal Header -->
            <div class="p-4 md:p-5 border-b border-slate-800 flex justify-between items-center bg-slate-800/50">
                <h2 class="text-lg md:text-xl font-bold text-amber-500 flex items-center gap-2" data-i18n="helpTitle">
                    <span>ğŸ“š</span> é—œæ–¼æ—¥è¡Œè·¡ (Analemma)
                </h2>
                <button id="close-help-btn" class="text-slate-400 hover:text-white transition-colors p-1 rounded hover:bg-slate-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <!-- Modal Content (Dynamic) -->
            <div id="help-body" class="p-6 overflow-y-auto text-slate-300 space-y-6 leading-relaxed text-sm md:text-base scroll-smooth">
                <!-- Javascript will inject content here -->
            </div>

            <!-- Modal Footer -->
            <div class="p-4 border-t border-slate-800 bg-slate-800/50 text-center">
                <button id="close-help-btn-bottom" class="bg-sky-600 hover:bg-sky-500 text-white px-8 py-2 rounded-lg transition-all font-bold text-sm shadow-lg hover:shadow-sky-500/20 transform hover:-translate-y-0.5" data-i18n="helpClose">
                    æ˜ç™½äº†
                </button>
            </div>
        </div>
    </div>

<script>
/**
 * å¤šèªè¨€å­—å…¸
 */
const I18N = {
    zh: {
        appTitle: "ä¸–ç•Œæ—¥è¡Œè·¡è§€æ¸¬å„€",
        appSubtitle: "è§€æ¸¬å¤ªé™½åœ¨å›ºå®šç•¶åœ°æ™‚é–“çš„è»Œè·¡è®ŠåŒ– (Local Time)",
        helpBtn: "æ—¥è¡Œè·¡è§£èªª",
        cityLabel: "è§€æ¸¬åŸå¸‚",
        timeLabel: "æ¯æ—¥è§€æ¸¬æ™‚é–“ (ç•¶åœ°)",
        dateSelectionLabel: "æ—¥æœŸå®šä½",
        monthLabel: "æœˆä»½",
        dayLabel: "æ—¥æœŸ",
        footerNote: "è¨»ï¼šè¨ˆç®—æ¡ç”¨æ¨™æº–æ™‚é–“ï¼Œä¸å«å¤ä»¤æ™‚é–“èª¿æ•´<br>ä»¥ç¢ºä¿è»Œè·¡å¹³æ»‘é€£çºŒ",
        azimuth: "æ–¹ä½è§’ (Az):",
        altitude: "ä»°è§’ (Alt):",
        hint: "æ­£è¥¿æ–¹è¦–è§’ â€¢ è‡ªå‹•ç½®ä¸­æ¨¡å¼",
        helpTitle: "é—œæ–¼æ—¥è¡Œè·¡ (Analemma)",
        helpClose: "æ˜ç™½äº†",
        horizon: "åœ°å¹³ç·š (0Â°)",
        west: "è¥¿ (W)",
        south: "å— (S)",
        north: "åŒ— (N)",
        visible: "åœ°å¹³ç·šä¸Š (å¯è¦‹)",
        invisible: "åœ°å¹³ç·šä¸‹ (ä¸å¯è¦‹)",
        months: ["1æœˆ", "2æœˆ", "3æœˆ", "4æœˆ", "5æœˆ", "6æœˆ", "7æœˆ", "8æœˆ", "9æœˆ", "10æœˆ", "11æœˆ", "12æœˆ"],
        daySuffix: "æ—¥"
    },
    en: {
        appTitle: "World Analemma Visualizer",
        appSubtitle: "Observe solar position changes at fixed local time",
        helpBtn: "Explanation",
        cityLabel: "Observation City",
        timeLabel: "Observation Time (Local)",
        dateSelectionLabel: "Date Selection",
        monthLabel: "Month",
        dayLabel: "Date",
        footerNote: "Note: Standard time used (no DST)<br>to ensure smooth continuity.",
        azimuth: "Azimuth:",
        altitude: "Altitude:",
        hint: "West Facing â€¢ Auto-Center Mode",
        helpTitle: "About Analemma",
        helpClose: "Got it",
        horizon: "Horizon (0Â°)",
        west: "West (W)",
        south: "South (S)",
        north: "North (N)",
        visible: "Above Horizon (Visible)",
        invisible: "Below Horizon (Invisible)",
        months: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
        daySuffix: ""
    }
};

let currentLang = 'zh';

/**
 * åŸå¸‚æ•¸æ“šåº« (æ”¯æ´é›™èª)
 */
const CITIES = [
    { nameZh: "é¦™æ¸¯", nameEn: "Hong Kong", lat: 22.3, lon: 114.2, utcOffset: 8 },
    { nameZh: "å°åŒ—", nameEn: "Taipei", lat: 25.03, lon: 121.56, utcOffset: 8 },
    { nameZh: "æ±äº¬", nameEn: "Tokyo", lat: 35.68, lon: 139.76, utcOffset: 9 },
    { nameZh: "åŒ—äº¬", nameEn: "Beijing", lat: 39.90, lon: 116.40, utcOffset: 8 },
    { nameZh: "æ–°åŠ å¡", nameEn: "Singapore", lat: 1.35, lon: 103.82, utcOffset: 8 },
    { nameZh: "èµ¤é“ (å¤ç”¸)", nameEn: "Equator (Pontianak)", lat: 0.0, lon: 109.33, utcOffset: 7 },
    { nameZh: "åŸºå¤š", nameEn: "Quito", lat: -0.18, lon: -78.47, utcOffset: -5 },
    { nameZh: "å€«æ•¦", nameEn: "London", lat: 51.50, lon: -0.12, utcOffset: 0 },
    { nameZh: "å·´é»", nameEn: "Paris", lat: 48.85, lon: 2.35, utcOffset: 1 },
    { nameZh: "è«æ–¯ç§‘", nameEn: "Moscow", lat: 55.75, lon: 37.61, utcOffset: 3 },
    { nameZh: "é–‹æ™®æ•¦", nameEn: "Cape Town", lat: -33.92, lon: 18.42, utcOffset: 2 }, 
    { nameZh: "ç´ç´„", nameEn: "New York", lat: 40.71, lon: -74.00, utcOffset: -5 },
    { nameZh: "æ´›æ‰ç£¯", nameEn: "Los Angeles", lat: 34.05, lon: -118.24, utcOffset: -8 },
    { nameZh: "é‡Œç´„ç†±å…§ç›§", nameEn: "Rio de Janeiro", lat: -22.90, lon: -43.17, utcOffset: -3 },
    { nameZh: "é›ªæ¢¨", nameEn: "Sydney", lat: -33.86, lon: 151.20, utcOffset: 10 },
    { nameZh: "çƒæ–¯æ‡·äº", nameEn: "Ushuaia", lat: -54.80, lon: -68.30, utcOffset: -3 }, 
    { nameZh: "é›·å…‹é›…ç¶­å…‹", nameEn: "Reykjavik", lat: 64.14, lon: -21.90, utcOffset: 0 },
    { nameZh: "æœ—ä¼Šçˆ¾åŸ", nameEn: "Longyearbyen", lat: 78.22, lon: 15.65, utcOffset: 1 },
    { nameZh: "åŒ—æ¥µé»", nameEn: "North Pole", lat: 89.99, lon: 0, utcOffset: 0 }, 
    { nameZh: "å—æ¥µé»", nameEn: "South Pole", lat: -89.99, lon: 0, utcOffset: 12 }
];

/**
 * å…¨å±€é…ç½®
 */
let CONFIG = {
    lat: 22.3, 
    lon: 114.2,
    utcOffset: 8,
    year: 2025,
    hour: 18,   
    minute: 30, 
    viewAzimuthCenter: 270,
    viewAzimuthRange: 60,
    viewAltMin: -15,       
    viewAltMax: 35         
};

let sunData = [];
let activePointIndex = -1;

/**
 * ç°¡æ˜“å¤ªé™½ä½ç½®è¨ˆç®—ç®—æ³• (ç„¡æŠ˜å°„)
 */
function getSunPosition(date, lat, lon) {
    const PI = Math.PI;
    const rad = PI / 180;
    const deg = 180 / PI;

    const Y = date.getUTCFullYear();
    const M = date.getUTCMonth() + 1;
    const D = date.getUTCDate();
    const UT = date.getUTCHours() + date.getUTCMinutes()/60 + date.getUTCSeconds()/3600;

    let JD = 367*Y - Math.floor(7*(Y + Math.floor((M+9)/12))/4) + Math.floor(275*M/9) + D + 1721013.5 + UT/24;
    const T = (JD - 2451545.0) / 36525;

    let L0 = 280.46646 + 36000.76983 * T + 0.0003032 * T*T;
    L0 = L0 % 360;

    const M_sun = 357.52911 + 35999.05029 * T - 0.0001537 * T*T;
    const C = (1.914602 - 0.004817 * T - 0.000014 * T*T) * Math.sin(M_sun * rad) +
              (0.019993 - 0.000101 * T) * Math.sin(2 * M_sun * rad) +
              0.000289 * Math.sin(3 * M_sun * rad);

    const sunTrueLong = L0 + C;
    const omega = 125.04 - 1934.136 * T;
    const lambda = sunTrueLong - 0.00569 - 0.00478 * Math.sin(omega * rad);
    const epsilon = 23.439291 - 0.0130041 * T - 0.000000163 * T*T + 0.0005036 * T*T*T;
    const obliq = epsilon + 0.00256 * Math.cos(omega * rad);

    const alpha = Math.atan2(Math.cos(obliq * rad) * Math.sin(lambda * rad), Math.cos(lambda * rad)) * deg;
    const delta = Math.asin(Math.sin(obliq * rad) * Math.sin(lambda * rad)) * deg;

    const GMST0 = 280.46061837 + 360.98564736629 * (JD - 2451545.0) + 0.000387933 * T*T - T*T*T/38710000;
    const GMST = (GMST0 % 360 + 360) % 360;
    const LMST = (GMST + lon) % 360;

    let H = LMST - alpha;
    H = (H + 180) % 360 - 180;

    const sinAlt = Math.sin(lat * rad) * Math.sin(delta * rad) + Math.cos(lat * rad) * Math.cos(delta * rad) * Math.cos(H * rad);
    const altitude = Math.asin(sinAlt) * deg;

    const cosAz = (Math.sin(delta * rad) - Math.sin(lat * rad) * Math.sin(altitude * rad)) / (Math.cos(lat * rad) * Math.cos(altitude * rad));
    let azimuth = Math.acos(Math.min(1, Math.max(-1, cosAz))) * deg;

    if (Math.sin(H * rad) > 0) {
        azimuth = 360 - azimuth;
    }

    return { az: azimuth, alt: altitude, trueAlt: altitude };
}

function calculateAndCenter() {
    sunData = [];
    const startDate = new Date(CONFIG.year, 0, 1);
    
    let minAz = 360;
    let maxAz = 0;

    for (let i = 0; i < 366; i++) {
        const d = new Date(startDate);
        d.setDate(startDate.getDate() + i);
        if (d.getFullYear() > CONFIG.year) break;

        const targetUTCHour = CONFIG.hour - CONFIG.utcOffset;
        const targetUTCMinute = CONFIG.minute;
        
        d.setUTCHours(targetUTCHour, targetUTCMinute, 0, 0);
        
        const pos = getSunPosition(d, CONFIG.lat, CONFIG.lon);
        
        if (pos.az < minAz) minAz = pos.az;
        if (pos.az > maxAz) maxAz = pos.az;

        const displayDate = new Date(CONFIG.year, 0, 1 + i);

        sunData.push({
            date: d,
            month: displayDate.getMonth() + 1,
            day: displayDate.getDate(),
            az: pos.az,
            alt: pos.alt,
            trueAlt: pos.trueAlt,
            dayOfYear: i
        });
    }

    CONFIG.viewAzimuthCenter = (minAz + maxAz) / 2;
    const range = maxAz - minAz;
    if (range > CONFIG.viewAzimuthRange - 10) {
        CONFIG.viewAzimuthRange = range + 20;
    }
}

const canvas = document.getElementById('skyCanvas');
const ctx = canvas.getContext('2d');

function mapCoordinates(az, alt) {
    const width = canvas.width;
    const height = canvas.height;
    const minAz = CONFIG.viewAzimuthCenter - CONFIG.viewAzimuthRange / 2;
    const maxAz = CONFIG.viewAzimuthCenter + CONFIG.viewAzimuthRange / 2;
    const minAlt = CONFIG.viewAltMin;
    const maxAlt = CONFIG.viewAltMax;

    const x = ((az - minAz) / (maxAz - minAz)) * width;
    const y = height - ((alt - minAlt) / (maxAlt - minAlt)) * height;
    return { x, y };
}

function draw() {
    const w = canvas.width;
    const h = canvas.height;
    const dict = I18N[currentLang];

    ctx.clearRect(0, 0, w, h);

    // èƒŒæ™¯
    const horizonY = mapCoordinates(CONFIG.viewAzimuthCenter, 0).y;
    const skyGradient = ctx.createLinearGradient(0, 0, 0, horizonY);
    skyGradient.addColorStop(0, '#38bdf8'); 
    skyGradient.addColorStop(1, '#bae6fd'); 
    ctx.fillStyle = skyGradient;
    ctx.fillRect(0, 0, w, horizonY);

    const groundGradient = ctx.createLinearGradient(0, horizonY, 0, h);
    groundGradient.addColorStop(0, '#4ade80');
    groundGradient.addColorStop(1, '#22c55e');
    ctx.fillStyle = groundGradient;
    ctx.fillRect(0, horizonY, w, h - horizonY);

    // ç¶²æ ¼
    ctx.lineWidth = 1;
    ctx.textAlign = 'center';
    
    // åœ°å¹³ç·š
    ctx.beginPath();
    ctx.moveTo(0, horizonY);
    ctx.lineTo(w, horizonY);
    ctx.strokeStyle = '#15803d';
    ctx.lineWidth = 2;
    ctx.stroke();
    ctx.fillStyle = '#15803d';
    ctx.font = '12px sans-serif';
    ctx.fillText(dict.horizon, 60, horizonY + 15);

    // ä»°è§’ç·š
    ctx.strokeStyle = 'rgba(255, 255, 255, 0.4)';
    ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
    for (let a = -10; a <= 60; a += 10) {
        if (a === 0) continue;
        const y = mapCoordinates(CONFIG.viewAzimuthCenter, a).y;
        if (y < 0 || y > h) continue;
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(w, y);
        ctx.stroke();
        ctx.fillText(`${a}Â°`, 20, y + 4);
    }

    // æ–¹ä½ç·š
    const startAz = Math.ceil((CONFIG.viewAzimuthCenter - CONFIG.viewAzimuthRange/2) / 10) * 10;
    const endAz = Math.floor((CONFIG.viewAzimuthCenter + CONFIG.viewAzimuthRange/2) / 10) * 10;

    for (let az = startAz; az <= endAz; az += 10) {
        const x = mapCoordinates(az, 0).x;
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, h);
        ctx.stroke();
        
        let label = `${az}Â°`;
        if (az % 90 === 0) {
            if (az === 270) label = dict.west;
            if (az === 180) label = dict.south;
            if (az === 0 || az === 360) label = dict.north;
        }
        ctx.fillText(label, x, h - 20);
    }

    // 8 å­—è»Œè·¡
    ctx.beginPath();
    sunData.forEach((p, i) => {
        const { x, y } = mapCoordinates(p.az, p.alt);
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
    });
    ctx.strokeStyle = '#f59e0b';
    ctx.lineWidth = 3;
    ctx.stroke();

    // é»
    sunData.forEach((p, i) => {
        const { x, y } = mapCoordinates(p.az, p.alt);
        const isActive = (i === activePointIndex);

        if (p.day === 1 || isActive) {
            ctx.beginPath();
            ctx.arc(x, y, isActive ? 8 : 4, 0, Math.PI * 2);
            ctx.fillStyle = isActive ? '#fff' : '#d97706';
            ctx.fill();
            
            if (isActive) {
                ctx.beginPath();
                ctx.arc(x, y, 15, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
                ctx.fill();
            }

            if (p.day === 1 && !isActive) {
                ctx.fillStyle = '#fff';
                ctx.strokeStyle = 'rgba(0,0,0,0.5)';
                ctx.lineWidth = 2;
                ctx.strokeText(dict.months[p.month - 1], x + 10, y + 3);
                ctx.fillText(dict.months[p.month - 1], x + 10, y + 3);
            }
        }
    });

    // å¤ªé™½
    if (activePointIndex !== -1) {
        const p = sunData[activePointIndex];
        const { x, y } = mapCoordinates(p.az, p.alt);
        
        const sunGradient = ctx.createRadialGradient(x, y, 4, x, y, 25);
        sunGradient.addColorStop(0, '#fff');
        sunGradient.addColorStop(0.2, '#fde047');
        sunGradient.addColorStop(1, 'rgba(251, 146, 60, 0)');
        
        ctx.fillStyle = sunGradient;
        ctx.beginPath();
        ctx.arc(x, y, 25, 0, Math.PI * 2);
        ctx.fill();
    }
}

/**
 * UI åˆå§‹åŒ–èˆ‡äº‹ä»¶ç¶å®š
 */
const citySelect = document.getElementById('city-select');
const timeSlider = document.getElementById('time-slider');
const timeDisplay = document.getElementById('time-display');
const monthSelect = document.getElementById('month-select');
const daySelect = document.getElementById('day-select');
const langBtn = document.getElementById('lang-btn');

// Modal Elements
const helpBtn = document.getElementById('help-btn');
const closeHelpBtn = document.getElementById('close-help-btn');
const closeHelpBtnBottom = document.getElementById('close-help-btn-bottom');
const helpModal = document.getElementById('help-modal');
const helpContentContainer = document.getElementById('help-content-container');
const helpBody = document.getElementById('help-body');

function initUI() {
    // èªè¨€åˆ‡æ›
    langBtn.addEventListener('click', toggleLanguage);
    
    // åˆå§‹å¡«å……
    populateCities();
    populateMonths();
    populateDays(1);
    updateTexts();

    citySelect.addEventListener('change', () => {
        const city = CITIES[citySelect.value];
        CONFIG.lat = city.lat;
        CONFIG.lon = city.lon;
        CONFIG.utcOffset = city.utcOffset;

        let latDisplay = Math.abs(city.lat) + "Â°";
        if (city.lat > 0) latDisplay += " N";
        else if (city.lat < 0) latDisplay += " S";

        document.getElementById('city-lat').innerText = `Lat: ${latDisplay}`;
        const offsetSign = city.utcOffset >= 0 ? '+' : '';
        document.getElementById('city-offset').innerText = `${offsetSign}${city.utcOffset}`;
        
        refreshAll();
    });

    timeSlider.addEventListener('input', () => {
        const val = parseFloat(timeSlider.value);
        const h = Math.floor(val);
        const m = Math.round((val - h) * 60);
        
        CONFIG.hour = h;
        CONFIG.minute = m;
        
        const mStr = m < 10 ? '0' + m : m;
        timeDisplay.innerText = `${h}:${mStr}`;
        
        refreshAll();
    });

    monthSelect.addEventListener('change', () => {
        populateDays(parseInt(monthSelect.value));
        selectDateFromMenu();
    });

    daySelect.addEventListener('change', selectDateFromMenu);

    // Modal Events
    function toggleModal(show) {
        if (show) {
            generateHelpContent(); // ç”Ÿæˆå°æ‡‰èªè¨€å…§å®¹
            helpModal.classList.remove('opacity-0', 'pointer-events-none');
            helpContentContainer.classList.remove('scale-95');
            helpContentContainer.classList.add('scale-100');
        } else {
            helpModal.classList.add('opacity-0', 'pointer-events-none');
            helpContentContainer.classList.remove('scale-100');
            helpContentContainer.classList.add('scale-95');
        }
    }

    helpBtn.addEventListener('click', () => toggleModal(true));
    closeHelpBtn.addEventListener('click', () => toggleModal(false));
    closeHelpBtnBottom.addEventListener('click', () => toggleModal(false));
    helpModal.addEventListener('click', (e) => {
        if (e.target === helpModal) toggleModal(false);
    });

    // è§¸ç™¼åˆå§‹è¨ˆç®—
    citySelect.dispatchEvent(new Event('change'));
}

function toggleLanguage() {
    currentLang = currentLang === 'zh' ? 'en' : 'zh';
    
    // æ›´æ–°æ‰€æœ‰æ–‡å­—
    updateTexts();
    
    // é‡æ–°å¡«å……ä¸‹æ‹‰é¸å–® (ä¿æŒç•¶å‰é¸æ“‡)
    const currentCityIdx = citySelect.value;
    const currentMonthIdx = monthSelect.value;
    const currentDayIdx = daySelect.value;
    
    populateCities();
    populateMonths();
    populateDays(parseInt(currentMonthIdx));
    
    citySelect.value = currentCityIdx;
    monthSelect.value = currentMonthIdx;
    daySelect.value = currentDayIdx;

    // æ›´æ–°æ•¸æ“šé¢æ¿å’Œé‡ç¹ª Canvas
    refreshAll();
}

function updateTexts() {
    const dict = I18N[currentLang];
    
    // æ›´æ–° data-i18n å…ƒç´ 
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (dict[key]) {
            if (el.tagName === 'INPUT' && el.type === 'placeholder') {
                el.placeholder = dict[key];
            } else {
                el.innerHTML = dict[key]; // ä½¿ç”¨ innerHTML æ”¯æ´ HTML æ¨™ç±¤
            }
        }
    });

    // èªè¨€æŒ‰éˆ•æ–‡å­—
    langBtn.innerText = 'ä¸­ / Eng';
}

function populateCities() {
    citySelect.innerHTML = '';
    CITIES.forEach((city, index) => {
        const opt = document.createElement('option');
        opt.value = index;
        opt.text = currentLang === 'zh' ? city.nameZh : city.nameEn;
        citySelect.appendChild(opt);
    });
}

function populateMonths() {
    monthSelect.innerHTML = '';
    const dict = I18N[currentLang];
    dict.months.forEach((m, i) => {
        const opt = document.createElement('option');
        opt.value = i + 1;
        opt.text = m;
        monthSelect.appendChild(opt);
    });
}

function populateDays(month) {
    const currentDay = parseInt(daySelect.value) || 1;
    daySelect.innerHTML = '';
    const daysInMonth = new Date(CONFIG.year, month, 0).getDate();
    const suffix = I18N[currentLang].daySuffix;
    
    for (let d = 1; d <= daysInMonth; d++) {
        const opt = document.createElement('option');
        opt.value = d;
        opt.text = `${d}${suffix}`;
        daySelect.appendChild(opt);
    }
    daySelect.value = Math.min(currentDay, daysInMonth);
}

function generateHelpContent() {
    if (currentLang === 'zh') {
        helpBody.innerHTML = `
            <section>
                <h3 class="text-sky-400 font-bold text-base md:text-lg mb-2 flex items-center gap-2">
                    <span class="bg-sky-500/20 text-sky-400 w-6 h-6 rounded flex items-center justify-center text-xs">1</span>
                    ä½•è¬‚æ—¥è¡Œè·¡ï¼Ÿ
                </h3>
                <p class="pl-8">å¦‚æœä½ åœ¨ä¸€å¹´ä¸­æ¯ä¸€å¤©çš„<strong class="text-slate-100">åŒä¸€æ™‚åˆ»</strong>ï¼ˆä¾‹å¦‚ä¸‹åˆ 4:00ï¼‰ï¼Œåœ¨åŒä¸€åœ°é»æ‹æ”å¤ªé™½çš„ä½ç½®ï¼Œä¸¦å°‡æ‰€æœ‰ç…§ç‰‡ç–ŠåŠ ï¼Œä½ æœƒç™¼ç¾å¤ªé™½ä¸¦ä¸åœ¨åŒä¸€é»ï¼Œè€Œæ˜¯ç•«å‡ºäº†ä¸€å€‹ã€Œ8ã€å­—å½¢çš„è»Œè·¡ï¼Œé€™å°±æ˜¯æ—¥è¡Œè·¡ã€‚</p>
            </section>
            <section>
                <h3 class="text-sky-400 font-bold text-base md:text-lg mb-2 flex items-center gap-2">
                    <span class="bg-sky-500/20 text-sky-400 w-6 h-6 rounded flex items-center justify-center text-xs">2</span>
                    ç‚ºç”šéº¼å½¢ç‹€åƒ 8 å­—å½¢ï¼Ÿ
                </h3>
                <div class="pl-8 space-y-2">
                    <p>é€™ç”±å…©å€‹ä¸»è¦å¤©æ–‡å› ç´ å…±åŒé€ æˆï¼š</p>
                    <ul class="list-disc list-outside ml-4 space-y-2 text-slate-400 marker:text-amber-500">
                        <li><strong class="text-slate-200">åœ°çƒè‡ªè½‰è»¸å‚¾æ–œ (23.5Â°)ï¼š</strong><br>é€™å°è‡´å¤ªé™½åœ¨å¤©çƒä¸Šçš„èµ¤ç·¯éš¨å­£ç¯€å—åŒ—ç§»å‹•ï¼Œå½¢æˆäº† 8 å­—å½¢çš„<strong class="text-amber-500">ä¸Šä¸‹å¹…åº¦</strong>ï¼ˆé«˜åº¦è®ŠåŒ–ï¼‰ã€‚</li>
                        <li><strong class="text-slate-200">åœ°çƒè»Œé“æ˜¯æ©¢åœ“å½¢ï¼š</strong><br>åœ°çƒç¹å¤ªé™½å…¬è½‰çš„é€Ÿåº¦ä¸¦éæ†å®šï¼ˆè¿‘æ—¥é»å¿«ã€é æ—¥é»æ…¢ï¼‰ã€‚é€™å°è‡´å¤ªé™½è¦–é‹å‹•å¿«æ…¢ä¸å‡ï¼ˆæ™‚å·®æ–¹ç¨‹ï¼‰ï¼Œå½¢æˆäº† 8 å­—å½¢çš„<strong class="text-amber-500">å·¦å³å¯¬åº¦</strong>ï¼ˆæ™‚é–“å¿«æ…¢ï¼‰ã€‚</li>
                    </ul>
                </div>
            </section>
            <section>
                <h3 class="text-sky-400 font-bold text-base md:text-lg mb-2 flex items-center gap-2">
                    <span class="bg-sky-500/20 text-sky-400 w-6 h-6 rounded flex items-center justify-center text-xs">3</span>
                    ç‚ºç”šéº¼ 8 å­—ä¸å°ç¨±ï¼Ÿ
                </h3>
                <p class="pl-8">8 å­—å½¢é€šå¸¸ã€Œé ­å°èº«å¤§ã€ï¼Œé€™æ˜¯å› ç‚ºåœ°çƒé€šéè¿‘æ—¥é»ï¼ˆ1æœˆåˆï¼‰å’Œé æ—¥é»ï¼ˆ7æœˆåˆï¼‰çš„æ™‚é–“ï¼Œèˆ‡äºŒè‡³é»ï¼ˆå†¬è‡³ã€å¤è‡³ï¼‰çš„æ™‚é–“ä¸¦ä¸é‡åˆã€‚é€™å…©å€‹é€±æœŸçš„éŒ¯ä½å°è‡´ 8 å­—å½¢ä¸å°ç¨±ã€‚</p>
            </section>
            <section>
                <h3 class="text-sky-400 font-bold text-base md:text-lg mb-2 flex items-center gap-2">
                    <span class="bg-sky-500/20 text-sky-400 w-6 h-6 rounded flex items-center justify-center text-xs">4</span>
                    ç·¯åº¦èˆ‡æ—¥è¡Œè·¡çš„é—œä¿‚
                </h3>
                <div class="pl-8">
                    <p class="mb-2">8 å­—å½¢çš„å½¢ç‹€æœ¬èº«æ˜¯å›ºå®šçš„ï¼Œä½†å®ƒåœ¨å¤©ç©ºä¸­çš„<strong class="text-emerald-400">å‚¾æ–œè§’åº¦</strong>å–æ±ºæ–¼è§€æ¸¬è€…çš„ç·¯åº¦ï¼š</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-3">
                        <div class="bg-slate-800 p-3 rounded border border-slate-700">
                            <strong class="block text-slate-200 mb-1">èµ¤é“ (0Â°)</strong>
                            <span class="text-xs text-slate-400">8 å­—å½¢å‚ç›´è±ç«‹ï¼ˆæ­£åˆæ™‚ï¼‰ï¼Œæˆ–å¹³èººæ©«è‡¥ï¼ˆæ—¥å‡ºæ—¥è½æ™‚ï¼‰ã€‚</span>
                        </div>
                        <div class="bg-slate-800 p-3 rounded border border-slate-700">
                            <strong class="block text-slate-200 mb-1">ä¸­ç·¯åº¦</strong>
                            <span class="text-xs text-slate-400">8 å­—å½¢æœƒå‘å—æˆ–å‘åŒ—å‚¾æ–œï¼Œé€™æ˜¯æˆ‘å€‘æœ€å¸¸è¦‹çš„å½¢æ…‹ã€‚</span>
                        </div>
                        <div class="bg-slate-800 p-3 rounded border border-slate-700">
                            <strong class="block text-slate-200 mb-1">æ¥µåœ° (90Â°)</strong>
                            <span class="text-xs text-slate-400">8 å­—å½¢åªæœ‰ä¸€åŠéœ²å‡ºåœ°å¹³ç·šï¼Œæˆ–è€…å¹¾ä¹å‚ç›´æ–¼åœ°å¹³ç·šã€‚</span>
                        </div>
                    </div>
                </div>
            </section>
        `;
    } else {
        helpBody.innerHTML = `
            <section>
                <h3 class="text-sky-400 font-bold text-base md:text-lg mb-2 flex items-center gap-2">
                    <span class="bg-sky-500/20 text-sky-400 w-6 h-6 rounded flex items-center justify-center text-xs">1</span>
                    What is an Analemma?
                </h3>
                <p class="pl-8">If you take a picture of the Sun at the <strong class="text-slate-100">same time each day</strong> (e.g., 4:00 PM) from the same location throughout the year and overlay them, the Sun will trace out a figure-8 shape called an Analemma.</p>
            </section>
            <section>
                <h3 class="text-sky-400 font-bold text-base md:text-lg mb-2 flex items-center gap-2">
                    <span class="bg-sky-500/20 text-sky-400 w-6 h-6 rounded flex items-center justify-center text-xs">2</span>
                    Why is it Figure-8 shaped?
                </h3>
                <div class="pl-8 space-y-2">
                    <p>This is caused by two astronomical factors:</p>
                    <ul class="list-disc list-outside ml-4 space-y-2 text-slate-400 marker:text-amber-500">
                        <li><strong class="text-slate-200">Earth's Axial Tilt (23.5Â°):</strong><br>This causes the Sun's declination to move north and south, creating the <strong class="text-amber-500">vertical</strong> height.</li>
                        <li><strong class="text-slate-200">Eccentricity of Earth's Orbit:</strong><br>Earth orbits faster near perihelion and slower near aphelion. This variation (Equation of Time) creates the <strong class="text-amber-500">horizontal</strong> width.</li>
                    </ul>
                </div>
            </section>
            <section>
                <h3 class="text-sky-400 font-bold text-base md:text-lg mb-2 flex items-center gap-2">
                    <span class="bg-sky-500/20 text-sky-400 w-6 h-6 rounded flex items-center justify-center text-xs">3</span>
                    Why is it Asymmetrical?
                </h3>
                <p class="pl-8">The loops are different sizes because the dates when Earth is closest/furthest from the Sun do not align with the Solstices. This misalignment creates the "small head, big body" shape.</p>
            </section>
            <section>
                <h3 class="text-sky-400 font-bold text-base md:text-lg mb-2 flex items-center gap-2">
                    <span class="bg-sky-500/20 text-sky-400 w-6 h-6 rounded flex items-center justify-center text-xs">4</span>
                    Latitude Effects
                </h3>
                <div class="pl-8">
                    <p class="mb-2">The shape is constant, but its <strong class="text-emerald-400">tilt</strong> depends on your latitude:</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-3">
                        <div class="bg-slate-800 p-3 rounded border border-slate-700">
                            <strong class="block text-slate-200 mb-1">Equator (0Â°)</strong>
                            <span class="text-xs text-slate-400">Stands vertically at noon, or lies horizontally at sunrise/sunset.</span>
                        </div>
                        <div class="bg-slate-800 p-3 rounded border border-slate-700">
                            <strong class="block text-slate-200 mb-1">Mid-Latitudes</strong>
                            <span class="text-xs text-slate-400">Tilts south or north. This is the most common view.</span>
                        </div>
                        <div class="bg-slate-800 p-3 rounded border border-slate-700">
                            <strong class="block text-slate-200 mb-1">Poles (90Â°)</strong>
                            <span class="text-xs text-slate-400">Half of it is hidden below the horizon.</span>
                        </div>
                    </div>
                </div>
            </section>
        `;
    }
}

function refreshAll() {
    calculateAndCenter();
    resizeCanvas(); 
    if (activePointIndex !== -1) {
        updateInfoPanel(activePointIndex);
    } else {
        selectToday();
    }
}

function selectDateFromMenu() {
    const m = parseInt(monthSelect.value);
    const d = parseInt(daySelect.value);
    const index = sunData.findIndex(item => item.month === m && item.day === d);
    if (index !== -1) updateInfoPanel(index);
}

function selectToday() {
    const today = new Date();
    const m = today.getMonth() + 1;
    const d = today.getDate();
    let idx = sunData.findIndex(item => item.month === m && item.day === d);
    if (idx === -1) idx = 0;
    updateInfoPanel(idx);
}

function updateInfoPanel(index) {
    if (index < 0 || index >= sunData.length) return;
    
    const data = sunData[index];
    const dict = I18N[currentLang];
    
    document.getElementById('info-date').innerText = `${dict.months[data.month - 1]} ${data.day}${dict.daySuffix}`;
    document.getElementById('info-az').innerText = data.az.toFixed(2) + 'Â°';
    document.getElementById('info-alt').innerText = data.alt.toFixed(2) + 'Â°';

    const statusEl = document.getElementById('info-status');
    if (data.trueAlt > 0) {
        statusEl.innerText = dict.visible;
        statusEl.className = 'block text-center font-bold text-xs px-2 py-1 rounded-full bg-emerald-100 text-emerald-700';
    } else {
        statusEl.innerText = dict.invisible;
        statusEl.className = 'block text-center font-bold text-xs px-2 py-1 rounded-full bg-slate-200 text-slate-500';
    }

    const panel = document.getElementById('info-panel');
    panel.classList.remove('opacity-0', 'translate-y-[-10px]');
    
    activePointIndex = index;
    draw();

    if (parseInt(monthSelect.value) !== data.month) {
        monthSelect.value = data.month;
        populateDays(data.month);
    }
    daySelect.value = data.day;
}

function resizeCanvas() {
    const parent = canvas.parentElement;
    canvas.width = parent.clientWidth;
    canvas.height = parent.clientHeight;
    draw();
}

function handleCanvasInteraction(e) {
    const rect = canvas.getBoundingClientRect();
    const mouseX = e.clientX - rect.left;
    const mouseY = e.clientY - rect.top;

    let minDist = Infinity;
    let closestIndex = -1;

    sunData.forEach((p, i) => {
        const { x, y } = mapCoordinates(p.az, p.alt);
        const dist = Math.hypot(mouseX - x, mouseY - y);
        if (dist < minDist) {
            minDist = dist;
            closestIndex = i;
        }
    });

    if (minDist < 100) {
        updateInfoPanel(closestIndex);
    }
}

window.onload = () => {
    initUI();
    window.addEventListener('resize', resizeCanvas);
    canvas.addEventListener('mousemove', (e) => {
        if(e.buttons === 1) handleCanvasInteraction(e);
    });
    canvas.addEventListener('click', handleCanvasInteraction);
    canvas.addEventListener('touchstart', (e) => { e.preventDefault(); handleCanvasInteraction(e.touches[0]); }, {passive: false});
    canvas.addEventListener('touchmove', (e) => { e.preventDefault(); handleCanvasInteraction(e.touches[0]); }, {passive: false});
};
</script>
</body>
</html>