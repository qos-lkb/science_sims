<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>圓周運動實驗室 (完整數據對照版)</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #ffffff;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: auto; 
        }

        h1 {
            color: #222;
            margin: 15px 0;
            font-size: 1.6rem;
            flex-shrink: 0;
        }

        .main-container {
            display: flex;
            flex: 1;
            width: 100%;
            max-width: 1300px;
            gap: 20px;
            padding: 10px 20px 20px 20px;
            box-sizing: border-box;
            flex-wrap: wrap; 
            min-height: 0;
        }

        /* Canvas Area */
        .canvas-container {
            flex: 2;
            background: white;
            border: 1px solid #ddd;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            min-width: 350px;
            min-height: 400px; 
        }

        canvas {
            width: 100%;
            height: 100%;
            cursor: default;
        }

        /* Controls Area */
        .controls-container {
            flex: 1;
            min-width: 340px; 
            background: #fdfdfd;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border: 1px solid #eee;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-height: calc(100vh - 80px); 
        }

        .section {
            border: 1px solid #e0e0e0;
            padding: 15px;
            border-radius: 8px;
            background: #fff;
        }

        .section-title {
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1rem;
        }

        .obj1-title { color: #007bff; }
        .obj2-title { color: #dc3545; }
        .scenario-title { color: #6f42c1; }

        .control-group { margin-bottom: 12px; }
        label { display: block; font-size: 0.9rem; margin-bottom: 5px; color: #555; }
        input[type="range"] { width: 100%; cursor: pointer; }
        input[type="range"]:disabled { opacity: 0.4; cursor: not-allowed; }
        
        .active-slider input[type="range"] {
            accent-color: #6f42c1;
            box-shadow: 0 0 5px rgba(111, 66, 193, 0.3);
        }

        select {
            width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc;
            font-size: 0.95rem; background-color: #f9f9f9;
        }

        .value-display { float: right; font-weight: bold; color: #333; }
        
        .data-readout {
            background: #f8f9fa; padding: 10px; border-radius: 6px;
            font-size: 0.9rem; margin-top: 5px; line-height: 1.8;
            border-left: 4px solid #aaa;
        }
        .data-readout span { display: flex; justify-content: space-between; }

        .mode-select { display: flex; gap: 10px; margin-bottom: 10px; }
        .radio-group { display: flex; flex-direction: column; gap: 8px; }
        .radio-label { display: flex; align-items: center; gap: 8px; cursor: pointer; }

        /* Legend */
        .legend {
            position: absolute; top: 10px; left: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px; border-radius: 8px; font-size: 0.8rem;
            pointer-events: none; z-index: 10;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border: 1px solid #eee;
        }
        .legend-item { display: flex; align-items: center; gap: 5px; margin-bottom: 3px; }
        .color-box { width: 12px; height: 12px; border-radius: 2px; }

        .exp-badge {
            background: #6f42c1; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; display: none;
        }

        /* Buttons */
        .btn-group { position: absolute; top: 10px; right: 10px; display: flex; gap: 10px; z-index: 20; }
        .ctrl-btn {
            padding: 8px 16px; font-size: 0.9rem; font-weight: bold; color: white;
            border: none; border-radius: 8px; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: background 0.2s;
        }
        .btn-pause { background-color: #28a745; }
        .btn-pause:hover { background-color: #218838; }
        .btn-pause.paused { background-color: #ffc107; color: #333; }
        .btn-help { background-color: #17a2b8; }
        .btn-help:hover { background-color: #138496; }

        .hint-text {
            position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.6); color: white; padding: 5px 15px;
            border-radius: 20px; font-size: 0.9rem; pointer-events: none; display: none; white-space: nowrap;
        }

        /* Modal */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);
            justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: #fefefe; padding: 25px; border-radius: 12px;
            width: 90%; max-width: 600px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative;
        }
        .close-modal { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-modal:hover { color: black; }
        .modal-btn { background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; margin-top: 20px; width: 100%; }

    </style>
</head>
<body>

    <h1>圓周運動實驗室</h1>

    <div class="main-container">
        <div class="canvas-container">
            <canvas id="simCanvas"></canvas>
            
            <div class="btn-group">
                <button id="helpBtn" class="ctrl-btn btn-help">說明</button>
                <button id="toggleBtn" class="ctrl-btn btn-pause">暫停</button>
            </div>
            
            <div id="dragHint" class="hint-text">拖動物體以改變半徑與位置</div>

            <div class="legend">
                <div class="legend-item" id="legend-main"><div class="color-box" style="background:#007bff"></div> <span id="label-main">物體 1 (主控)</span></div>
                <div class="legend-item" id="legend-ref" style="display:none; color:#888;"><div class="color-box" style="background:#999"></div> 原有物件 (對照組)</div>
                <div class="legend-item" id="legend-obj2" style="display:none"><div class="color-box" style="background:#dc3545"></div> 物體 2 (m₂)</div>
                <hr style="width:100%; border:0; border-top:1px solid #ddd; margin:4px 0;">
                <div class="legend-item"><div class="color-box" style="background:#28a745"></div> 線速度 (v)</div>
                <div class="legend-item"><div class="color-box" style="background:#fd7e14"></div> 向心力 (F)</div>
                <div class="legend-item"><div class="color-box" style="background:rgba(100,100,100,0.5); border:1px solid #333;"></div> 角速率 (ω)</div>
            </div>
        </div>

        <div class="controls-container">
            
            <div class="section">
                <div class="section-title">顯示模式</div>
                <div class="mode-select">
                    <label class="radio-label"><input type="radio" name="mode" value="single" checked> 單一物體實驗</label>
                    <label class="radio-label"><input type="radio" name="mode" value="compare"> 雙物體比較</label>
                </div>
            </div>

            <div class="section" id="scenario-section">
                <div class="section-title scenario-title">
                    實驗場景 (變數鎖定)
                    <span id="exp-badge" class="exp-badge">實驗中</span>
                </div>
                <select id="scenarioSelect">
                    <option value="custom">自定義 (自由調整 / 結束實驗)</option>
                    <option value="fix_F_m">1. 固定 F, m (調整 r ↔ v)</option>
                    <option value="fix_r_m">2. 固定 r, m (調整 F ↔ v)</option>
                    <option value="fix_m_w">3. 固定 m, ω (調整 F ↔ r)</option>
                    <option value="fix_m_r">4. 固定 m, r (調整 ω ↔ F)</option>
                </select>
                <div style="font-size:0.85rem; color:#666; margin-top:8px; line-height:1.4;" id="scenario-desc">
                    自由調整參數。選擇上方實驗場景以開始對照實驗。
                </div>
            </div>

            <div class="section" id="compare-section" style="display:none;">
                <div class="section-title">比較條件 (雙物體)</div>
                <div class="radio-group">
                    <label class="radio-label"><input type="radio" name="constraint" value="none" checked> 無 (自由調整)</label>
                    <label class="radio-label"><input type="radio" name="constraint" value="omega"> 同角速率 (ω₁ = ω₂)</label>
                    <label class="radio-label"><input type="radio" name="constraint" value="mass"> 同質量 (m₁ = m₂)</label>
                    <label class="radio-label"><input type="radio" name="constraint" value="radius"> 同半徑 (r₁ = r₂)</label>
                    <label class="radio-label"><input type="radio" name="constraint" value="velocity"> 同線速率 (v₁ = v₂)</label>
                    <label class="radio-label"><input type="radio" name="constraint" value="force"> 同向心力 (F₁ = F₂)</label>
                </div>
            </div>

            <div class="section">
                <div class="section-title obj1-title">
                    <span id="ctrl-panel-title">主控物體參數</span>
                </div>
                
                <div class="control-group active-slider" id="force-control-group" style="display:none; background:#f0f7ff; padding:8px; border-radius:5px; border:1px solid #cce5ff;">
                    <label style="color:#004085; font-weight:bold;">調整 向心力 (F) <span id="val-f-input" class="value-display">-- N</span></label>
                    <input type="range" id="input-f1-force" min="0.5" max="100" step="0.5" value="10">
                </div>

                <div class="control-group" id="grp-m1">
                    <label>質量 (m) <span id="val-m1" class="value-display">1.0 kg</span></label>
                    <input type="range" id="input-m1" min="0.1" max="5.0" step="0.1" value="1.0">
                </div>
                <div class="control-group" id="grp-r1">
                    <label>半徑 (r) <span id="val-r1" class="value-display">120 px</span></label>
                    <input type="range" id="input-r1" min="50" max="300" step="1" value="120">
                </div>
                <div class="control-group" id="grp-w1">
                    <label>角速率 (ω) <span id="val-w1" class="value-display">1.0 rad/s</span></label>
                    <input type="range" id="input-w1" min="0.1" max="3.0" step="0.1" value="1.0">
                </div>
                <div class="data-readout">
                    <span>線速率 (v): <b id="out-v1">0</b> m/s</span>
                    <span>向心力 (F): <b id="out-f1">0</b> N</span>
                </div>
            </div>

            <div class="section" id="obj2-controls" style="display:none">
                <div class="section-title obj2-title">物體 2 參數</div>
                <div class="control-group">
                    <label>質量 (m) <span id="val-m2" class="value-display">1.0 kg</span></label>
                    <input type="range" id="input-m2" min="0.1" max="5.0" step="0.1" value="1.0">
                </div>
                <div class="control-group">
                    <label>半徑 (r) <span id="val-r2" class="value-display">180 px</span></label>
                    <input type="range" id="input-r2" min="50" max="300" step="1" value="180">
                </div>
                <div class="control-group">
                    <label>角速率 (ω) <span id="val-w2" class="value-display">1.0 rad/s</span></label>
                    <input type="range" id="input-w2" min="0.1" max="3.0" step="0.1" value="1.0">
                </div>
                <div class="data-readout">
                    <span>線速率 (v): <b id="out-v2">0</b> m/s</span>
                    <span>向心力 (F): <b id="out-f2">0</b> N</span>
                </div>
            </div>
        </div>
    </div>

    <div id="helpModal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2>模擬器使用說明</h2>
            <p><strong>實驗模式操作指南：</strong></p>
            <ul>
                <li>灰色軌道為對照組（原始數據），藍色為實驗組（當前數據）。</li>
                <li><strong>對照組顯示：</strong> 實驗進行中，灰色軌道也會顯示速度、向心力與角速率的數值，方便您進行前後比較。</li>
                <li><strong>固定 F, m：</strong> 調整半徑(r)會改變速度；調整速度(ω)會改變半徑。</li>
                <li><strong>固定 r, m：</strong> 使用向心力滑桿(F)改變速度；調整速度(ω)改變向心力。</li>
                <li><strong>固定 m, ω：</strong> 使用向心力滑桿(F)改變半徑；調整半徑(r)改變向心力。</li>
                <li><strong>固定 m, r：</strong> 使用向心力滑桿(F)改變速度；調整速度(ω)改變向心力。</li>
            </ul>
            <button id="closeHelpBtn" class="modal-btn">開始實驗</button>
        </div>
    </div>

    <script>
        // Physics State
        const state = {
            paused: false,
            dragging: null, 
            mode: 'single', 
            constraint: 'none', 
            scenario: 'custom', 
            isExperimentActive: false,
            
            lockedF: 0,
            
            obj1: { m: 1.0, r: 120, w: 1.0, theta: 0 },
            objExp: { m: 1.0, r: 120, w: 1.0, theta: 0 },
            obj2: { m: 1.0, r: 180, w: 1.0, theta: 0 }
        };

        // DOM Elements
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');
        const toggleBtn = document.getElementById('toggleBtn');
        const dragHint = document.getElementById('dragHint');
        
        const scenarioSelect = document.getElementById('scenarioSelect');
        const scenarioDesc = document.getElementById('scenario-desc');
        const forceControlGroup = document.getElementById('force-control-group');
        const inputForce = document.getElementById('input-f1-force');
        const grpM1 = document.getElementById('grp-m1');
        const grpR1 = document.getElementById('grp-r1');
        const grpW1 = document.getElementById('grp-w1');
        const legendRef = document.getElementById('legend-ref');
        const labelMain = document.getElementById('label-main');
        const expBadge = document.getElementById('exp-badge');

        let cx, cy;
        function resizeCanvas() {
            canvas.width = canvas.parentElement.offsetWidth;
            canvas.height = canvas.parentElement.offsetHeight;
            cx = canvas.width / 2;
            cy = canvas.height / 2;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
        setTimeout(resizeCanvas, 100);

        function calcPhysics(obj) {
            const r_meters = obj.r / 60; 
            const v = r_meters * obj.w;
            const f = obj.m * r_meters * Math.pow(obj.w, 2);
            return { v, f };
        }

        function getActiveObject() {
            return state.isExperimentActive ? state.objExp : state.obj1;
        }

        function updateSliderUIValues(obj) {
            document.getElementById('input-m1').value = obj.m;
            document.getElementById('val-m1').innerText = obj.m.toFixed(1) + " kg";
            document.getElementById('input-r1').value = obj.r;
            document.getElementById('val-r1').innerText = Math.round(obj.r) + " px";
            document.getElementById('input-w1').value = obj.w;
            document.getElementById('val-w1').innerText = obj.w.toFixed(1) + " rad/s";
            
            const phys = calcPhysics(obj);
            inputForce.value = phys.f;
            document.getElementById('val-f-input').innerText = phys.f.toFixed(1) + " N";
        }

        function updateScenarioUI() {
            grpM1.classList.remove('active-slider');
            grpR1.classList.remove('active-slider');
            grpW1.classList.remove('active-slider');
            forceControlGroup.style.display = 'none';

            document.getElementById('input-m1').disabled = false;
            document.getElementById('input-r1').disabled = false;
            document.getElementById('input-w1').disabled = false;

            if (state.scenario === 'custom') {
                if (state.isExperimentActive) {
                    state.isExperimentActive = false;
                    updateSliderUIValues(state.obj1);
                    legendRef.style.display = 'none';
                    labelMain.innerText = "物體 1 (主控)";
                    expBadge.style.display = 'none';
                }
                scenarioDesc.innerText = "自由調整參數。";
                return;
            }

            if (!state.isExperimentActive) {
                state.objExp = { ...state.obj1 };
                state.isExperimentActive = true;
                legendRef.style.display = 'flex';
                labelMain.innerText = "新物件 (實驗組)";
                expBadge.style.display = 'inline-block';
            }

            const activeObj = state.objExp;
            const phys = calcPhysics(activeObj);
            state.lockedF = phys.f; 
            
            switch(state.scenario) {
                case 'fix_F_m': 
                    scenarioDesc.innerText = "固定 F, m。調整 半徑(r) 改變 角速率(ω)；調整 角速率(ω) 改變 半徑(r)。";
                    document.getElementById('input-m1').disabled = true;
                    grpR1.classList.add('active-slider');
                    grpW1.classList.add('active-slider');
                    break;

                case 'fix_r_m':
                    scenarioDesc.innerText = "固定 r, m。使用「向心力滑桿」改變 角速率(ω)；調整 角速率(ω) 改變向心力。";
                    document.getElementById('input-m1').disabled = true;
                    document.getElementById('input-r1').disabled = true;
                    forceControlGroup.style.display = 'block';
                    grpW1.classList.add('active-slider');
                    break;

                case 'fix_m_w':
                    scenarioDesc.innerText = "固定 m, ω。使用「向心力滑桿」改變 半徑(r)；調整 半徑(r) 改變向心力。";
                    document.getElementById('input-m1').disabled = true;
                    document.getElementById('input-w1').disabled = true;
                    forceControlGroup.style.display = 'block';
                    grpR1.classList.add('active-slider');
                    break;
                
                case 'fix_m_r':
                    scenarioDesc.innerText = "固定 m, r。使用「向心力滑桿」改變 角速率(ω)；調整 角速率(ω) 改變向心力。";
                    document.getElementById('input-m1').disabled = true;
                    document.getElementById('input-r1').disabled = true;
                    forceControlGroup.style.display = 'block';
                    grpW1.classList.add('active-slider');
                    break;
            }
            inputForce.value = phys.f;
            document.getElementById('val-f-input').innerText = phys.f.toFixed(1) + " N";
        }

        scenarioSelect.addEventListener('change', (e) => {
            state.scenario = e.target.value;
            updateScenarioUI();
        });

        // --- Logic: Force Slider ---
        inputForce.addEventListener('input', (e) => {
            if (!state.isExperimentActive) return;
            const newF = parseFloat(e.target.value);
            document.getElementById('val-f-input').innerText = newF.toFixed(1) + " N";
            const obj = state.objExp;
            
            if (state.scenario === 'fix_r_m' || state.scenario === 'fix_m_r') {
                const r_m = obj.r / 60;
                const val = newF / (obj.m * r_m);
                if (val >= 0) {
                    obj.w = Math.min(Math.sqrt(val), 5.0);
                    updateInputSlider('w1', obj.w);
                }
            } 
            else if (state.scenario === 'fix_m_w') {
                if (obj.w > 0) {
                    const r_m = newF / (obj.m * Math.pow(obj.w, 2));
                    let r_px = r_m * 60;
                    r_px = Math.max(50, Math.min(300, r_px));
                    obj.r = r_px;
                    updateInputSlider('r1', obj.r);
                }
            }
        });

        // --- Logic: Radius Slider ---
        document.getElementById('input-r1').addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            const obj = getActiveObject();
            obj.r = val;
            document.getElementById('val-r1').innerText = Math.round(val) + " px";

            if (state.isExperimentActive) {
                if (state.scenario === 'fix_F_m') {
                    const r_m = val / 60;
                    const res = state.lockedF / (obj.m * r_m);
                    if (res >= 0) {
                        obj.w = Math.sqrt(res);
                        updateInputSlider('w1', obj.w);
                    }
                }
                else if (state.scenario === 'fix_m_w') {
                    const p = calcPhysics(obj);
                    inputForce.value = p.f;
                    document.getElementById('val-f-input').innerText = p.f.toFixed(1) + " N";
                }
            }
            if(state.mode === 'compare') applyCompareConstraints('obj1');
        });

        // --- Logic: Omega Slider ---
        document.getElementById('input-w1').addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            const obj = getActiveObject();
            obj.w = val;
            document.getElementById('val-w1').innerText = val.toFixed(1) + " rad/s";

            if (state.isExperimentActive) {
                if (state.scenario === 'fix_F_m') {
                    if (val > 0) {
                        const r_m = state.lockedF / (obj.m * Math.pow(val, 2));
                        obj.r = Math.max(50, Math.min(300, r_m * 60));
                        updateInputSlider('r1', obj.r);
                    }
                }
                else if (state.scenario === 'fix_r_m' || state.scenario === 'fix_m_r') {
                    const p = calcPhysics(obj);
                    inputForce.value = p.f;
                    document.getElementById('val-f-input').innerText = p.f.toFixed(1) + " N";
                }
            }
            if(state.mode === 'compare') applyCompareConstraints('obj1');
        });

        document.getElementById('input-m1').addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            const obj = getActiveObject();
            obj.m = val;
            document.getElementById('val-m1').innerText = val.toFixed(1) + " kg";
            if(state.mode === 'compare') applyCompareConstraints('obj1');
        });

        // --- Comparison & Misc ---
        function applyCompareConstraints(source) {
            if (state.mode !== 'compare') return;
            const p1 = state.obj1;
            const p2 = state.obj2;
            if (state.constraint === 'radius') {
                if (source === 'obj1') { p2.r = p1.r; updateInputSlider('r2', p2.r); }
                else if (source === 'obj2') { p1.r = p2.r; updateInputSlider('r1', p1.r); }
            }
            const r1_m = p1.r / 60; 
            const f1 = p1.m * r1_m * Math.pow(p1.w, 2);
            switch(state.constraint) {
                case 'omega': p2.w = p1.w; updateInputSlider('w2', p2.w); break;
                case 'mass': p2.m = p1.m; updateInputSlider('m2', p2.m); break;
                case 'velocity': 
                    if (p2.r > 0) {
                        const v1 = r1_m * p1.w;
                        const r2_m = p2.r / 60;
                        const targetW = v1 / r2_m;
                        p2.w = Math.min(targetW, 3.0);
                        updateInputSlider('w2', p2.w);
                    }
                    break;
                case 'force': 
                    if (p2.m > 0 && p2.r > 0) {
                        const r2_m = p2.r / 60;
                        const val = f1 / (p2.m * r2_m);
                        if (val >= 0) {
                            p2.w = Math.min(Math.sqrt(val), 5.0);
                            updateInputSlider('w2', p2.w);
                        }
                    }
                    break;
            }
        }

        function updateInputSlider(id, val) {
            const input = document.getElementById('input-' + id);
            if (input) {
                input.value = val;
                const display = document.getElementById('val-' + id);
                let unit = '';
                if(id.includes('m')) unit = ' kg';
                if(id.includes('r')) unit = ' px';
                if(id.includes('w')) unit = ' rad/s';
                const displayVal = id.includes('r') ? Math.round(val) : val.toFixed(2);
                display.innerText = displayVal + unit;
            }
        }

        toggleBtn.addEventListener('click', () => {
            state.paused = !state.paused;
            if (state.paused) { toggleBtn.innerText = "繼續"; toggleBtn.classList.add('paused'); dragHint.style.display = 'block'; }
            else { toggleBtn.innerText = "暫停"; toggleBtn.classList.remove('paused'); dragHint.style.display = 'none'; state.dragging = null; }
        });

        const helpModal = document.getElementById('helpModal');
        const helpBtn = document.getElementById('helpBtn');
        const closeModal = document.querySelector('.close-modal');
        const closeHelpBtn = document.getElementById('closeHelpBtn');
        function openHelp() { state.paused = true; helpModal.style.display = "flex"; toggleBtn.innerText = "繼續"; toggleBtn.classList.add('paused'); dragHint.style.display = 'none'; }
        function closeHelp() { helpModal.style.display = "none"; state.paused = false; toggleBtn.innerText = "暫停"; toggleBtn.classList.remove('paused'); }
        helpBtn.addEventListener('click', openHelp);
        closeModal.addEventListener('click', closeHelp);
        closeHelpBtn.addEventListener('click', closeHelp);

        function getMousePos(evt) {
            const rect = canvas.getBoundingClientRect();
            return { x: evt.clientX - rect.left, y: evt.clientY - rect.top };
        }
        function getObjectPos(obj) {
            return { x: cx + obj.r * Math.cos(obj.theta), y: cy + obj.r * Math.sin(obj.theta) };
        }
        canvas.addEventListener('mousedown', (e) => {
            if (!state.paused) return;
            const m = getMousePos(e);
            const active = getActiveObject();
            const pos1 = getObjectPos(active);
            if (Math.hypot(m.x - pos1.x, m.y - pos1.y) < 20) { state.dragging = 'active'; return; }
            if (state.mode === 'compare') {
                const pos2 = getObjectPos(state.obj2);
                if (Math.hypot(m.x - pos2.x, m.y - pos2.y) < 20) { state.dragging = 'obj2'; return; }
            }
        });
        canvas.addEventListener('mousemove', (e) => {
            const m = getMousePos(e);
            let hovering = false;
            if (state.paused) {
                const active = getActiveObject();
                const pos1 = getObjectPos(active);
                if (Math.hypot(m.x - pos1.x, m.y - pos1.y) < 20) hovering = true;
                if (state.mode === 'compare') {
                    const pos2 = getObjectPos(state.obj2);
                    if (Math.hypot(m.x - pos2.x, m.y - pos2.y) < 20) hovering = true;
                }
            }
            canvas.style.cursor = (state.dragging || hovering) ? 'pointer' : 'default';

            if (!state.dragging) return;

            const dx = m.x - cx;
            const dy = m.y - cy;
            let newR = Math.hypot(dx, dy);
            let newTheta = Math.atan2(dy, dx);
            newR = Math.max(50, Math.min(300, newR));

            if (state.dragging === 'active') {
                const targetObj = getActiveObject();
                targetObj.r = newR;
                targetObj.theta = newTheta;
                updateInputSlider('r1', newR);

                if (state.isExperimentActive) {
                     if (state.scenario === 'fix_F_m') {
                        const r_m = newR / 60;
                        const res = state.lockedF / (targetObj.m * r_m);
                        if(res >= 0) { targetObj.w = Math.sqrt(res); updateInputSlider('w1', targetObj.w); }
                     } else if (state.scenario === 'fix_m_w') {
                        const p = calcPhysics(targetObj);
                        inputForce.value = p.f;
                        document.getElementById('val-f-input').innerText = p.f.toFixed(1) + " N";
                     }
                }
                applyCompareConstraints('obj1');
            } else if (state.dragging === 'obj2') {
                state.obj2.r = newR;
                state.obj2.theta = newTheta;
                updateInputSlider('r2', newR);
                applyCompareConstraints('obj2');
            }
        });
        window.addEventListener('mouseup', () => { state.dragging = null; });

        // --- Drawing ---
        function drawArrow(ctx, fromX, fromY, toX, toY, color, width = 3) {
            const headlen = 12; 
            const dx = toX - fromX;
            const dy = toY - fromY;
            const angle = Math.atan2(dy, dx);
            ctx.beginPath(); ctx.moveTo(fromX, fromY); ctx.lineTo(toX, toY);
            ctx.strokeStyle = color; ctx.lineWidth = width; ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(toX, toY);
            ctx.lineTo(toX - headlen * Math.cos(angle - Math.PI / 6), toY - headlen * Math.sin(angle - Math.PI / 6));
            ctx.lineTo(toX - headlen * Math.cos(angle + Math.PI / 6), toY - headlen * Math.sin(angle + Math.PI / 6));
            ctx.fillStyle = color; ctx.fill();
        }

        function drawCurvedArrow(ctx, cx, cy, radius, startAngle, endAngle, color) {
            ctx.beginPath(); ctx.arc(cx, cy, radius, startAngle, endAngle);
            ctx.strokeStyle = color; ctx.lineWidth = 3; ctx.stroke();
            const headLen = 8; const angle = endAngle; 
            const arrowX = cx + radius * Math.cos(angle);
            const arrowY = cy + radius * Math.sin(angle);
            const tangent = angle + Math.PI/2;
            ctx.beginPath();
            ctx.moveTo(arrowX, arrowY);
            ctx.lineTo(arrowX - headLen * Math.cos(tangent - Math.PI / 6), arrowY - headLen * Math.sin(tangent - Math.PI / 6));
            ctx.lineTo(arrowX - headLen * Math.cos(tangent + Math.PI / 6), arrowY - headLen * Math.sin(tangent + Math.PI / 6));
            ctx.fillStyle = color; ctx.fill();
        }

        function hexToRgba(hex, alpha) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        function drawObject(ctx, centerX, centerY, obj, color, isGhost = false) {
            const r = obj.r;
            const x = centerX + r * Math.cos(obj.theta);
            const y = centerY + r * Math.sin(obj.theta);
            const phys = calcPhysics(obj);
            
            ctx.beginPath(); 
            ctx.arc(centerX, centerY, r, 0, 2 * Math.PI);
            ctx.strokeStyle = 'rgb(8,8,8)'; 
            ctx.lineWidth = 3; 
            ctx.setLineDash([8, 8]); 
            ctx.stroke(); 
            ctx.setLineDash([]);
            ctx.lineWidth = 1; 

            ctx.beginPath(); ctx.moveTo(centerX, centerY); ctx.lineTo(x, y);
            ctx.strokeStyle = isGhost ? '#ccc' : '#aaa'; 
            ctx.stroke();

            const vScale = 15; const vLen = phys.v * vScale; 
            const vx = x + vLen * Math.cos(obj.theta + Math.PI/2);
            const vy = y + vLen * Math.sin(obj.theta + Math.PI/2);
            drawArrow(ctx, x, y, vx, vy, '#28a745', isGhost ? 1 : 3);
            
            // Text for V (Show even if ghost)
            ctx.fillStyle = isGhost ? '#888' : '#333'; 
            ctx.font = '12px Arial'; 
            ctx.fillText(phys.v.toFixed(1) + " m/s", x + 10, y - 10);

            const fScale = 30; const fLen = phys.f * fScale;
            const visualFLen = Math.min(fLen, 280); 
            const fx = x + visualFLen * Math.cos(obj.theta + Math.PI);
            const fy = y + visualFLen * Math.sin(obj.theta + Math.PI);
            drawArrow(ctx, x, y, fx, fy, '#fd7e14', isGhost ? 2 : 4);
            
            // Text for F (Show even if ghost)
            const fTextColor = isGhost ? '#888' : '#d35400';
            ctx.fillStyle = fTextColor; 
            ctx.font = 'bold 12px Arial'; ctx.textAlign = 'center';
            const fTextOffset = 25; 
            const fTextX = fx + fTextOffset * Math.cos(obj.theta + Math.PI);
            const fTextY = fy + fTextOffset * Math.sin(obj.theta + Math.PI);
            if(!isGhost) ctx.fillStyle = 'rgba(255,255,255,0.8)'; else ctx.fillStyle = 'rgba(255,255,255,0.6)';
            ctx.fillRect(fTextX - 25, fTextY - 10, 50, 14);
            ctx.fillStyle = fTextColor; 
            ctx.fillText(phys.f.toFixed(1) + " N", fTextX, fTextY); ctx.textAlign = 'left'; 

            ctx.beginPath(); ctx.arc(x, y, 8 + obj.m * 3, 0, 2 * Math.PI);
            ctx.fillStyle = color; ctx.fill(); 
            ctx.strokeStyle = 'white'; ctx.lineWidth = 2; ctx.stroke();

            // Omega Wedge (Show even if ghost, but gray)
            const wedgeColor = isGhost ? '#999' : color;
            const centerArcRadius = 50; 
            ctx.beginPath(); ctx.moveTo(centerX, centerY);
            ctx.arc(centerX, centerY, centerArcRadius, obj.theta, obj.theta + obj.w, false); ctx.closePath();
            ctx.fillStyle = hexToRgba(wedgeColor, 0.2); ctx.fill(); ctx.strokeStyle = wedgeColor; ctx.lineWidth = 1; ctx.stroke();
            drawCurvedArrow(ctx, centerX, centerY, centerArcRadius, obj.theta, obj.theta + obj.w, wedgeColor);
            
            const midAngle = obj.theta + obj.w / 2;
            const textDist = centerArcRadius * 0.6; 
            const wTextX = centerX + textDist * Math.cos(midAngle);
            const wTextY = centerY + textDist * Math.sin(midAngle);
            ctx.fillStyle = 'rgba(255,255,255,0.7)'; ctx.fillRect(wTextX - 15, wTextY - 8, 30, 16);
            ctx.fillStyle = wedgeColor; ctx.font = 'bold 11px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText("ω=" + obj.w.toFixed(1), wTextX, wTextY); ctx.textAlign = 'left'; ctx.textBaseline = 'alphabetic';
        }

        function updateDisplayValues() {
            const active = getActiveObject();
            const p1 = calcPhysics(active);
            document.getElementById('out-v1').innerText = p1.v.toFixed(2);
            document.getElementById('out-f1').innerText = p1.f.toFixed(2);
            if(state.mode === 'compare') {
                const p2 = calcPhysics(state.obj2);
                document.getElementById('out-v2').innerText = p2.v.toFixed(2);
                document.getElementById('out-f2').innerText = p2.f.toFixed(2);
            }
        }

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (!state.paused) {
                state.obj1.theta += state.obj1.w * 0.05; 
                if (state.isExperimentActive) state.objExp.theta += state.objExp.w * 0.05;
                if (state.mode === 'compare') state.obj2.theta += state.obj2.w * 0.05;
            }

            if (state.isExperimentActive && state.mode === 'single') {
                drawObject(ctx, cx, cy, state.obj1, '#999', true);
                drawObject(ctx, cx, cy, state.objExp, '#007bff');
            } else {
                if(state.mode === 'compare') drawObject(ctx, cx, cy, state.obj2, '#dc3545');
                drawObject(ctx, cx, cy, state.obj1, '#007bff');
            }

            ctx.beginPath(); ctx.arc(cx, cy, 4, 0, Math.PI * 2); ctx.fillStyle = '#333'; ctx.fill();
            updateDisplayValues();
            requestAnimationFrame(animate);
        }

        ['m', 'r', 'w'].forEach(p => {
            document.getElementById('input-' + p + '2').addEventListener('input', (e) => {
                const val = parseFloat(e.target.value);
                state.obj2[p] = val;
                let disp = val.toFixed(1); if(p==='r') disp = Math.round(val);
                let unit = p==='m'?' kg':(p==='r'?' px':' rad/s');
                document.getElementById('val-' + p + '2').innerText = disp + unit;
            });
        });

        document.querySelectorAll('input[name="mode"]').forEach(r => {
            r.addEventListener('change', (e) => {
                state.mode = e.target.value;
                const compareSec = document.getElementById('compare-section');
                const scenarioSec = document.getElementById('scenario-section');
                const obj2Controls = document.getElementById('obj2-controls');
                const legendObj2 = document.getElementById('legend-obj2');
                if (state.mode === 'compare') {
                    compareSec.style.display = 'block'; obj2Controls.style.display = 'block'; legendObj2.style.display = 'flex'; scenarioSec.style.display = 'none';
                    state.scenario = 'custom'; state.isExperimentActive = false; scenarioSelect.value = 'custom'; updateScenarioUI(); applyCompareConstraints('obj1');
                } else {
                    compareSec.style.display = 'none'; obj2Controls.style.display = 'none'; legendObj2.style.display = 'none'; scenarioSec.style.display = 'block';
                }
                resizeCanvas();
            });
        });

        document.querySelectorAll('input[name="constraint"]').forEach(r => {
            r.addEventListener('change', (e) => {
                state.constraint = e.target.value;
                ['input-m2', 'input-r2', 'input-w2'].forEach(id => document.getElementById(id).disabled = false);
                applyCompareConstraints('obj1');
                if(state.constraint === 'mass') document.getElementById('input-m2').disabled = true;
                if(state.constraint === 'radius') document.getElementById('input-r2').disabled = true;
                if(state.constraint === 'omega') document.getElementById('input-w2').disabled = true;
                if(state.constraint === 'velocity') document.getElementById('input-w2').disabled = true;
                if(state.constraint === 'force') document.getElementById('input-w2').disabled = true;
            });
        });

        animate();
    </script>
</body>
</html>